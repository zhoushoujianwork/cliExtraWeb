{% extends "base.html" %}

{% block title %}Q Chat 管理器{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/unified.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/image_paste.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/rich_text.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/conversation.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/wechat_chat.css') }}">
<!-- Highlight.js 样式 -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
<!-- xterm.js 样式 -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css">
<style>
.three-column-layout {
    display: flex;
    height: calc(100vh - 120px);
    gap: 0;
    position: relative;
}

.left-panel {
    width: 280px;
    min-width: 200px;
    max-width: 500px;
    overflow: auto;
    flex-shrink: 0;
}

.center-panel {
    flex: 1;
    min-width: 300px;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.right-panel {
    width: 300px;
    min-width: 200px;
    max-width: 450px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    flex-shrink: 0;
    height: 100%;
}

.resize-handle {
    width: 4px;
    background: #e9ecef;
    cursor: col-resize;
    position: relative;
    flex-shrink: 0;
    transition: background-color 0.2s;
}

.resize-handle:hover {
    background: #007bff;
}

.resize-handle:active {
    background: #0056b3;
}

.resize-handle::before {
    content: '';
    position: absolute;
    top: 0;
    left: -2px;
    right: -2px;
    bottom: 0;
    background: transparent;
}

.chat-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    height: 100%;
}

.chat-container.card {
    height: 100%;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    margin: 0; /* 移除默认margin */
    display: flex;
    flex-direction: column;
}

.chat-container .card-header {
    flex-shrink: 0; /* 防止header被压缩 */
    border-bottom: 1px solid #dee2e6;
}

.chat-input-area {
    flex-shrink: 0; /* 防止输入区域被压缩 */
}

.chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 0;
    /* 移除固定高度，使用flex布局自动计算 */
    min-height: 0; /* 允许flex item缩小 */
}

.chat-input-area {
    border-top: 1px solid #dee2e6;
    padding: 10px 15px 15px 15px;
    background: white;
}

/* 聊天工具栏样式 */
.chat-toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
    padding: 4px 0;
}

.toolbar-left,
.toolbar-right {
    display: flex;
    gap: 4px;
}

/* 工具栏小图标按钮 */
.toolbar-btn {
    width: 28px;
    height: 28px;
    border: 1px solid #e0e0e0;
    background: #f8f9fa;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 12px;
    color: #666;
}

.toolbar-btn:hover {
    background: #e9ecef;
    border-color: #007bff;
    color: #007bff;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,123,255,0.2);
}

.toolbar-btn:active {
    transform: translateY(0);
    box-shadow: 0 1px 2px rgba(0,123,255,0.3);
}

.toolbar-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

/* 输入框包装器 */
.input-wrapper {
    position: relative;
    display: flex;
    align-items: flex-end;
    gap: 8px;
}

/* 发送按钮样式 */
.send-btn {
    width: 36px;
    height: 36px;
    border: none;
    background: #007bff;
    color: white;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 14px;
    flex-shrink: 0;
}

.send-btn:hover {
    background: #0056b3;
    transform: translateY(-1px);
    box-shadow: 0 3px 8px rgba(0,123,255,0.3);
}

.send-btn:active {
    transform: translateY(0);
    box-shadow: 0 1px 3px rgba(0,123,255,0.4);
}

.send-btn:disabled {
    background: #6c757d;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

/* 自适应 textarea 样式 */
.auto-resize-textarea {
    resize: none;
    overflow: hidden;
    min-height: 36px;
    max-height: 120px;
    line-height: 1.4;
    transition: height 0.1s ease;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 8px 12px;
    flex: 1;
}

.auto-resize-textarea:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.25);
    outline: none;
}



.terminal-container {
    flex: 1;
    background: #000;
    border-radius: 5px;
    overflow: hidden;
    height: calc(100vh - 200px); /* 与聊天记录高度一致 */
    min-height: 400px;
}

.terminal-header {
    background: #333;
    color: white;
    padding: 8px 12px;
    font-size: 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.terminal-body {
    height: calc(100% - 35px);
    padding: 0;
}

#terminal {
    height: 100%;
    width: 100%;
}

/* 聊天相关样式 */
.message-bubble {
    max-width: 80%;
    word-wrap: break-word;
}

.user-message .message-bubble {
    margin-left: auto;
}

.instance-message .message-bubble {
    margin-right: auto;
}

.instance-suggestions {
    border: 1px solid #dee2e6;
    background: white;
    border-radius: 4px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.suggestion-item {
    cursor: pointer;
    transition: background-color 0.2s;
}

.suggestion-item:hover {
    background-color: #f8f9fa;
}

.suggestion-item:last-child {
    border-bottom: none !important;
}

.message-time {
    font-size: 0.75rem;
}
</style>
{% endblock %}

{% block content %}
<!-- 顶部控制栏 -->
<div class="mb-3">
    <div class="d-flex justify-content-between align-items-center p-2 bg-light rounded">
        <h4 class="mb-0"><i class="fas fa-comments"></i> Q Chat 管理器</h4>
        <div class="d-flex align-items-center gap-2">
            <!-- Namespace选择器 -->
            <div class="d-flex align-items-center">
                <label class="form-label mb-0 me-2 small">Namespace:</label>
                <select id="currentNamespaceSelect" class="form-select form-select-sm" style="width: 150px;" onchange="switchNamespace()">
                    <!-- namespace选项将通过JavaScript动态加载 -->
                </select>
                <div class="btn-group ms-2">
                    <button class="btn btn-sm btn-outline-success" onclick="showCreateNamespaceModal()" title="新建 Namespace">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="showDeleteNamespaceModal()" title="删除当前 Namespace">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            <div class="vr"></div>
            <button class="btn btn-sm btn-info" onclick="window.open('/workflow', '_blank')" title="Workflow 管理">
                <i class="fas fa-project-diagram"></i> Workflow
            </button>
            <button class="btn btn-sm btn-primary" onclick="manualRefresh()">
                <i class="fas fa-refresh"></i> 刷新
            </button>
        </div>
    </div>
</div>

<!-- 三栏布局 -->
<div class="three-column-layout">
    <!-- 左侧：实例管理 -->
    <div class="left-panel">
        <div class="card h-100 d-flex flex-column">
            <div class="card-header d-flex justify-content-between align-items-center flex-shrink-0">
                <h5 class="mb-0"><i class="fas fa-server"></i> Q CLI 实例</h5>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-success" onclick="createInstance()" title="创建新实例">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button class="btn btn-danger" onclick="cleanAllInstances()" title="清理所有实例">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            <div class="card-body flex-grow-1 overflow-auto p-2">
                <div id="instancesList">
                    <!-- 实例列表将通过JavaScript动态加载 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 左右分割线 -->
    <div class="resize-handle" id="leftResizer"></div>

    <!-- 中间：终端输出 -->
    <div class="center-panel">
        <div class="card h-100">
            <div class="terminal-header">
                <span><i class="fas fa-terminal"></i> 终端输出 (只读)</span>
                <div>
                    <button class="btn btn-sm btn-outline-light" onclick="clearTerminal()" title="清空终端">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            <div class="terminal-body">
                <div id="terminal"></div>
            </div>
        </div>
    </div>

    <!-- 中右分割线 -->
    <div class="resize-handle" id="rightResizer"></div>

    <!-- 右侧：聊天区域 -->
    <div class="right-panel">
        <div class="card chat-container">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-comments"></i> 聊天记录</h5>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary" onclick="refreshChatCache()" title="刷新历史记录缓存">
                        <i class="fas fa-sync-alt"></i> 刷新缓存
                    </button>
                    <button class="btn btn-outline-secondary" onclick="clearChatHistory()" title="清空当前显示的聊天记录">
                        <i class="fas fa-trash"></i> 清空
                    </button>
                </div>
            </div>
            <div class="chat-messages wechat-chat-container" id="chatMessages">
                <!-- 聊天消息将通过JavaScript动态加载 -->
            </div>
            <div class="chat-input-area">
                <!-- 快捷按钮工具栏 -->
                <div class="chat-toolbar">
                    <div class="toolbar-left">
                        <button class="toolbar-btn" onclick="sendMessage()" title="发送消息 (Enter)">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                        <button class="toolbar-btn" onclick="undoLastMessage()" title="撤销上一条消息">
                            <i class="fas fa-undo"></i>
                        </button>
                        <button class="toolbar-btn" onclick="clearMessageInput()" title="清空输入框 (ESC)">
                            <i class="fas fa-eraser"></i>
                        </button>
                        <button class="toolbar-btn" onclick="recallLastMessage()" title="重新编辑上一条消息 (↑)">
                            <i class="fas fa-history"></i>
                        </button>
                    </div>
                    <div class="toolbar-right">
                        <button class="toolbar-btn" onclick="showKeyboardShortcuts()" title="快捷键帮助 (F1)">
                            <i class="fas fa-keyboard"></i>
                        </button>
                    </div>
                </div>
                
                <!-- 输入框区域 -->
                <div class="input-wrapper">
                    <textarea id="messageInput" class="form-control auto-resize-textarea" 
                             placeholder="输入消息... (Enter发送, Shift+Enter换行)" 
                             rows="1"></textarea>
                    <button class="send-btn" onclick="sendMessage()" title="发送 (Enter)">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 新建 Namespace 模态框 -->
<div class="modal fade" id="createNamespaceModal" tabindex="-1" aria-labelledby="createNamespaceModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createNamespaceModalLabel">
                    <i class="fas fa-plus-circle"></i> 新建 Namespace
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="createNamespaceForm">
                    <div class="mb-3">
                        <label for="newNamespaceName" class="form-label">Namespace 名称</label>
                        <input type="text" class="form-control" id="newNamespaceName" placeholder="请输入 namespace 名称" required>
                        <div class="form-text">
                            <i class="fas fa-info-circle"></i> 
                            名称只能包含字母、数字、下划线和连字符，不能为空
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="newNamespaceDescription" class="form-label">描述 (可选)</label>
                        <textarea class="form-control" id="newNamespaceDescription" rows="3" placeholder="请输入 namespace 的用途描述"></textarea>
                    </div>
                    <div class="alert alert-info">
                        <i class="fas fa-lightbulb"></i>
                        <strong>提示：</strong>新建的 namespace 将用于隔离不同项目或环境的 Q CLI 实例。
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-success" onclick="createNamespace()">
                    <i class="fas fa-plus"></i> 创建
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 新建实例模态框 -->
<div class="modal fade" id="createInstanceModal" tabindex="-1" aria-labelledby="createInstanceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createInstanceModalLabel">
                    <i class="fas fa-plus-circle"></i> 新建 Q CLI 实例
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="createInstanceForm">
                    <!-- Namespace 选择 -->
                    <div class="mb-3">
                        <label for="instanceNamespace" class="form-label">Namespace</label>
                        <select class="form-select" id="instanceNamespace" required>
                            <!-- 选项将通过JavaScript动态加载 -->
                        </select>
                        <div class="form-text">
                            <i class="fas fa-info-circle"></i> 
                            选择实例所属的 namespace
                        </div>
                    </div>
                    
                    <!-- 实例名称 -->
                    <div class="mb-3">
                        <label for="instanceName" class="form-label">实例名称</label>
                        <input type="text" class="form-control" id="instanceName" placeholder="请输入实例名称 (可选)" >
                        <div class="form-text">
                            <i class="fas fa-info-circle"></i> 
                            留空将自动生成名称
                        </div>
                    </div>
                    
                    <!-- 角色选择 -->
                    <div class="mb-3">
                        <label for="instanceRole" class="form-label">实例角色</label>
                        <select class="form-select" id="instanceRole" required>
                            <option value="">请选择角色</option>
                            <option value="fullstack">全栈工程师</option>
                            <option value="frontend">前端工程师</option>
                            <option value="backend">后端工程师</option>
                            <option value="devops">运维工程师</option>
                            <option value="test">测试工程师</option>
                            <option value="reviewer">代码审查工程师</option>
                        </select>
                        <div class="form-text">
                            <i class="fas fa-user-tag"></i> 
                            选择实例的专业角色
                        </div>
                    </div>
                    
                    <!-- 工作目录类型 -->
                    <div class="mb-3">
                        <label class="form-label">工作目录</label>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="pathType" id="localPath" value="local" checked>
                                    <label class="form-check-label" for="localPath">
                                        <i class="fas fa-folder"></i> 本地路径
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="pathType" id="gitPath" value="git">
                                    <label class="form-check-label" for="gitPath">
                                        <i class="fab fa-git-alt"></i> Git 地址
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 路径输入 -->
                    <div class="mb-3">
                        <label for="instancePath" class="form-label">路径</label>
                        <input type="text" class="form-control" id="instancePath" placeholder="请输入本地路径或Git地址" required>
                        <div class="form-text" id="pathHelpText">
                            <i class="fas fa-info-circle"></i> 
                            请输入本地目录的绝对路径
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-lightbulb"></i>
                        <strong>提示：</strong>新建的实例将在指定的 namespace 中运行，使用选定的角色配置。
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-success" onclick="createInstanceFromModal()">
                    <i class="fas fa-plus"></i> 创建实例
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 删除 Namespace 确认模态框 -->
<div class="modal fade" id="deleteNamespaceModal" tabindex="-1" aria-labelledby="deleteNamespaceModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteNamespaceModalLabel">
                    <i class="fas fa-exclamation-triangle"></i> 删除 Namespace
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <i class="fas fa-warning"></i>
                    <strong>警告：</strong>此操作不可撤销！
                </div>
                <p>您确定要删除 namespace <strong id="deleteNamespaceName"></strong> 吗？</p>
                <p>删除后将会：</p>
                <ul>
                    <li>停止该 namespace 下的所有实例</li>
                    <li>清理相关的配置和数据文件</li>
                    <li>无法恢复已删除的数据</li>
                </ul>
                <div class="mb-3">
                    <label for="confirmDeleteInput" class="form-label">
                        请输入 <code id="confirmDeleteText"></code> 来确认删除：
                    </label>
                    <input type="text" class="form-control" id="confirmDeleteInput" placeholder="输入 namespace 名称确认">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn" onclick="deleteNamespace()" disabled>
                    <i class="fas fa-trash"></i> 确认删除
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- XTerm.js 依赖 -->
<script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>

<!-- Socket.IO -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>

<!-- 简化的实例操作 -->
<script src="{{ url_for('static', filename='js/simple_instance_ops.js') }}"></script>

<!-- 完整的实例操作功能 -->
<script src="{{ url_for('static', filename='js/instance_operations.js') }}"></script>

<!-- 简化的namespace管理 -->
<script src="{{ url_for('static', filename='js/simple_namespace.js') }}"></script>

<!-- 终端记忆功能 -->
<script src="{{ url_for('static', filename='js/terminal_memory.js') }}"></script>

<!-- 聊天功能 -->
<script src="{{ url_for('static', filename='js/chat_functionality.js') }}"></script>

<!-- 可调整大小的面板 -->
<script src="{{ url_for('static', filename='js/resizable_panels.js') }}"></script>

<!-- 图片粘贴功能 -->
<script src="{{ url_for('static', filename='js/image_paste.js') }}"></script>

<script>
// 全局变量
let term;
let fitAddon;
let socket;
let currentMonitoringInstance = null;

// 初始化Socket.IO
function initSocket() {
    socket = io();
    
    socket.on('terminal_output', function(data) {
        if (term && data.instance_id === currentMonitoringInstance) {
            // 处理输出数据，确保正确显示
            let output = data.data;
            if (typeof output === 'string' && output.length > 0) {
                // 直接写入终端，xterm.js会处理ANSI序列
                term.write(output);
            }
        }
    });
    
    socket.on('terminal_error', function(data) {
        if (term) {
            term.write('\r\n\x1b[31mError: ' + data.error + '\x1b[0m\r\n');
        }
        console.error('Terminal error:', data);
    });
    
    socket.on('terminal_status', function(data) {
        console.log('Terminal status:', data);
        if (data.status === 'started' && data.log_file) {
            term.write('\r\n\x1b[36mMonitoring log file: ' + data.log_file + '\x1b[0m\r\n');
        }
    });
}

// 初始化终端
function initTerminal() {
    window.term = new Terminal({
        theme: {
            background: '#000000',
            foreground: '#ffffff',
            cursor: '#ffffff',
            selection: '#ffffff',
            black: '#000000',
            red: '#cd0000',
            green: '#00cd00',
            yellow: '#cdcd00',
            blue: '#0000ee',
            magenta: '#cd00cd',
            cyan: '#00cdcd',
            white: '#e5e5e5',
            brightBlack: '#7f7f7f',
            brightRed: '#ff0000',
            brightGreen: '#00ff00',
            brightYellow: '#ffff00',
            brightBlue: '#5c5cff',
            brightMagenta: '#ff00ff',
            brightCyan: '#00ffff',
            brightWhite: '#ffffff'
        },
        fontSize: 13,
        fontFamily: 'Monaco, Menlo, "Ubuntu Mono", "Courier New", monospace',
        cursorBlink: false,  // 只读模式，不需要光标闪烁
        cursorStyle: 'block',
        scrollback: 10000,
        tabStopWidth: 4,
        convertEol: true,
        allowTransparency: false,
        bellSound: null,
        bellStyle: 'none',
        disableStdin: true  // 禁用输入，只读模式
    });
    
    window.fitAddon = new FitAddon.FitAddon();
    window.term.loadAddon(window.fitAddon);
    
    window.term.open(document.getElementById('terminal'));
    window.fitAddon.fit();
    
    // 监听窗口大小变化
    window.addEventListener('resize', () => {
        setTimeout(() => window.fitAddon.fit(), 100);
    });
    
    // 检查是否有上次选择的实例
    const lastSelected = window.terminalMemory ? window.terminalMemory.getLastSelectedInstance() : null;
    
    if (lastSelected) {
        // 显示恢复信息
        window.term.writeln('\x1b[32mWelcome to Q Chat Terminal Monitor (Read-Only)\x1b[0m');
        window.term.writeln('\x1b[36mRestoring last selected instance...\x1b[0m\r\n');
    } else {
        // 显示默认欢迎信息
        window.term.writeln('\x1b[32mWelcome to Q Chat Terminal Monitor (Read-Only)\x1b[0m');
        window.term.writeln('Select an instance to start monitoring its output...\r\n');
    }
    
    // 使用全局变量以便其他函数访问
    term = window.term;
    fitAddon = window.fitAddon;
}

// 开始监控实例
function startMonitoring(instanceId) {
    if (currentMonitoringInstance) {
        stopMonitoring();
    }
    
    currentMonitoringInstance = instanceId;
    term.clear();
    term.writeln('\x1b[33mStarting to monitor instance: ' + instanceId + '\x1b[0m');
    term.writeln('\x1b[36mLooking for log file...\x1b[0m\r\n');
    
    // 通过WebSocket开始监控
    socket.emit('start_terminal_monitoring', {instance_id: instanceId});
}

// 停止监控
function stopMonitoring() {
    if (currentMonitoringInstance) {
        socket.emit('stop_terminal_monitoring', {instance_id: currentMonitoringInstance});
        currentMonitoringInstance = null;
        term.writeln('\r\n\x1b[31mMonitoring stopped\x1b[0m');
    }
}

// 清空终端
function clearTerminal() {
    if (term) {
        term.clear();
        if (currentMonitoringInstance) {
            term.writeln(`\x1b[33m监控实例: ${currentMonitoringInstance}\x1b[0m\r\n`);
        }
    }
}

// 加载实例列表 - 更新为使用namespace功能
function loadInstances() {
    // 使用namespace管理器的函数
    if (typeof loadInstancesWithNamespace === 'function') {
        loadInstancesWithNamespace();
    } else {
        // 备用方案
        fetch('/api/instances')
            .then(response => response.json())
            .then(data => {
                updateInstancesList(data.instances || []);
            })
            .catch(error => {
                console.error('加载实例失败:', error);
            });
    }
}

// 停止实例
function stopInstance(instanceId) {
    if (confirm(`确定要停止实例 ${instanceId} 吗？`)) {
        // 显示加载状态
        const button = event.target.closest('button');
        if (button) {
            const originalContent = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            button.disabled = true;
        }
        
        fetch(`/api/stop/${instanceId}`, {method: 'POST'})
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(`实例 ${instanceId} 已停止`, 'success');
                    loadInstances();
                    if (currentMonitoringInstance === instanceId) {
                        stopMonitoring();
                    }
                } else {
                    showNotification(`停止实例失败: ${data.error}`, 'error');
                }
                
                // 恢复按钮状态
                if (button) {
                    button.innerHTML = '<i class="fas fa-stop"></i>';
                    button.disabled = false;
                }
            })
            .catch(error => {
                console.error('停止实例失败:', error);
                showNotification(`停止实例失败: ${error.message}`, 'error');
                
                // 恢复按钮状态
                if (button) {
                    button.innerHTML = '<i class="fas fa-stop"></i>';
                    button.disabled = false;
                }
            });
    }
}

// 手动刷新
function manualRefresh() {
    if (typeof loadInstancesWithNamespace === 'function') {
        loadInstancesWithNamespace();
    }
}

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
    initSocket();
    initTerminal();
    initAutoResizeTextarea();
    initToolbar(); // 初始化工具栏
    
    // 添加路径类型切换监听器
    const localPathRadio = document.getElementById('localPath');
    const gitPathRadio = document.getElementById('gitPath');
    if (localPathRadio && gitPathRadio) {
        localPathRadio.addEventListener('change', updatePathHelpText);
        gitPathRadio.addEventListener('change', updatePathHelpText);
    }
    
    // namespace管理器会自动加载实例
    // 定期刷新实例列表
    setInterval(() => {
        if (typeof loadInstancesWithNamespace === 'function') {
            loadInstancesWithNamespace();
        }
    }, 5000);
});

// 初始化自适应 textarea
function initAutoResizeTextarea() {
    const textarea = document.getElementById('messageInput');
    if (!textarea) return;
    
    // 自适应高度函数
    function autoResize() {
        textarea.style.height = 'auto';
        textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
    }
    
    // 监听输入事件
    textarea.addEventListener('input', autoResize);
    
    // 监听键盘事件
    textarea.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            if (e.shiftKey) {
                // Shift+Enter 换行，不做任何处理
                return;
            } else {
                // Enter 发送消息
                e.preventDefault();
                sendMessage();
            }
        } else if (e.key === 'Escape') {
            // ESC 清空输入框
            e.preventDefault();
            clearMessageInput();
        } else if (e.ctrlKey && e.key === 'l') {
            // Ctrl+L 清空聊天记录
            e.preventDefault();
            clearChatMessages();
        } else if (e.ctrlKey && e.key === 'k') {
            // Ctrl+K 快速聚焦到输入框
            e.preventDefault();
            textarea.focus();
        } else if (e.key === 'ArrowUp' && textarea.value === '') {
            // 上箭头键：重新编辑上一条消息（当输入框为空时）
            e.preventDefault();
            recallLastMessage();
        } else if (e.key === 'ArrowDown' && textarea.value !== '') {
            // 下箭头键：下一条历史消息
            e.preventDefault();
            recallNextMessage();
        } else if (e.ctrlKey && e.key >= '1' && e.key <= '9') {
            // Ctrl+数字键：插入快速文本
            e.preventDefault();
            insertQuickText(parseInt(e.key));
        } else if (e.key === 'F1' || (e.ctrlKey && e.key === '/')) {
            // F1 或 Ctrl+/ 显示快捷键帮助
            e.preventDefault();
            showKeyboardShortcuts();
        }
    });
    
    // 初始调整
    autoResize();
}

// 实例管理功能
function createInstance() {
    showCreateInstanceModal();
}

function showCreateInstanceModal() {
    // 加载当前namespace到选择器
    loadNamespacesForInstance();
    
    // 设置默认值
    const currentNs = getCurrentNamespace() || 'default';
    document.getElementById('instanceNamespace').value = currentNs;
    document.getElementById('instanceName').value = '';
    document.getElementById('instanceRole').value = '';
    document.getElementById('instancePath').value = '';
    document.getElementById('localPath').checked = true;
    updatePathHelpText();
    
    // 显示模态框
    const modal = new bootstrap.Modal(document.getElementById('createInstanceModal'));
    modal.show();
}

function loadNamespacesForInstance() {
    fetch('/api/namespaces')
        .then(response => response.json())
        .then(data => {
            const select = document.getElementById('instanceNamespace');
            select.innerHTML = '';
            
            if (data.success && data.namespaces) {
                data.namespaces.forEach(ns => {
                    const option = document.createElement('option');
                    option.value = ns.name;
                    option.textContent = ns.name;
                    select.appendChild(option);
                });
            }
        })
        .catch(error => {
            console.error('加载namespace列表失败:', error);
        });
}

function updatePathHelpText() {
    const isLocal = document.getElementById('localPath').checked;
    const helpText = document.getElementById('pathHelpText');
    const pathInput = document.getElementById('instancePath');
    
    if (isLocal) {
        helpText.innerHTML = '<i class="fas fa-info-circle"></i> 请输入本地目录的绝对路径';
        pathInput.placeholder = '例如: /Users/username/project';
    } else {
        helpText.innerHTML = '<i class="fas fa-info-circle"></i> 请输入Git仓库地址';
        pathInput.placeholder = '例如: https://github.com/user/repo.git';
    }
}

async function createInstanceFromModal() {
    const namespace = document.getElementById('instanceNamespace').value;
    const name = document.getElementById('instanceName').value.trim();
    const role = document.getElementById('instanceRole').value;
    const path = document.getElementById('instancePath').value.trim();
    const isLocal = document.getElementById('localPath').checked;
    
    // 验证必填字段
    if (!namespace) {
        alert('请选择 namespace');
        return;
    }
    
    if (!role) {
        alert('请选择实例角色');
        return;
    }
    
    if (!path) {
        alert('请输入路径');
        return;
    }
    
    try {
        const requestData = {
            namespace: namespace,
            role: role,
            path: path,
            path_type: isLocal ? 'local' : 'git'
        };
        
        if (name) {
            requestData.name = name;
        }
        
        const response = await fetch('/api/start-with-config', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            // 关闭模态框
            const modal = bootstrap.Modal.getInstance(document.getElementById('createInstanceModal'));
            modal.hide();
            
            // 显示成功消息
            showNotification(`实例创建成功: ${result.instance_id}`, 'success');
            
            // 重新加载实例列表
            loadInstancesWithNamespace();
        } else {
            alert('创建实例失败: ' + result.error);
        }
    } catch (error) {
        console.error('创建实例失败:', error);
        alert('创建实例失败: ' + error.message);
    }
}
function showCreateNamespaceModal() {
    // 清空表单
    document.getElementById('newNamespaceName').value = '';
    document.getElementById('newNamespaceDescription').value = '';
    
    // 显示模态框
    const modal = new bootstrap.Modal(document.getElementById('createNamespaceModal'));
    modal.show();
}

function showDeleteNamespaceModal() {
    const currentNs = getCurrentNamespace();
    if (!currentNs) {
        alert('无法删除默认 namespace');
        return;
    }
    
    // 设置要删除的 namespace 名称
    document.getElementById('deleteNamespaceName').textContent = currentNs;
    document.getElementById('confirmDeleteText').textContent = currentNs;
    document.getElementById('confirmDeleteInput').value = '';
    document.getElementById('confirmDeleteBtn').disabled = true;
    
    // 监听确认输入
    const confirmInput = document.getElementById('confirmDeleteInput');
    confirmInput.oninput = function() {
        const confirmBtn = document.getElementById('confirmDeleteBtn');
        confirmBtn.disabled = this.value !== currentNs;
    };
    
    // 显示模态框
    const modal = new bootstrap.Modal(document.getElementById('deleteNamespaceModal'));
    modal.show();
}

async function createNamespace() {
    const nameInput = document.getElementById('newNamespaceName');
    const descInput = document.getElementById('newNamespaceDescription');
    
    const name = nameInput.value.trim();
    const description = descInput.value.trim();
    
    if (!name) {
        alert('请输入 namespace 名称');
        nameInput.focus();
        return;
    }
    
    // 验证名称格式
    if (!/^[a-zA-Z0-9_-]+$/.test(name)) {
        alert('Namespace 名称只能包含字母、数字、下划线和连字符');
        nameInput.focus();
        return;
    }
    
    try {
        const response = await fetch('/api/namespaces', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                name: name,
                description: description
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // 关闭模态框
            const modal = bootstrap.Modal.getInstance(document.getElementById('createNamespaceModal'));
            modal.hide();
            
            // 显示成功消息
            showNotification(`Namespace "${name}" 创建成功`, 'success');
            
            // 重新加载 namespace 列表
            loadNamespaces().then(() => {
                // 切换到新创建的 namespace
                currentNamespace = name;
                window.currentNamespace = name;
                storeNamespace(name);
                
                // 更新选择器
                const select = document.getElementById('currentNamespaceSelect');
                if (select) {
                    select.value = name;
                }
                
                // 重新加载实例列表
                loadInstancesWithNamespace();
            });
        } else {
            alert(`创建失败: ${result.error}`);
        }
    } catch (error) {
        console.error('创建 namespace 失败:', error);
        alert(`创建失败: ${error.message}`);
    }
}

async function deleteNamespace() {
    const nameToDelete = document.getElementById('deleteNamespaceName').textContent;
    
    try {
        const response = await fetch(`/api/namespaces/${nameToDelete}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (result.success) {
            // 关闭模态框
            const modal = bootstrap.Modal.getInstance(document.getElementById('deleteNamespaceModal'));
            modal.hide();
            
            // 显示成功消息
            showNotification(`Namespace "${nameToDelete}" 删除成功`, 'success');
            
            // 切换到默认 namespace
            currentNamespace = '';
            window.currentNamespace = '';
            storeNamespace('');
            
            // 重新加载 namespace 列表和实例列表
            loadNamespaces().then(() => {
                loadInstancesWithNamespace();
            });
        } else {
            alert(`删除失败: ${result.error}`);
        }
    } catch (error) {
        console.error('删除 namespace 失败:', error);
        alert(`删除失败: ${error.message}`);
    }
}

// 快捷键功能函数
let lastSentMessage = ''; // 存储上一条发送的消息

// 清空输入框
function clearMessageInput() {
    const textarea = document.getElementById('messageInput');
    if (textarea) {
        textarea.value = '';
        textarea.style.height = 'auto';
        textarea.style.height = '38px'; // 重置为最小高度
        showNotification('输入框已清空', 'info', 1000);
    }
}

// 清空聊天记录
function clearChatMessages() {
    if (confirm('确定要清空所有聊天记录吗？')) {
        const chatMessages = document.getElementById('chatMessages');
        if (chatMessages) {
            chatMessages.innerHTML = '';
            showNotification('聊天记录已清空', 'info', 1500);
        }
    }
}

// 重新编辑上一条消息
function recallLastMessage() {
    if (lastSentMessage) {
        const textarea = document.getElementById('messageInput');
        if (textarea) {
            textarea.value = lastSentMessage;
            textarea.focus();
            // 触发自适应高度调整
            textarea.dispatchEvent(new Event('input'));
            showNotification('已恢复上一条消息', 'info', 1000);
        }
    }
}

// 显示快捷键帮助
function showKeyboardShortcuts() {
    const shortcuts = [
        { key: 'Enter', desc: '发送消息' },
        { key: 'Shift + Enter', desc: '换行' },
        { key: 'ESC', desc: '清空输入框' },
        { key: 'Ctrl + L', desc: '清空聊天记录' },
        { key: 'Ctrl + K', desc: '聚焦到输入框' },
        { key: '↑ (空输入框时)', desc: '恢复上一条消息' },
        { key: 'F1', desc: '显示此帮助' }
    ];
    
    let helpText = '🎯 聊天快捷键帮助\n\n';
    shortcuts.forEach(shortcut => {
        helpText += `${shortcut.key.padEnd(20)} - ${shortcut.desc}\n`;
    });
    
    alert(helpText);
}

// 增强sendMessage函数，记录最后发送的消息
const originalSendMessage = window.sendMessage;
if (typeof originalSendMessage === 'function') {
    window.sendMessage = function() {
        const textarea = document.getElementById('messageInput');
        if (textarea && textarea.value.trim()) {
            lastSentMessage = textarea.value.trim();
        }
        return originalSendMessage.apply(this, arguments);
    };
}

// 全局键盘事件监听（用于处理F1等全局快捷键）
document.addEventListener('keydown', function(e) {
    // F1 显示帮助
    if (e.key === 'F1') {
        e.preventDefault();
        showKeyboardShortcuts();
    }
    // Ctrl+K 聚焦到输入框（全局）
    else if (e.ctrlKey && e.key === 'k') {
        e.preventDefault();
        const textarea = document.getElementById('messageInput');
        if (textarea) {
            textarea.focus();
            showNotification('已聚焦到输入框', 'info', 800);
        }
    }
});

// 显示通知函数（如果不存在的话）
if (typeof showNotification !== 'function') {
    function showNotification(message, type = 'info', duration = 3000) {
        // 创建通知元素
        const notification = document.createElement('div');
        notification.className = `alert alert-${type} notification-toast`;
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 250px;
            opacity: 0;
            transition: opacity 0.3s ease;
        `;
        notification.textContent = message;
        
        document.body.appendChild(notification);
        
        // 显示动画
        setTimeout(() => {
            notification.style.opacity = '1';
        }, 10);
        
        // 自动隐藏
        setTimeout(() => {
            notification.style.opacity = '0';
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 300);
        }, duration);
    }
}
</script>
{% endblock %}
