{% extends "base.html" %}

{% block title %}Q Chat ç®¡ç†å™¨{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/unified.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/layout_fix.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/image_paste.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/rich_text.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/conversation.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/wechat_chat.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/instance-status.css') }}">
<!-- Highlight.js æ ·å¼ -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
<!-- xterm.js æ ·å¼ -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css">
<style>
.three-column-layout {
    display: flex;
    height: calc(100vh - 180px); /* è°ƒæ•´ä¸ºé€‚é…å¯¼èˆªæ é«˜åº¦ */
    gap: 0;
    position: relative;
}

.left-panel {
    width: 280px;
    min-width: 200px;
    max-width: 500px;
    overflow: auto;
    flex-shrink: 0;
}

.center-panel {
    flex: 1;
    min-width: 300px;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.right-panel {
    width: 300px;
    min-width: 200px;
    max-width: 450px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    flex-shrink: 0;
    height: 100%;
}

.resize-handle {
    width: 4px;
    background: #e9ecef;
    cursor: col-resize;
    position: relative;
    flex-shrink: 0;
    transition: background-color 0.2s;
}

.resize-handle:hover {
    background: #007bff;
}

.resize-handle:active {
    background: #0056b3;
}

.resize-handle::before {
    content: '';
    position: absolute;
    top: 0;
    left: -2px;
    right: -2px;
    bottom: 0;
    background: transparent;
}

.chat-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    height: 100%;
}

.chat-container.card {
    height: 100%;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    margin: 0; /* ç§»é™¤é»˜è®¤margin */
    display: flex;
    flex-direction: column;
}

.chat-container .card-header {
    flex-shrink: 0; /* é˜²æ­¢headerè¢«å‹ç¼© */
    border-bottom: 1px solid #dee2e6;
}

.chat-input-area {
    flex-shrink: 0; /* é˜²æ­¢è¾“å…¥åŒºåŸŸè¢«å‹ç¼© */
}

.chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 0;
    /* æ”¯æŒæ‹–æ‹‰è°ƒæ•´é«˜åº¦ */
    min-height: 200px; /* æœ€å°é«˜åº¦ */
    max-height: 80vh;  /* æœ€å¤§é«˜åº¦ */
    resize: vertical;  /* å…è®¸å‚ç›´è°ƒæ•´å¤§å° */
    position: relative;
}

/* è‡ªå®šä¹‰æ‹–æ‹‰æ‰‹æŸ„ */
.chat-messages::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 8px;
    background: linear-gradient(to bottom, transparent, #e9ecef);
    cursor: ns-resize;
    border-bottom: 2px solid #dee2e6;
    transition: all 0.2s ease;
}

.chat-messages:hover::after {
    background: linear-gradient(to bottom, transparent, #007bff);
    border-bottom-color: #007bff;
}

/* æ‹–æ‹‰æ—¶çš„è§†è§‰åé¦ˆ */
.chat-messages.resizing {
    user-select: none;
    transition: none;
}

.chat-messages.resizing::after {
    background: linear-gradient(to bottom, transparent, #007bff);
    border-bottom-color: #007bff;
    box-shadow: 0 2px 4px rgba(0,123,255,0.3);
}

/* æ‹–æ‹‰æ‰‹æŸ„æ ·å¼ */
.chat-resize-handle {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 12px;
    background: linear-gradient(to bottom, transparent, #f8f9fa);
    cursor: ns-resize;
    display: flex;
    align-items: center;
    justify-content: center;
    border-top: 1px solid #dee2e6;
    transition: all 0.2s ease;
    z-index: 10;
}

.chat-resize-handle:hover {
    background: linear-gradient(to bottom, transparent, #e3f2fd);
    border-top-color: #007bff;
}

.chat-resize-handle i {
    font-size: 10px;
    color: #6c757d;
    opacity: 0.6;
    transition: all 0.2s ease;
}

.chat-resize-handle:hover i {
    color: #007bff;
    opacity: 1;
}

/* æ‹–æ‹‰æ—¶çš„æ‰‹æŸ„æ ·å¼ */
.chat-messages.resizing .chat-resize-handle {
    background: linear-gradient(to bottom, transparent, #e3f2fd);
    border-top-color: #007bff;
    box-shadow: 0 2px 4px rgba(0,123,255,0.2);
}

.chat-messages.resizing .chat-resize-handle i {
    color: #007bff;
    opacity: 1;
}

.chat-input-area {
    border-top: 1px solid #dee2e6;
    padding: 10px 15px 15px 15px;
    background: white;
}

/* èŠå¤©å·¥å…·æ æ ·å¼ */
.chat-toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    padding: 6px 4px;
    background: #f8f9fa;
    border-radius: 8px;
    border: 1px solid #e9ecef;
}

.toolbar-left,
.toolbar-right {
    display: flex;
    gap: 6px;
}

/* å·¥å…·æ å°å›¾æ ‡æŒ‰é’® */
.toolbar-btn {
    width: 32px;
    height: 32px;
    border: 1px solid #dee2e6;
    background: white;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 13px;
    color: #495057;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
}

.toolbar-btn:hover {
    background: #007bff;
    border-color: #007bff;
    color: white;
    transform: translateY(-1px);
    box-shadow: 0 3px 6px rgba(0,123,255,0.25);
}

.toolbar-btn:active {
    transform: translateY(0);
    box-shadow: 0 1px 3px rgba(0,123,255,0.3);
}

.toolbar-btn:disabled {
    opacity: 0.4;
    cursor: not-allowed;
    transform: none;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    background: #f8f9fa;
    color: #6c757d;
}

.toolbar-btn:disabled:hover {
    background: #f8f9fa;
    border-color: #dee2e6;
    color: #6c757d;
    transform: none;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
}

/* è¾“å…¥æ¡†åŒ…è£…å™¨ */
.input-wrapper {
    position: relative;
    display: flex;
    align-items: flex-end;
    gap: 10px;
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 12px;
    padding: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

/* å‘é€æŒ‰é’®æ ·å¼ */
.send-btn {
    width: 40px;
    height: 40px;
    border: none;
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    color: white;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 16px;
    flex-shrink: 0;
    box-shadow: 0 2px 6px rgba(0,123,255,0.3);
}

.send-btn:hover {
    background: linear-gradient(135deg, #0056b3 0%, #004085 100%);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,123,255,0.4);
}

.send-btn:active {
    transform: translateY(0);
    box-shadow: 0 2px 6px rgba(0,123,255,0.5);
}

.send-btn:disabled {
    background: #6c757d;
    cursor: not-allowed;
    transform: none;
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    opacity: 0.6;
}

/* å®ä¾‹åˆ›å»ºè¿›åº¦æ ·å¼ */
.step-item {
    padding: 8px 0;
    border-left: 3px solid #e9ecef;
    padding-left: 15px;
    margin-bottom: 5px;
    transition: all 0.3s ease;
}

.step-item.active {
    border-left-color: #007bff;
    background-color: #f8f9fa;
}

.step-item.completed {
    border-left-color: #28a745;
}

.step-item.error {
    border-left-color: #dc3545;
}

.step-item i.fa-check {
    color: #28a745;
}

.step-item i.fa-times {
    color: #dc3545;
}

.step-item i.fa-spinner {
    color: #007bff;
}

#instanceCreationProgressModal .modal-content {
    border: none;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}

/* æŒ‰é’®åŠ è½½çŠ¶æ€æ ·å¼ */
.btn:disabled {
    opacity: 0.7;
    cursor: not-allowed;
}

.btn.loading {
    position: relative;
    color: transparent !important;
}

.btn.loading::after {
    content: '';
    position: absolute;
    width: 16px;
    height: 16px;
    top: 50%;
    left: 50%;
    margin-left: -8px;
    margin-top: -8px;
    border: 2px solid transparent;
    border-top-color: #ffffff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

#directoryConflictModal .btn {
    text-align: left;
}

#directoryConflictModal .btn i {
    width: 20px;
}
.auto-resize-textarea {
    resize: none;
    overflow: hidden;
    min-height: 40px;
    max-height: 120px;
    line-height: 1.5;
    transition: height 0.1s ease;
    border: none;
    border-radius: 8px;
    padding: 10px 12px;
    flex: 1;
    font-size: 14px;
    background: transparent;
}

.auto-resize-textarea:focus {
    outline: none;
    box-shadow: none;
}

.auto-resize-textarea::placeholder {
    color: #6c757d;
    font-size: 14px;
}



.terminal-container {
    flex: 1;
    background: #000;
    border-radius: 5px;
    overflow: hidden;
    height: calc(100vh - 260px); /* è°ƒæ•´ç»ˆç«¯é«˜åº¦é€‚é…å¯¼èˆªæ  */
    min-height: 400px;
}

.terminal-header {
    background: #333;
    color: white;
    padding: 8px 12px;
    font-size: 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.terminal-header .btn {
    margin-left: 5px;
    font-size: 11px;
    padding: 2px 8px;
    transition: all 0.3s ease;
}

.terminal-header .btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

#toggle-terminal-mode {
    position: relative;
}

#toggle-terminal-mode.btn-outline-warning:hover {
    background-color: #ffc107;
    border-color: #ffc107;
    color: #212529;
}

#toggle-terminal-mode.btn-outline-success:hover {
    background-color: #28a745;
    border-color: #28a745;
    color: white;
}

.terminal-body {
    height: calc(100% - 35px);
    padding: 0;
}

#terminal {
    height: 100%;
    width: 100%;
}

/* èŠå¤©ç›¸å…³æ ·å¼ */
.message-bubble {
    max-width: 80%;
    word-wrap: break-word;
}

.user-message .message-bubble {
    margin-left: auto;
}

.instance-message .message-bubble {
    margin-right: auto;
}

.instance-suggestions {
    border: 1px solid #dee2e6;
    background: white;
    border-radius: 4px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.suggestion-item {
    cursor: pointer;
    transition: background-color 0.2s;
}

.suggestion-item:hover {
    background-color: #f8f9fa;
}

.suggestion-item:last-child {
    border-bottom: none !important;
}

.message-time {
    font-size: 0.75rem;
}

/* å®ä¾‹åˆ—è¡¨é¡¹æ ·å¼ */
.instance-item {
    transition: all 0.2s ease;
    cursor: pointer;
}

.instance-item:hover {
    background-color: #f8f9fa;
    border-color: #dee2e6;
}

/* é€‰ä¸­çŠ¶æ€çš„å®ä¾‹é¡¹ */
.instance-item.instance-selected {
    background-color: #e3f2fd;
    border-color: #2196f3;
    box-shadow: 0 2px 8px rgba(33, 150, 243, 0.15);
}

.instance-item.instance-selected:hover {
    background-color: #e1f5fe;
    border-color: #1976d2;
}
</style>
{% endblock %}

{% block content %}
<!-- é¡¶éƒ¨æ§åˆ¶æ  -->
<div class="mb-3">
    <div class="d-flex justify-content-between align-items-center p-2 bg-light rounded">
        <h4 class="mb-0"><i class="fas fa-comments"></i> Q Chat ç®¡ç†å™¨</h4>
        <div class="d-flex align-items-center gap-2">
            <!-- Namespaceé€‰æ‹©å™¨ -->
            <div class="d-flex align-items-center">
                <label class="form-label mb-0 me-2 small">Namespace:</label>
                <select id="currentNamespaceSelect" class="form-select form-select-sm" style="width: 150px;" onchange="switchNamespace()">
                    <!-- namespaceé€‰é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                </select>
                <div class="btn-group ms-2">
                    <button class="btn btn-sm btn-outline-success" onclick="showCreateNamespaceModal()" title="æ–°å»º Namespace">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="showDeleteNamespaceModal()" title="åˆ é™¤å½“å‰ Namespace">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
                <!-- NamespaceçŠ¶æ€æ˜¾ç¤º -->
                <div id="namespaceStats" class="ms-3">
                    <small class="text-muted">åŠ è½½ä¸­...</small>
                </div>
            </div>
            <div class="vr"></div>
            <button class="btn btn-sm btn-info" onclick="window.open('/workflow', '_blank')" title="Workflow ç®¡ç†">
                <i class="fas fa-project-diagram"></i> Workflow
            </button>
            <button class="btn btn-sm btn-primary" onclick="manualRefresh()" title="åˆ·æ–°æ‰€æœ‰æ•°æ®ï¼šå®ä¾‹åˆ—è¡¨ã€çŠ¶æ€ä¿¡æ¯ã€èŠå¤©è®°å½•ç­‰">
                <i class="fas fa-refresh"></i> åˆ·æ–°
            </button>
        </div>
    </div>
</div>

<!-- ä¸‰æ å¸ƒå±€ -->
<div class="three-column-layout">
    <!-- å·¦ä¾§ï¼šå®ä¾‹ç®¡ç† -->
    <div class="left-panel">
        <div class="card h-100 d-flex flex-column">
            <div class="card-header d-flex justify-content-between align-items-center flex-shrink-0">
                <h5 class="mb-0"><i class="fas fa-server"></i> Q CLI å®ä¾‹</h5>
                <div class="btn-group btn-group-sm">
                    <!-- ç§»é™¤åˆ·æ–°æŒ‰é’®ï¼Œç»Ÿä¸€ä½¿ç”¨å³ä¸Šè§’åˆ·æ–° -->
                    <button class="btn btn-success" onclick="createInstance()" title="åˆ›å»ºæ–°å®ä¾‹">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button class="btn btn-danger" onclick="cleanAllInstances()" title="æ¸…ç†æ‰€æœ‰å®ä¾‹">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            <div class="card-body flex-grow-1 overflow-auto p-2">
                <div id="instancesList">
                    <!-- å®ä¾‹åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                </div>
            </div>
        </div>
    </div>

    <!-- å·¦å³åˆ†å‰²çº¿ -->
    <div class="resize-handle" id="leftResizer"></div>

    <!-- ä¸­é—´ï¼šç»ˆç«¯è¾“å‡º -->
    <div class="center-panel">
        <div class="card h-100">
            <div class="terminal-header">
                <span><i class="fas fa-terminal"></i> <span id="terminal-mode-text">ç»ˆç«¯è¾“å‡º (åªè¯»)</span></span>
                <div>
                    <button id="toggle-terminal-mode" class="btn btn-sm btn-outline-warning" onclick="toggleTerminalMode()" title="åˆ‡æ¢ç»ˆç«¯æ¨¡å¼">
                        <i class="fas fa-keyboard"></i> äº¤äº’æ¨¡å¼
                    </button>
                    <button class="btn btn-sm btn-outline-light" onclick="clearTerminal()" title="æ¸…ç©ºç»ˆç«¯">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            <div class="terminal-body">
                <div id="terminal"></div>
            </div>
        </div>
    </div>

    <!-- ä¸­å³åˆ†å‰²çº¿ -->
    <div class="resize-handle" id="rightResizer"></div>

    <!-- å³ä¾§ï¼šèŠå¤©åŒºåŸŸ -->
    <div class="right-panel">
        <div class="card chat-container">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-comments"></i> èŠå¤©è®°å½•</h5>
                <div class="btn-group btn-group-sm">
                    <!-- ç§»é™¤åˆ·æ–°ç¼“å­˜æŒ‰é’®ï¼Œç»Ÿä¸€ä½¿ç”¨å³ä¸Šè§’åˆ·æ–° -->
                    <button class="btn btn-outline-secondary" onclick="clearChatHistory()" title="æ¸…ç©ºå½“å‰æ˜¾ç¤ºçš„èŠå¤©è®°å½•">
                        <i class="fas fa-trash"></i> æ¸…ç©º
                    </button>
                </div>
            </div>
            <div class="chat-messages wechat-chat-container" id="chatMessages">
                <!-- èŠå¤©æ¶ˆæ¯å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
            </div>
            <div class="chat-input-area">
                <!-- å¿«æ·æŒ‰é’®å·¥å…·æ  -->
                <div class="chat-toolbar">
                    <div class="toolbar-left">
                        <button class="toolbar-btn" onclick="sendMessage()" title="å‘é€æ¶ˆæ¯ (Enter)">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                        <button class="toolbar-btn" onclick="undoLastMessage()" title="æ’¤é”€ä¸Šä¸€æ¡æ¶ˆæ¯">
                            <i class="fas fa-undo"></i>
                        </button>
                        <button class="toolbar-btn" onclick="clearMessageInput()" title="æ¸…ç©ºè¾“å…¥æ¡† (ESC)">
                            <i class="fas fa-eraser"></i>
                        </button>
                        <button class="toolbar-btn" onclick="recallLastMessage()" title="é‡æ–°ç¼–è¾‘ä¸Šä¸€æ¡æ¶ˆæ¯ (â†‘)">
                            <i class="fas fa-history"></i>
                        </button>
                    </div>
                    <div class="toolbar-right">
                        <button class="toolbar-btn" onclick="showKeyboardShortcuts()" title="å¿«æ·é”®å¸®åŠ© (F1)">
                            <i class="fas fa-keyboard"></i>
                        </button>
                    </div>
                </div>
                
                <!-- è¾“å…¥æ¡†åŒºåŸŸ -->
                <div class="input-wrapper">
                    <textarea id="messageInput" class="form-control auto-resize-textarea" 
                             placeholder="è¾“å…¥æ¶ˆæ¯... (Enterå‘é€, Shift+Enteræ¢è¡Œ)" 
                             rows="1"></textarea>
                    <button class="send-btn" onclick="sendMessage()" title="å‘é€ (Enter)">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- æ–°å»º Namespace æ¨¡æ€æ¡† -->
<div class="modal fade" id="createNamespaceModal" tabindex="-1" aria-labelledby="createNamespaceModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createNamespaceModalLabel">
                    <i class="fas fa-plus-circle"></i> æ–°å»º Namespace
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="createNamespaceForm">
                    <div class="mb-3">
                        <label for="newNamespaceName" class="form-label">Namespace åç§°</label>
                        <input type="text" class="form-control" id="newNamespaceName" placeholder="è¯·è¾“å…¥ namespace åç§°" required>
                        <div class="form-text">
                            <i class="fas fa-info-circle"></i> 
                            åç§°åªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿å’Œè¿å­—ç¬¦ï¼Œä¸èƒ½ä¸ºç©º
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="newNamespaceDescription" class="form-label">æè¿° (å¯é€‰)</label>
                        <textarea class="form-control" id="newNamespaceDescription" rows="3" placeholder="è¯·è¾“å…¥ namespace çš„ç”¨é€”æè¿°"></textarea>
                    </div>
                    <div class="alert alert-info">
                        <i class="fas fa-lightbulb"></i>
                        <strong>æç¤ºï¼š</strong>æ–°å»ºçš„ namespace å°†ç”¨äºéš”ç¦»ä¸åŒé¡¹ç›®æˆ–ç¯å¢ƒçš„ Q CLI å®ä¾‹ã€‚
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-success" onclick="createNamespace()">
                    <i class="fas fa-plus"></i> åˆ›å»º
                </button>
            </div>
        </div>
    </div>
</div>

<!-- æ–°å»ºå®ä¾‹æ¨¡æ€æ¡† -->
<div class="modal fade" id="createInstanceModal" tabindex="-1" aria-labelledby="createInstanceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createInstanceModalLabel">
                    <i class="fas fa-plus-circle"></i> æ–°å»º Q CLI å®ä¾‹
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="createInstanceForm">
                    <!-- å½“å‰ Namespace æ˜¾ç¤º -->
                    <div class="mb-3">
                        <label class="form-label">å½“å‰ Namespace</label>
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="fas fa-layer-group"></i>
                            </span>
                            <input type="text" class="form-control" id="currentNamespaceDisplay" readonly>
                        </div>
                        <div class="form-text">
                            <i class="fas fa-info-circle"></i> 
                            å®ä¾‹å°†åœ¨å½“å‰ namespace ä¸­åˆ›å»º
                        </div>
                    </div>
                    
                    <!-- å®ä¾‹åç§° -->
                    <div class="mb-3">
                        <label for="instanceName" class="form-label">å®ä¾‹åç§°</label>
                        <input type="text" class="form-control" id="instanceName" placeholder="è¯·è¾“å…¥å®ä¾‹åç§° (å¯é€‰)" >
                        <div class="form-text">
                            <i class="fas fa-info-circle"></i> 
                            ç•™ç©ºå°†è‡ªåŠ¨ç”Ÿæˆåç§°
                        </div>
                    </div>
                    
                    <!-- è§’è‰²é€‰æ‹© -->
                    <div class="mb-3">
                        <label for="instanceRole" class="form-label">å®ä¾‹è§’è‰²</label>
                        <select class="form-select" id="instanceRole">
                            <option value="">è¯·é€‰æ‹©è§’è‰²</option>
                            <!-- è§’è‰²é€‰é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                        </select>
                        <div class="form-text">
                            <i class="fas fa-user-tag"></i> 
                            é€‰æ‹©å®ä¾‹çš„ä¸“ä¸šè§’è‰²ï¼ˆå¯é€‰ï¼‰
                        </div>
                    </div>
                    
                    <!-- å·¥ä½œç›®å½•ç±»å‹ -->
                    <div class="mb-3">
                        <label class="form-label">å·¥ä½œç›®å½•</label>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="pathType" id="localPath" value="local" checked>
                                    <label class="form-check-label" for="localPath">
                                        <i class="fas fa-folder"></i> æœ¬åœ°è·¯å¾„
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="pathType" id="gitPath" value="git">
                                    <label class="form-check-label" for="gitPath">
                                        <i class="fab fa-git-alt"></i> Git åœ°å€
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- è·¯å¾„è¾“å…¥ -->
                    <div class="mb-3">
                        <label for="instancePath" class="form-label">è·¯å¾„</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="instancePath" placeholder="è¯·è¾“å…¥æœ¬åœ°è·¯å¾„æˆ–Gitåœ°å€" required>
                            <button class="btn btn-outline-secondary" type="button" id="browsePathBtn" onclick="browsePath()" title="æµè§ˆæœ¬åœ°ç›®å½•">
                                <i class="fas fa-folder-open"></i> æµè§ˆ
                            </button>
                            <button class="btn btn-outline-warning" type="button" id="skipBrowseBtn" onclick="skipBrowseAndManualInput()" title="è·³è¿‡æµè§ˆï¼Œæ‰‹åŠ¨è¾“å…¥" style="display: none;">
                                <i class="fas fa-keyboard"></i> æ‰‹åŠ¨è¾“å…¥
                            </button>
                        </div>
                        <div class="form-text" id="pathHelpText">
                            <i class="fas fa-info-circle"></i> 
                            è¯·è¾“å…¥æœ¬åœ°ç›®å½•çš„ç»å¯¹è·¯å¾„
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-lightbulb"></i>
                        <strong>æç¤ºï¼š</strong>æ–°å»ºçš„å®ä¾‹å°†åœ¨æŒ‡å®šçš„ namespace ä¸­è¿è¡Œï¼Œä½¿ç”¨é€‰å®šçš„è§’è‰²é…ç½®ã€‚
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-success" onclick="createInstanceFromModal()">
                    <i class="fas fa-plus"></i> åˆ›å»ºå®ä¾‹
                </button>
            </div>
        </div>
    </div>
</div>

<!-- å®ä¾‹åˆ›å»ºè¿›åº¦æ¨¡æ€æ¡† -->
<div class="modal fade" id="instanceCreationProgressModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-cog fa-spin"></i> åˆ›å»ºå®ä¾‹ä¸­...
                </h5>
            </div>
            <div class="modal-body text-center">
                <div class="mb-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                <div id="creationProgressText" class="mb-3">
                    æ­£åœ¨å‡†å¤‡åˆ›å»ºå®ä¾‹...
                </div>
                <div class="progress mb-3">
                    <div id="creationProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" style="width: 0%"></div>
                </div>
                <div id="creationSteps" class="text-start">
                    <div class="step-item" id="step-validate">
                        <i class="fas fa-clock text-muted"></i> éªŒè¯å‚æ•°...
                    </div>
                    <div class="step-item" id="step-clone" style="display: none;">
                        <i class="fas fa-clock text-muted"></i> å…‹éš†Gitä»“åº“...
                    </div>
                    <div class="step-item" id="step-create">
                        <i class="fas fa-clock text-muted"></i> åˆ›å»ºå®ä¾‹...
                    </div>
                    <div class="step-item" id="step-complete">
                        <i class="fas fa-clock text-muted"></i> å®Œæˆè®¾ç½®...
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="cancelCreationBtn" onclick="cancelInstanceCreation()">
                    å–æ¶ˆåˆ›å»º
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ç›®å½•å†²çªå¤„ç†æ¨¡æ€æ¡† -->
<div class="modal fade" id="directoryConflictModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle"></i> ç›®å½•å†²çª
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="fas fa-folder"></i>
                    <strong>ç›®å½•å·²å­˜åœ¨</strong>
                </div>
                <p id="conflictDirectoryPath"></p>
                <p>è¯¥ç›®å½•å·²ç»å­˜åœ¨ï¼Œè¯·é€‰æ‹©å¤„ç†æ–¹å¼ï¼š</p>
                <div class="d-grid gap-2">
                    <button class="btn btn-danger" onclick="handleDirectoryConflict('delete')">
                        <i class="fas fa-trash"></i> åˆ é™¤ç°æœ‰ç›®å½•å¹¶é‡æ–°åˆ›å»º
                    </button>
                    <button class="btn btn-primary" onclick="handleDirectoryConflict('rename')">
                        <i class="fas fa-edit"></i> ä½¿ç”¨æ–°åç§°ï¼ˆè‡ªåŠ¨æ·»åŠ åç¼€ï¼‰
                    </button>
                    <button class="btn btn-success" onclick="handleDirectoryConflict('use')">
                        <i class="fas fa-folder-open"></i> ä½¿ç”¨ç°æœ‰ç›®å½•
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
            </div>
        </div>
    </div>
</div>

<!-- å®ä¾‹è¯¦æƒ…æ¨¡æ€æ¡† -->
<div class="modal fade" id="instanceDetailsModal" tabindex="-1" aria-labelledby="instanceDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="instanceDetailsModalLabel">
                    <i class="fas fa-info-circle"></i> å®ä¾‹è¯¦æƒ…
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="instanceDetailsContent">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">åŠ è½½ä¸­...</span>
                        </div>
                        <p class="mt-2">æ­£åœ¨åŠ è½½å®ä¾‹è¯¦æƒ…...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                <button type="button" class="btn btn-primary" id="saveInstanceDetailsBtn" onclick="saveInstanceDetails()" style="display: none;">
                    <i class="fas fa-save"></i> ä¿å­˜ä¿®æ”¹
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="deleteNamespaceModal" tabindex="-1" aria-labelledby="deleteNamespaceModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteNamespaceModalLabel">
                    <i class="fas fa-exclamation-triangle"></i> åˆ é™¤ Namespace
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <i class="fas fa-warning"></i>
                    <strong>è­¦å‘Šï¼š</strong>æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼
                </div>
                <p>æ‚¨ç¡®å®šè¦åˆ é™¤ namespace <strong id="deleteNamespaceName"></strong> å—ï¼Ÿ</p>
                <p>åˆ é™¤åå°†ä¼šï¼š</p>
                <ul>
                    <li>åœæ­¢è¯¥ namespace ä¸‹çš„æ‰€æœ‰å®ä¾‹</li>
                    <li>æ¸…ç†ç›¸å…³çš„é…ç½®å’Œæ•°æ®æ–‡ä»¶</li>
                    <li>æ— æ³•æ¢å¤å·²åˆ é™¤çš„æ•°æ®</li>
                </ul>
                <div class="mb-3">
                    <label for="confirmDeleteInput" class="form-label">
                        è¯·è¾“å…¥ <code id="confirmDeleteText"></code> æ¥ç¡®è®¤åˆ é™¤ï¼š
                    </label>
                    <input type="text" class="form-control" id="confirmDeleteInput" placeholder="è¾“å…¥ namespace åç§°ç¡®è®¤">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn" onclick="deleteNamespace()" disabled>
                    <i class="fas fa-trash"></i> ç¡®è®¤åˆ é™¤
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- XTerm.js ä¾èµ– -->
<script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>

<!-- Socket.IO -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>

<!-- ç®€åŒ–çš„å®ä¾‹æ“ä½œ -->
<script src="{{ url_for('static', filename='js/simple_instance_ops.js') }}"></script>

<!-- å®Œæ•´çš„å®ä¾‹æ“ä½œåŠŸèƒ½ -->
<script src="{{ url_for('static', filename='js/instance_operations.js') }}"></script>

<!-- ç®€åŒ–çš„namespaceç®¡ç† -->
<script src="{{ url_for('static', filename='js/simple_namespace.js') }}"></script>

<!-- ç»ˆç«¯è®°å¿†åŠŸèƒ½ -->
<script src="{{ url_for('static', filename='js/terminal_memory.js') }}"></script>

<!-- å®ä¾‹çŠ¶æ€ç®¡ç† -->
<script src="{{ url_for('static', filename='js/instance-status.js') }}"></script>

<!-- JavaScriptè°ƒè¯•å·¥å…· -->
<script src="{{ url_for('static', filename='js/debug-helper.js') }}"></script>

<!-- èŠå¤©åŠŸèƒ½ -->
<script src="{{ url_for('static', filename='js/chat_functionality.js') }}"></script>

<!-- å¯è°ƒæ•´å¤§å°çš„é¢æ¿ -->
<script src="{{ url_for('static', filename='js/resizable_panels.js') }}"></script>

<!-- å›¾ç‰‡ç²˜è´´åŠŸèƒ½ -->
<script src="{{ url_for('static', filename='js/image_paste.js') }}"></script>

<script>
// å…¨å±€å˜é‡
let term;
let fitAddon;
let socket;
let currentMonitoringInstance = null;
let isInteractiveMode = false;  // ç»ˆç«¯æ¨¡å¼æ ‡å¿—

// åˆå§‹åŒ–Socket.IO
function initSocket() {
    socket = io();
    
    socket.on('terminal_output', function(data) {
        if (term && data.instance_id === currentMonitoringInstance) {
            if (isInteractiveMode && data.output) {
                // äº¤äº’æ¨¡å¼ä¸‹çš„è¾“å‡º
                term.write(data.output);
            } else if (!isInteractiveMode && data.data) {
                // åªè¯»æ¨¡å¼ä¸‹çš„æ—¥å¿—è¾“å‡º
                let output = data.data;
                if (typeof output === 'string' && output.length > 0) {
                    // ç›´æ¥å†™å…¥ç»ˆç«¯ï¼Œxterm.jsä¼šå¤„ç†ANSIåºåˆ—
                    term.write(output);
                }
            }
        }
    });
    
    socket.on('terminal_error', function(data) {
        if (term) {
            term.write('\r\n\x1b[31mError: ' + data.error + '\x1b[0m\r\n');
        }
        console.error('Terminal error:', data);
    });
    
    socket.on('terminal_status', function(data) {
        console.log('Terminal status:', data);
        if (data.status === 'started' && data.log_file) {
            term.write('\r\n\x1b[36mMonitoring log file: ' + data.log_file + '\x1b[0m\r\n');
        }
    });
    
    // äº¤äº’ç»ˆç«¯è¿æ¥æˆåŠŸ
    socket.on('terminal_connected', function(data) {
        console.log('Interactive terminal connected:', data);
        if (term && data.instance_id === currentMonitoringInstance) {
            term.clear();
            term.write('\r\n\x1b[32må·²è¿æ¥åˆ°äº¤äº’ç»ˆç«¯: ' + data.session_name + '\x1b[0m\r\n');
            term.write('\x1b[36mç°åœ¨å¯ä»¥ç›´æ¥è¾“å…¥å‘½ä»¤è¿›è¡Œäº¤äº’\x1b[0m\r\n\r\n');
            
            // è¿æ¥æˆåŠŸåå†æ¬¡è°ƒæ•´ç»ˆç«¯å¤§å°
            setTimeout(() => {
                if (isInteractiveMode) {
                    resizeTerminal();
                }
            }, 200);
        }
    });
    
    // äº¤äº’ç»ˆç«¯æ–­å¼€è¿æ¥
    socket.on('terminal_disconnected', function(data) {
        console.log('Interactive terminal disconnected:', data);
        if (term && data.instance_id === currentMonitoringInstance) {
            term.write('\r\n\x1b[31mäº¤äº’ç»ˆç«¯å·²æ–­å¼€è¿æ¥\x1b[0m\r\n');
            if (data.message) {
                term.write('\x1b[33m' + data.message + '\x1b[0m\r\n');
            }
        }
    });
}

// åˆå§‹åŒ–ç»ˆç«¯
function initTerminal() {
    window.term = new Terminal({
        theme: {
            background: '#000000',
            foreground: '#ffffff',
            cursor: '#ffffff',
            selection: '#ffffff',
            black: '#000000',
            red: '#cd0000',
            green: '#00cd00',
            yellow: '#cdcd00',
            blue: '#0000ee',
            magenta: '#cd00cd',
            cyan: '#00cdcd',
            white: '#e5e5e5',
            brightBlack: '#7f7f7f',
            brightRed: '#ff0000',
            brightGreen: '#00ff00',
            brightYellow: '#ffff00',
            brightBlue: '#5c5cff',
            brightMagenta: '#ff00ff',
            brightCyan: '#00ffff',
            brightWhite: '#ffffff'
        },
        fontSize: 13,
        fontFamily: 'Monaco, Menlo, "Ubuntu Mono", "Courier New", monospace',
        cursorBlink: false,  // é»˜è®¤åªè¯»æ¨¡å¼ï¼Œä¸éœ€è¦å…‰æ ‡é—ªçƒ
        cursorStyle: 'block',
        scrollback: 10000,
        tabStopWidth: 4,
        convertEol: true,
        allowTransparency: false,
        bellSound: null,
        bellStyle: 'none',
        disableStdin: true  // é»˜è®¤ç¦ç”¨è¾“å…¥ï¼Œåªè¯»æ¨¡å¼
    });
    
    window.fitAddon = new FitAddon.FitAddon();
    window.term.loadAddon(window.fitAddon);
    
    window.term.open(document.getElementById('terminal'));
    window.fitAddon.fit();
    
    // ç›‘å¬çª—å£å¤§å°å˜åŒ–
    window.addEventListener('resize', () => {
        setTimeout(() => {
            resizeTerminal();
        }, 100);
    });
    
    // æ£€æŸ¥æ˜¯å¦æœ‰ä¸Šæ¬¡é€‰æ‹©çš„å®ä¾‹
    const lastSelected = window.terminalMemory ? window.terminalMemory.getLastSelectedInstance() : null;
    
    if (lastSelected) {
        // æ˜¾ç¤ºæ¢å¤ä¿¡æ¯
        window.term.writeln('\x1b[32mWelcome to Q Chat Terminal Monitor (Read-Only)\x1b[0m');
        window.term.writeln('\x1b[36mRestoring last selected instance...\x1b[0m\r\n');
    } else {
        // æ˜¾ç¤ºé»˜è®¤æ¬¢è¿ä¿¡æ¯
        window.term.writeln('\x1b[32mWelcome to Q Chat Terminal Monitor (Read-Only)\x1b[0m');
        window.term.writeln('Select an instance to start monitoring its output...\r\n');
    }
    
    // ä½¿ç”¨å…¨å±€å˜é‡ä»¥ä¾¿å…¶ä»–å‡½æ•°è®¿é—®
    term = window.term;
    fitAddon = window.fitAddon;
}

// å¼€å§‹ç›‘æ§å®ä¾‹
function startMonitoring(instanceId) {
    if (currentMonitoringInstance) {
        stopMonitoring();
    }
    
    currentMonitoringInstance = instanceId;
    
    // æ›´æ–°å®ä¾‹åˆ—è¡¨çš„é€‰ä¸­çŠ¶æ€
    if (typeof updateInstanceSelection === 'function') {
        updateInstanceSelection(instanceId);
    }
    
    // é‡ç½®ä¸ºåªè¯»æ¨¡å¼
    if (isInteractiveMode) {
        isInteractiveMode = false;
        const toggleBtn = document.getElementById('toggle-terminal-mode');
        const modeText = document.getElementById('terminal-mode-text');
        toggleBtn.innerHTML = '<i class="fas fa-keyboard"></i> äº¤äº’æ¨¡å¼';
        toggleBtn.className = 'btn btn-sm btn-outline-warning';
        modeText.textContent = 'ç»ˆç«¯è¾“å‡º (åªè¯»)';
        
        // é‡æ–°é…ç½®ç»ˆç«¯ä¸ºåªè¯»æ¨¡å¼
        if (term) {
            term.options.disableStdin = true;
            term.options.cursorBlink = false;
        }
    }
    
    term.clear();
    term.writeln('\x1b[33mStarting to monitor instance: ' + instanceId + '\x1b[0m');
    term.writeln('\x1b[36mLooking for log file...\x1b[0m\r\n');
    
    // é€šè¿‡WebSocketå¼€å§‹ç›‘æ§
    socket.emit('start_terminal_monitoring', {instance_id: instanceId});
}

// åœæ­¢ç›‘æ§
function stopMonitoring() {
    if (currentMonitoringInstance) {
        if (isInteractiveMode) {
            // å¦‚æœæ˜¯äº¤äº’æ¨¡å¼ï¼Œæ–­å¼€äº¤äº’ç»ˆç«¯è¿æ¥
            socket.emit('leave_terminal', {instance_id: currentMonitoringInstance});
        } else {
            // å¦‚æœæ˜¯åªè¯»æ¨¡å¼ï¼Œåœæ­¢æ—¥å¿—ç›‘æ§
            socket.emit('stop_terminal_monitoring', {instance_id: currentMonitoringInstance});
        }
        
        // æ›´æ–°å®ä¾‹åˆ—è¡¨çš„é€‰ä¸­çŠ¶æ€
        if (typeof updateInstanceSelection === 'function') {
            updateInstanceSelection(null);
        }
        
        currentMonitoringInstance = null;
        term.writeln('\r\n\x1b[31mMonitoring stopped\x1b[0m');
        
        // é‡ç½®æ¨¡å¼
        if (isInteractiveMode) {
            isInteractiveMode = false;
            const toggleBtn = document.getElementById('toggle-terminal-mode');
            const modeText = document.getElementById('terminal-mode-text');
            toggleBtn.innerHTML = '<i class="fas fa-keyboard"></i> äº¤äº’æ¨¡å¼';
            toggleBtn.className = 'btn btn-sm btn-outline-warning';
            modeText.textContent = 'ç»ˆç«¯è¾“å‡º (åªè¯»)';
        }
    }
}

// åˆ‡æ¢ç»ˆç«¯æ¨¡å¼
function toggleTerminalMode() {
    if (!currentMonitoringInstance) {
        alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå®ä¾‹è¿›è¡Œç›‘æ§');
        return;
    }
    
    const toggleBtn = document.getElementById('toggle-terminal-mode');
    const modeText = document.getElementById('terminal-mode-text');
    
    if (isInteractiveMode) {
        // åˆ‡æ¢åˆ°åªè¯»æ¨¡å¼
        switchToReadOnlyMode();
        toggleBtn.innerHTML = '<i class="fas fa-keyboard"></i> äº¤äº’æ¨¡å¼';
        toggleBtn.className = 'btn btn-sm btn-outline-warning';
        modeText.textContent = 'ç»ˆç«¯è¾“å‡º (åªè¯»)';
        isInteractiveMode = false;
    } else {
        // åˆ‡æ¢åˆ°äº¤äº’æ¨¡å¼
        switchToInteractiveMode();
        toggleBtn.innerHTML = '<i class="fas fa-eye"></i> åªè¯»æ¨¡å¼';
        toggleBtn.className = 'btn btn-sm btn-outline-success';
        modeText.textContent = 'ç»ˆç«¯äº¤äº’ (å¯è¾“å…¥)';
        isInteractiveMode = true;
    }
}

// åˆ‡æ¢åˆ°åªè¯»æ¨¡å¼
function switchToReadOnlyMode() {
    if (currentMonitoringInstance) {
        // æ–­å¼€äº¤äº’ç»ˆç«¯è¿æ¥
        socket.emit('leave_terminal', {instance_id: currentMonitoringInstance});
        
        // é‡æ–°é…ç½®ç»ˆç«¯ä¸ºåªè¯»æ¨¡å¼
        if (term) {
            term.options.disableStdin = true;
            term.options.cursorBlink = false;
            
            // è°ƒæ•´ç»ˆç«¯å¤§å°
            setTimeout(() => {
                resizeTerminal();
            }, 100);
        }
        
        // é‡æ–°å¼€å§‹æ—¥å¿—ç›‘æ§
        setTimeout(() => {
            socket.emit('start_terminal_monitoring', {instance_id: currentMonitoringInstance});
        }, 500);
    }
}

// åˆ‡æ¢åˆ°äº¤äº’æ¨¡å¼
function switchToInteractiveMode() {
    if (currentMonitoringInstance) {
        // åœæ­¢æ—¥å¿—ç›‘æ§
        socket.emit('stop_terminal_monitoring', {instance_id: currentMonitoringInstance});
        
        // é…ç½®ç»ˆç«¯ä¸ºäº¤äº’æ¨¡å¼
        if (term) {
            term.options.disableStdin = false;
            term.options.cursorBlink = true;
            
            // è°ƒæ•´ç»ˆç«¯å¤§å°
            setTimeout(() => {
                resizeTerminal();
            }, 100);
            
            // ç»‘å®šè¾“å…¥äº‹ä»¶
            term.onData(data => {
                if (isInteractiveMode && currentMonitoringInstance) {
                    socket.emit('terminal_input', {
                        instance_id: currentMonitoringInstance,
                        input: data
                    });
                }
            });
        }
        
        // è¿æ¥åˆ°äº¤äº’ç»ˆç«¯
        setTimeout(() => {
            socket.emit('join_terminal', {
                instance_id: currentMonitoringInstance,
                session_name: getSessionName(currentMonitoringInstance)
            });
        }, 500);
    }
}

// è°ƒæ•´ç»ˆç«¯å¤§å°
function resizeTerminal() {
    if (window.fitAddon && term) {
        window.fitAddon.fit();
        
        const cols = term.cols;
        const rows = term.rows;
        
        console.log(`ç»ˆç«¯å¤§å°è°ƒæ•´ä¸º: ${cols}x${rows}`);
        
        // å¦‚æœæ˜¯äº¤äº’æ¨¡å¼ï¼ŒåŒæ­¥åˆ°æœåŠ¡å™¨
        if (isInteractiveMode && currentMonitoringInstance) {
            socket.emit('terminal_resize', {
                instance_id: currentMonitoringInstance,
                cols: cols,
                rows: rows
            });
        }
        
        return {cols, rows};
    }
    return null;
}

// è·å–å®ä¾‹çš„ä¼šè¯åç§°
function getSessionName(instanceId) {
    // è¿™é‡Œå¯ä»¥ä»å®ä¾‹åˆ—è¡¨ä¸­è·å–ä¼šè¯åç§°
    // æš‚æ—¶ä½¿ç”¨å®ä¾‹IDä½œä¸ºä¼šè¯åç§°
    return instanceId;
}

// æ¸…ç©ºç»ˆç«¯
function clearTerminal() {
    if (term) {
        term.clear();
        if (currentMonitoringInstance) {
            term.writeln(`\x1b[33mç›‘æ§å®ä¾‹: ${currentMonitoringInstance}\x1b[0m\r\n`);
        }
    }
}

// åŠ è½½å®ä¾‹åˆ—è¡¨ - æ›´æ–°ä¸ºä½¿ç”¨namespaceåŠŸèƒ½
function loadInstances() {
    // ä½¿ç”¨namespaceç®¡ç†å™¨çš„å‡½æ•°
    if (typeof loadInstancesWithNamespace === 'function') {
        loadInstancesWithNamespace();
    } else {
        // å¤‡ç”¨æ–¹æ¡ˆ
        fetch('/api/instances')
            .then(response => response.json())
            .then(data => {
                updateInstancesList(data.instances || []);
            })
            .catch(error => {
                console.error('åŠ è½½å®ä¾‹å¤±è´¥:', error);
            });
    }
}

// åœæ­¢å®ä¾‹
function stopInstance(instanceId) {
    // æ£€æŸ¥æŒ‰é’®æ˜¯å¦è¢«ç¦ç”¨ï¼ˆå®ä¾‹å·²åœæ­¢ï¼‰
    const button = event.target.closest('button');
    if (button && button.disabled) {
        showNotification('å®ä¾‹å·²ç»åœæ­¢', 'info');
        return;
    }
    
    if (confirm(`ç¡®å®šè¦åœæ­¢å®ä¾‹ ${instanceId} å—ï¼Ÿ`)) {
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        if (button) {
            const originalContent = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            button.disabled = true;
        }
        
        fetch(`/api/stop/${instanceId}`, {method: 'POST'})
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(`å®ä¾‹ ${instanceId} å·²åœæ­¢`, 'success');
                    loadInstances();
                    if (currentMonitoringInstance === instanceId) {
                        stopMonitoring();
                    }
                } else {
                    showNotification(`åœæ­¢å®ä¾‹å¤±è´¥: ${data.error}`, 'error');
                }
                
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                if (button) {
                    button.innerHTML = '<i class="fas fa-stop"></i>';
                    button.disabled = false;
                }
            })
            .catch(error => {
                console.error('åœæ­¢å®ä¾‹å¤±è´¥:', error);
                showNotification(`åœæ­¢å®ä¾‹å¤±è´¥: ${error.message}`, 'error');
                
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                if (button) {
                    button.innerHTML = '<i class="fas fa-stop"></i>';
                    button.disabled = false;
                }
            });
    }
}

// ç»Ÿä¸€åˆ·æ–°åŠŸèƒ½ - æ•´åˆæ‰€æœ‰åˆ·æ–°æ“ä½œ
function manualRefresh() {
    console.log('ğŸ”„ æ‰§è¡Œç»Ÿä¸€åˆ·æ–°...');
    
    // æ˜¾ç¤ºåˆ·æ–°æŒ‰é’®çš„åŠ è½½çŠ¶æ€
    const refreshBtns = document.querySelectorAll('button[onclick="manualRefresh()"]');
    refreshBtns.forEach(btn => {
        if (btn) {
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> åˆ·æ–°ä¸­...';
            btn.disabled = true;
            
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            setTimeout(() => {
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }, 3000);
        }
    });
    
    // 1. åˆ·æ–°å®ä¾‹åˆ—è¡¨å’ŒçŠ¶æ€
    console.log('ğŸ“‹ åˆ·æ–°å®ä¾‹åˆ—è¡¨...');
    if (typeof refreshAllPageComponents === 'function') {
        refreshAllPageComponents();
    } else if (typeof loadInstancesWithNamespace === 'function') {
        loadInstancesWithNamespace();
    } else {
        loadInstances();
    }
    
    // 2. åˆ·æ–°èŠå¤©è®°å½•ç¼“å­˜
    console.log('ğŸ’¬ åˆ·æ–°èŠå¤©è®°å½•...');
    if (typeof refreshChatCache === 'function') {
        refreshChatCache();
    }
    
    // 3. åˆ·æ–°å®ä¾‹çŠ¶æ€
    console.log('ğŸ“Š åˆ·æ–°å®ä¾‹çŠ¶æ€...');
    if (typeof instanceStatusManager !== 'undefined' && instanceStatusManager) {
        instanceStatusManager.updateAllInstancesStatus();
    }
    
    // 4. åˆ·æ–°namespaceä¿¡æ¯
    console.log('ğŸ·ï¸ åˆ·æ–°namespaceä¿¡æ¯...');
    if (typeof refreshNamespaceStats === 'function') {
        refreshNamespaceStats();
    }
    
    // 5. é‡æ–°è·å–å¯ç”¨å®ä¾‹åˆ—è¡¨ï¼ˆç”¨äº@åŠŸèƒ½ï¼‰
    console.log('ğŸ”— åˆ·æ–°å¯ç”¨å®ä¾‹åˆ—è¡¨...');
    if (typeof updateAvailableInstances === 'function') {
        fetch('/api/instances')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateAvailableInstances(data.instances);
                }
            })
            .catch(error => console.error('åˆ·æ–°å¯ç”¨å®ä¾‹å¤±è´¥:', error));
    }
    
    // æ˜¾ç¤ºç»Ÿä¸€åˆ·æ–°å®Œæˆæç¤º
    if (typeof showNotification === 'function') {
        showNotification('ğŸ”„ é¡µé¢æ•°æ®å·²å…¨éƒ¨åˆ·æ–°', 'success', 3000);
    } else {
        console.log('âœ… ç»Ÿä¸€åˆ·æ–°å®Œæˆ');
    }
    
    console.log('âœ… ç»Ÿä¸€åˆ·æ–°æ“ä½œå®Œæˆ');
}

// èŠå¤©è®°å½•æ¡†æ‹–æ‹‰è°ƒæ•´é«˜åº¦åŠŸèƒ½
function initChatMessagesResize() {
    const chatMessages = document.getElementById('chatMessages');
    if (!chatMessages) return;
    
    let isResizing = false;
    let startY = 0;
    let startHeight = 0;
    
    // åˆ›å»ºæ‹–æ‹‰æ‰‹æŸ„
    const resizeHandle = document.createElement('div');
    resizeHandle.className = 'chat-resize-handle';
    resizeHandle.innerHTML = '<i class="fas fa-grip-lines"></i>';
    chatMessages.appendChild(resizeHandle);
    
    // é¼ æ ‡æŒ‰ä¸‹å¼€å§‹æ‹–æ‹‰
    resizeHandle.addEventListener('mousedown', startResize);
    
    // è§¦æ‘¸è®¾å¤‡æ”¯æŒ
    resizeHandle.addEventListener('touchstart', function(e) {
        e.preventDefault();
        const touch = e.touches[0];
        startResize({
            clientY: touch.clientY,
            preventDefault: () => {}
        });
    });
    
    function startResize(e) {
        isResizing = true;
        startY = e.clientY;
        startHeight = parseInt(document.defaultView.getComputedStyle(chatMessages).height, 10);
        
        chatMessages.classList.add('resizing');
        document.body.style.cursor = 'ns-resize';
        document.body.style.userSelect = 'none';
        
        e.preventDefault();
    }
    
    // é¼ æ ‡ç§»åŠ¨è°ƒæ•´é«˜åº¦
    document.addEventListener('mousemove', handleResize);
    document.addEventListener('touchmove', function(e) {
        if (!isResizing) return;
        e.preventDefault();
        const touch = e.touches[0];
        handleResize({
            clientY: touch.clientY,
            preventDefault: () => {}
        });
    });
    
    function handleResize(e) {
        if (!isResizing) return;
        
        const deltaY = e.clientY - startY;
        const newHeight = startHeight + deltaY;
        
        // é™åˆ¶é«˜åº¦èŒƒå›´
        const minHeight = 200;
        const maxHeight = window.innerHeight * 0.8;
        const clampedHeight = Math.max(minHeight, Math.min(newHeight, maxHeight));
        
        chatMessages.style.height = clampedHeight + 'px';
        chatMessages.style.flex = 'none'; // ç¦ç”¨flexè‡ªåŠ¨è°ƒæ•´
        
        // ä¿å­˜ç”¨æˆ·è®¾ç½®
        localStorage.setItem('chatMessagesHeight', clampedHeight);
        
        e.preventDefault();
    }
    
    // é¼ æ ‡é‡Šæ”¾ç»“æŸæ‹–æ‹‰
    document.addEventListener('mouseup', endResize);
    document.addEventListener('touchend', endResize);
    
    function endResize() {
        if (isResizing) {
            isResizing = false;
            chatMessages.classList.remove('resizing');
            document.body.style.cursor = '';
            document.body.style.userSelect = '';
            
            // æ˜¾ç¤ºè°ƒæ•´å®Œæˆæç¤º
            if (typeof showNotification === 'function') {
                const currentHeight = parseInt(chatMessages.style.height);
                showNotification(`ğŸ“ èŠå¤©è®°å½•æ¡†é«˜åº¦å·²è°ƒæ•´ä¸º ${currentHeight}px`, 'info', 2000);
            }
        }
    }
    
    // åŒå‡»é‡ç½®é«˜åº¦
    resizeHandle.addEventListener('dblclick', function() {
        chatMessages.style.height = '';
        chatMessages.style.flex = '1';
        localStorage.removeItem('chatMessagesHeight');
        
        if (typeof showNotification === 'function') {
            showNotification('ğŸ“ èŠå¤©è®°å½•æ¡†é«˜åº¦å·²é‡ç½®ä¸ºè‡ªåŠ¨', 'info', 2000);
        }
    });
    
    // æ¢å¤ç”¨æˆ·è®¾ç½®çš„é«˜åº¦
    const savedHeight = localStorage.getItem('chatMessagesHeight');
    if (savedHeight) {
        chatMessages.style.height = savedHeight + 'px';
        chatMessages.style.flex = 'none';
    }
    
    console.log('âœ… èŠå¤©è®°å½•æ¡†æ‹–æ‹‰è°ƒæ•´åŠŸèƒ½å·²åˆå§‹åŒ–');
}

// Namespaceåˆ‡æ¢è¾…åŠ©å‡½æ•°
function clearSelectedInstance() {
    // æ¸…é™¤å½“å‰é€‰ä¸­çš„å®ä¾‹
    window.currentInstanceId = null;
    
    // æ¸…ç©ºç›‘æ§è¾“å‡º
    const outputDiv = document.getElementById('instanceOutput');
    if (outputDiv) {
        outputDiv.innerHTML = '';
    }
    
    // é‡ç½®ç›‘æ§æŒ‰é’®çŠ¶æ€
    const monitorButtons = document.querySelectorAll('.monitor-btn');
    monitorButtons.forEach(btn => {
        btn.classList.remove('btn-warning');
        btn.classList.add('btn-outline-primary');
        btn.innerHTML = '<i class="fas fa-eye"></i>';
    });
}

function refreshNamespaceStats() {
    // åˆ·æ–°namespaceç»Ÿè®¡ä¿¡æ¯ï¼ˆå¦‚æœé¡µé¢æœ‰æ˜¾ç¤ºçš„è¯ï¼‰
    const statsElement = document.getElementById('namespaceStats');
    if (statsElement) {
        fetch('/api/namespaces/stats')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const stats = data.stats;
                    statsElement.innerHTML = `
                        <small class="text-muted">
                            æ€»è®¡: ${stats.total_instances} å®ä¾‹ / ${stats.total_namespaces} namespace
                        </small>
                    `;
                }
            })
            .catch(error => console.error('è·å–namespaceç»Ÿè®¡å¤±è´¥:', error));
    }
}

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸš€ é¡µé¢åˆå§‹åŒ–å¼€å§‹');
    
    // åŸºç¡€åˆå§‹åŒ–ï¼ˆè¿™äº›å‡½æ•°åº”è¯¥æ€»æ˜¯å­˜åœ¨çš„ï¼‰
    safeCall('initSocket');
    safeCall('initTerminal');
    safeCall('initAutoResizeTextarea');
    
    // å»¶è¿Ÿåˆå§‹åŒ–ï¼ˆå¯èƒ½éœ€è¦ç­‰å¾…è„šæœ¬åŠ è½½ï¼‰
    delayedSafeCall('initToolbar', 500, 3);
    delayedSafeCall('initInputPlaceholder', 500, 3);
    delayedSafeCall('initChatMessagesResize', 500, 3);
    
    // æ·»åŠ è·¯å¾„ç±»å‹åˆ‡æ¢ç›‘å¬å™¨
    const localPathRadio = document.getElementById('localPath');
    const gitPathRadio = document.getElementById('gitPath');
    if (localPathRadio && gitPathRadio) {
        localPathRadio.addEventListener('change', updatePathHelpText);
        gitPathRadio.addEventListener('change', updatePathHelpText);
    }
    
    // æ·»åŠ è·¯å¾„è¾“å…¥æ¡†çš„å®æ—¶éªŒè¯
    const pathInput = document.getElementById('instancePath');
    if (pathInput) {
        // é˜²æŠ–å¤„ç†ï¼Œé¿å…é¢‘ç¹éªŒè¯
        let validateTimeout;
        
        pathInput.addEventListener('input', function() {
            // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
            if (validateTimeout) {
                clearTimeout(validateTimeout);
            }
            
            // ç§»é™¤ä¹‹å‰çš„éªŒè¯æ ·å¼
            pathInput.classList.remove('is-valid', 'is-invalid');
            
            // å¦‚æœè¾“å…¥ä¸ºç©ºï¼Œä¸è¿›è¡ŒéªŒè¯
            if (!pathInput.value.trim()) {
                return;
            }
            
            // å»¶è¿ŸéªŒè¯ï¼Œé¿å…é¢‘ç¹è¯·æ±‚
            validateTimeout = setTimeout(() => {
                const isLocal = document.getElementById('localPath').checked;
                if (isLocal) {
                    validatePath();
                }
            }, 1000); // 1ç§’åéªŒè¯
        });
        
        // å¤±å»ç„¦ç‚¹æ—¶ç«‹å³éªŒè¯
        pathInput.addEventListener('blur', function() {
            if (validateTimeout) {
                clearTimeout(validateTimeout);
            }
            
            const isLocal = document.getElementById('localPath').checked;
            if (isLocal && pathInput.value.trim()) {
                validatePath();
            }
        });
    }
    
    // namespaceç®¡ç†å™¨ä¼šè‡ªåŠ¨åŠ è½½å®ä¾‹
    // ç§»é™¤è‡ªåŠ¨åˆ·æ–°ï¼Œæ”¹ä¸ºæ‰‹åŠ¨åˆ·æ–°
    
    // åˆå§‹åŒ–namespaceç»Ÿè®¡æ˜¾ç¤º
    setTimeout(() => {
        if (typeof refreshNamespaceStats === 'function') {
            refreshNamespaceStats();
        }
    }, 1000);
});

// åˆå§‹åŒ–è‡ªé€‚åº” textarea
function initAutoResizeTextarea() {
    const textarea = document.getElementById('messageInput');
    if (!textarea) return;
    
    // è‡ªé€‚åº”é«˜åº¦å‡½æ•°
    function autoResize() {
        textarea.style.height = 'auto';
        textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
    }
    
    // ç›‘å¬è¾“å…¥äº‹ä»¶
    textarea.addEventListener('input', autoResize);
    
    // ç›‘å¬é”®ç›˜äº‹ä»¶
    textarea.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            if (e.shiftKey) {
                // Shift+Enter æ¢è¡Œï¼Œä¸åšä»»ä½•å¤„ç†
                return;
            } else {
                // Enter å‘é€æ¶ˆæ¯
                e.preventDefault();
                sendMessage();
            }
        } else if (e.key === 'Escape') {
            // ESC æ¸…ç©ºè¾“å…¥æ¡†
            e.preventDefault();
            clearMessageInput();
        } else if (e.ctrlKey && e.key === 'l') {
            // Ctrl+L æ¸…ç©ºèŠå¤©è®°å½•
            e.preventDefault();
            clearChatMessages();
        } else if (e.ctrlKey && e.key === 'k') {
            // Ctrl+K å¿«é€Ÿèšç„¦åˆ°è¾“å…¥æ¡†
            e.preventDefault();
            textarea.focus();
        } else if (e.key === 'ArrowUp' && textarea.value === '') {
            // ä¸Šç®­å¤´é”®ï¼šé‡æ–°ç¼–è¾‘ä¸Šä¸€æ¡æ¶ˆæ¯ï¼ˆå½“è¾“å…¥æ¡†ä¸ºç©ºæ—¶ï¼‰
            e.preventDefault();
            recallLastMessage();
        } else if (e.key === 'ArrowDown' && textarea.value !== '') {
            // ä¸‹ç®­å¤´é”®ï¼šä¸‹ä¸€æ¡å†å²æ¶ˆæ¯
            e.preventDefault();
            recallNextMessage();
        } else if (e.ctrlKey && e.key >= '1' && e.key <= '9') {
            // Ctrl+æ•°å­—é”®ï¼šæ’å…¥å¿«é€Ÿæ–‡æœ¬
            e.preventDefault();
            insertQuickText(parseInt(e.key));
        } else if (e.key === 'F1' || (e.ctrlKey && e.key === '/')) {
            // F1 æˆ– Ctrl+/ æ˜¾ç¤ºå¿«æ·é”®å¸®åŠ©
            e.preventDefault();
            showKeyboardShortcuts();
        }
    });
    
    // åˆå§‹è°ƒæ•´
    autoResize();
}

// å®ä¾‹ç®¡ç†åŠŸèƒ½
function createInstance() {
    showCreateInstanceModal();
}

function showCreateInstanceModal() {
    // è®¾ç½®å½“å‰namespaceæ˜¾ç¤º
    const currentNs = getCurrentNamespace() || 'default';
    document.getElementById('currentNamespaceDisplay').value = currentNs;
    
    // è®¾ç½®é»˜è®¤å€¼
    document.getElementById('instanceName').value = '';
    document.getElementById('instanceRole').value = '';
    document.getElementById('instancePath').value = '';
    document.getElementById('localPath').checked = true;
    updatePathHelpText();
    
    // åŠ è½½è§’è‰²åˆ—è¡¨
    loadAvailableRoles();
    
    // æ˜¾ç¤ºæ¨¡æ€æ¡†
    const modal = new bootstrap.Modal(document.getElementById('createInstanceModal'));
    modal.show();
}

function updatePathHelpText() {
    const isLocal = document.getElementById('localPath').checked;
    const helpText = document.getElementById('pathHelpText');
    const pathInput = document.getElementById('instancePath');
    const browseBtn = document.getElementById('browsePathBtn');
    
    if (isLocal) {
        helpText.innerHTML = '<i class="fas fa-info-circle"></i> è¯·è¾“å…¥æœ¬åœ°ç›®å½•çš„ç»å¯¹è·¯å¾„ï¼Œæˆ–ç‚¹å‡»"æµè§ˆ"é€‰æ‹©ç›®å½•';
        pathInput.placeholder = 'ä¾‹å¦‚: /Users/username/project';
        browseBtn.style.display = 'block';
        browseBtn.disabled = false;
    } else {
        // è·å–é»˜è®¤é¡¹ç›®ç›®å½•å¹¶æ˜¾ç¤ºå®Œæ•´è·¯å¾„
        fetch('/api/config/projects-dir')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.projects_dir) {
                    // ç¡®ä¿æ˜¾ç¤ºå®Œæ•´çš„ç»å¯¹è·¯å¾„
                    const projectsDir = data.projects_dir;
                    helpText.innerHTML = `<i class="fas fa-info-circle"></i> è¯·è¾“å…¥Gitä»“åº“åœ°å€ï¼Œå°†è‡ªåŠ¨å…‹éš†åˆ°: <br><code style="word-break: break-all;">${projectsDir}</code>`;
                } else {
                    helpText.innerHTML = '<i class="fas fa-info-circle"></i> è¯·è¾“å…¥Gitä»“åº“åœ°å€ï¼Œå°†è‡ªåŠ¨å…‹éš†åˆ°é»˜è®¤é¡¹ç›®ç›®å½•';
                }
            })
            .catch(error => {
                console.error('è·å–é¡¹ç›®ç›®å½•å¤±è´¥:', error);
                helpText.innerHTML = '<i class="fas fa-info-circle"></i> è¯·è¾“å…¥Gitä»“åº“åœ°å€ï¼Œå°†è‡ªåŠ¨å…‹éš†åˆ°é»˜è®¤é¡¹ç›®ç›®å½•';
            });
        
        pathInput.placeholder = 'ä¾‹å¦‚: https://github.com/user/repo.git';
        browseBtn.style.display = 'none';
        browseBtn.disabled = true;
    }
}

// åŠ¨æ€åŠ è½½å¯ç”¨è§’è‰²åˆ—è¡¨
async function loadAvailableRoles() {
    const roleSelect = document.getElementById('instanceRole');
    
    try {
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        roleSelect.innerHTML = '<option value="">åŠ è½½è§’è‰²åˆ—è¡¨ä¸­...</option>';
        roleSelect.disabled = true;
        
        const response = await fetch('/api/roles');
        const result = await response.json();
        
        if (result.success && result.roles) {
            // æ¸…ç©ºç°æœ‰é€‰é¡¹
            roleSelect.innerHTML = '<option value="">è¯·é€‰æ‹©è§’è‰²ï¼ˆå¯é€‰ï¼‰</option>';
            
            // æ·»åŠ è§’è‰²é€‰é¡¹
            result.roles.forEach(role => {
                const option = document.createElement('option');
                option.value = role.name || role;
                option.textContent = role.display_name || role.name || role;
                
                // å¦‚æœæœ‰æè¿°ï¼Œæ·»åŠ åˆ°titleå±æ€§
                if (role.description) {
                    option.title = role.description;
                }
                
                roleSelect.appendChild(option);
            });
            
            roleSelect.disabled = false;
        } else {
            // åŠ è½½å¤±è´¥ï¼Œæ˜¾ç¤ºé»˜è®¤é€‰é¡¹
            roleSelect.innerHTML = '<option value="">è¯·é€‰æ‹©è§’è‰²ï¼ˆå¯é€‰ï¼‰</option>';
            roleSelect.disabled = false;
            console.warn('åŠ è½½è§’è‰²åˆ—è¡¨å¤±è´¥:', result.error);
        }
    } catch (error) {
        console.error('åŠ è½½è§’è‰²åˆ—è¡¨å¤±è´¥:', error);
        // å‡ºé”™æ—¶æ˜¾ç¤ºé»˜è®¤é€‰é¡¹
        roleSelect.innerHTML = '<option value="">è¯·é€‰æ‹©è§’è‰²ï¼ˆå¯é€‰ï¼‰</option>';
        roleSelect.disabled = false;
    }
}

// Git URLéªŒè¯
async function validateGitUrl(url) {
    try {
        const response = await fetch('/api/config/validate-git-url', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({url: url})
        });
        
        const result = await response.json();
        return result;
    } catch (error) {
        return {
            success: false,
            error: 'éªŒè¯Git URLå¤±è´¥: ' + error.message
        };
    }
}

// å¢å¼ºçš„è·¯å¾„éªŒè¯
async function validatePath(path, isLocal) {
    if (!path.trim()) {
        return {success: false, error: 'è·¯å¾„ä¸èƒ½ä¸ºç©º'};
    }
    
    if (isLocal) {
        // æœ¬åœ°è·¯å¾„éªŒè¯
        try {
            const response = await fetch('/api/validate-path', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({path: path})
            });
            return await response.json();
        } catch (error) {
            return {success: false, error: 'éªŒè¯æœ¬åœ°è·¯å¾„å¤±è´¥: ' + error.message};
        }
    } else {
        // Git URLéªŒè¯
        return await validateGitUrl(path);
    }
}

// è·³è¿‡æµè§ˆï¼Œç›´æ¥æ‰‹åŠ¨è¾“å…¥
function skipBrowseAndManualInput() {
    // éšè—è·³è¿‡æŒ‰é’®
    const skipBtn = document.getElementById('skipBrowseBtn');
    if (skipBtn) {
        skipBtn.style.display = 'none';
    }
    
    // æ¢å¤æµè§ˆæŒ‰é’®çŠ¶æ€
    const browseBtn = document.getElementById('browsePathBtn');
    if (browseBtn) {
        browseBtn.innerHTML = '<i class="fas fa-folder-open"></i> æµè§ˆ';
        browseBtn.disabled = false;
    }
    
    // èšç„¦åˆ°è¾“å…¥æ¡†
    const pathInput = document.getElementById('instancePath');
    if (pathInput) {
        pathInput.focus();
        pathInput.placeholder = 'è¯·æ‰‹åŠ¨è¾“å…¥å®Œæ•´çš„æœ¬åœ°è·¯å¾„ï¼Œä¾‹å¦‚ï¼š/Users/username/project';
    }
    
    // æ˜¾ç¤ºæ‰‹åŠ¨è¾“å…¥æç¤º
    showNotification('å·²è·³è¿‡ç›®å½•é€‰æ‹©ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥å®Œæ•´è·¯å¾„', 'info');
    showDirectoryInputHelper();
}

// æµè§ˆæœ¬åœ°è·¯å¾„
async function browsePath() {
    try {
        const pathInput = document.getElementById('instancePath');
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        const browseBtn = document.getElementById('browsePathBtn');
        const originalBtnContent = browseBtn.innerHTML;
        browseBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> é€‰æ‹©ä¸­...';
        browseBtn.disabled = true;
        
        // æ˜¾ç¤ºè·³è¿‡æŒ‰é’®
        const skipBtn = document.getElementById('skipBrowseBtn');
        if (skipBtn) {
            skipBtn.style.display = 'inline-block';
        }
        
        // æ˜¾ç¤ºæç¤ºä¿¡æ¯
        showNotification('æ­£åœ¨æ‰“å¼€ç›®å½•é€‰æ‹©å¯¹è¯æ¡†ï¼Œè¯·åœ¨ç³»ç»Ÿå¯¹è¯æ¡†ä¸­é€‰æ‹©ç›®å½•...', 'info');
        
        // è°ƒç”¨åç«¯APIæ‰“å¼€ç›®å½•é€‰æ‹©å¯¹è¯æ¡†ï¼Œå¢åŠ è¶…æ—¶æ—¶é—´åˆ°6åˆ†é’Ÿ
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 360000); // 6åˆ†é’Ÿè¶…æ—¶
        
        const response = await fetch('/api/directory/select', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        const result = await response.json();
        
        if (result.success) {
            // è®¾ç½®å®Œæ•´çš„ç»å¯¹è·¯å¾„
            pathInput.value = result.path;
            
            // æ˜¾ç¤ºæˆåŠŸæç¤º
            showNotification(`å·²é€‰æ‹©ç›®å½•: ${result.directory_name}`, 'success');
            
            // è‡ªåŠ¨éªŒè¯è·¯å¾„
            await validatePath();
            
        } else {
            if (result.cancelled) {
                // ç”¨æˆ·å–æ¶ˆé€‰æ‹©ï¼Œæ˜¾ç¤ºæ¸©å’Œæç¤º
                showNotification('å·²å–æ¶ˆç›®å½•é€‰æ‹©', 'info');
            } else if (result.timeout) {
                // è¶…æ—¶å¤„ç†
                showNotification('ç›®å½•é€‰æ‹©è¶…æ—¶ï¼Œè¯·é‡è¯•æˆ–æ‰‹åŠ¨è¾“å…¥è·¯å¾„', 'warning');
                showDirectoryInputHelper();
            } else if (result.unsupported) {
                // ç³»ç»Ÿä¸æ”¯æŒ
                showNotification('ç³»ç»Ÿä¸æ”¯æŒç›®å½•é€‰æ‹©å¯¹è¯æ¡†ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥è·¯å¾„', 'warning');
                showDirectoryInputHelper();
            } else {
                // å…¶ä»–é”™è¯¯
                showNotification(`é€‰æ‹©ç›®å½•å¤±è´¥: ${result.error}`, 'error');
            }
        }
        
    } catch (error) {
        if (error.name === 'AbortError') {
            // å‰ç«¯è¶…æ—¶
            showNotification('ç›®å½•é€‰æ‹©è¶…æ—¶ï¼Œè¯·é‡è¯•æˆ–æ‰‹åŠ¨è¾“å…¥è·¯å¾„', 'warning');
        } else {
            console.error('æµè§ˆç›®å½•å¤±è´¥:', error);
            showNotification('æµè§ˆç›®å½•å¤±è´¥: ' + error.message, 'error');
        }
        
        // é™çº§æ–¹æ¡ˆï¼šæ˜¾ç¤ºæ‰‹åŠ¨è¾“å…¥æç¤º
        showDirectoryInputHelper();
        
    } finally {
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        const browseBtn = document.getElementById('browsePathBtn');
        if (browseBtn) {
            browseBtn.innerHTML = originalBtnContent;
            browseBtn.disabled = false;
        }
        
        // éšè—è·³è¿‡æŒ‰é’®
        const skipBtn = document.getElementById('skipBrowseBtn');
        if (skipBtn) {
            skipBtn.style.display = 'none';
        }
    }
}

// éªŒè¯è·¯å¾„å¹¶è‡ªåŠ¨è½¬æ¢ä¸ºç»å¯¹è·¯å¾„
async function validatePath() {
    const pathInput = document.getElementById('instancePath');
    const path = pathInput.value.trim();
    
    if (!path) return;
    
    try {
        const response = await fetch('/api/directory/validate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ path: path })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // å¦‚æœè¾“å…¥çš„ä¸æ˜¯ç»å¯¹è·¯å¾„ï¼Œè‡ªåŠ¨æ›´æ–°ä¸ºç»å¯¹è·¯å¾„
            if (pathInput.value !== result.path) {
                pathInput.value = result.path;
                showNotification('è·¯å¾„å·²è½¬æ¢ä¸ºç»å¯¹è·¯å¾„', 'info');
            }
            
            // ç§»é™¤é”™è¯¯æ ·å¼
            pathInput.classList.remove('is-invalid');
            pathInput.classList.add('is-valid');
            
        } else {
            // æ˜¾ç¤ºé”™è¯¯æ ·å¼
            pathInput.classList.remove('is-valid');
            pathInput.classList.add('is-invalid');
            
            // å¦‚æœæœ‰å»ºè®®è·¯å¾„ï¼Œå¯ä»¥é€‰æ‹©ä½¿ç”¨
            if (result.suggested_path && result.suggested_path !== path) {
                const useAbsPath = confirm(`è·¯å¾„éªŒè¯å¤±è´¥: ${result.error}\n\næ˜¯å¦ä½¿ç”¨ç»å¯¹è·¯å¾„: ${result.suggested_path}?`);
                if (useAbsPath) {
                    pathInput.value = result.suggested_path;
                    // é‡æ–°éªŒè¯
                    setTimeout(() => validatePath(), 100);
                }
            }
        }
        
    } catch (error) {
        console.error('éªŒè¯è·¯å¾„å¤±è´¥:', error);
        pathInput.classList.remove('is-valid');
        pathInput.classList.add('is-invalid');
    }
}

// æ˜¾ç¤ºç›®å½•è¾“å…¥å¸®åŠ©
function showDirectoryInputHelper() {
    const helpModal = document.createElement('div');
    helpModal.className = 'modal fade';
    helpModal.innerHTML = `
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-folder-open"></i> ç›®å½•è·¯å¾„è¾“å…¥å¸®åŠ©
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>ç›®å½•é€‰æ‹©å¯¹è¯æ¡†æ— æ³•ä½¿ç”¨ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥ç›®å½•è·¯å¾„</strong>
                    </div>
                    
                    <h6><i class="fas fa-keyboard"></i> è¾“å…¥æ ¼å¼ç¤ºä¾‹ï¼š</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-primary">ç»å¯¹è·¯å¾„ï¼š</h6>
                            <ul class="list-unstyled">
                                <li><code>/Users/username/Documents/project</code></li>
                                <li><code>/home/user/workspace/myapp</code></li>
                                <li><code>/opt/projects/webapp</code></li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-success">å¿«æ·ç¬¦å·ï¼š</h6>
                            <ul class="list-unstyled">
                                <li><code>~</code> - ç”¨æˆ·ä¸»ç›®å½•</li>
                                <li><code>~/Documents</code> - æ–‡æ¡£ç›®å½•</li>
                                <li><code>.</code> - å½“å‰ç›®å½•</li>
                                <li><code>../</code> - ä¸Šçº§ç›®å½•</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="alert alert-success">
                        <i class="fas fa-magic"></i>
                        <strong>æ™ºèƒ½åŠŸèƒ½ï¼š</strong>è¾“å…¥è·¯å¾„åä¼šè‡ªåŠ¨éªŒè¯å¹¶è½¬æ¢ä¸ºç»å¯¹è·¯å¾„
                    </div>
                    
                    <h6><i class="fas fa-tools"></i> å¿«é€Ÿæ“ä½œï¼š</h6>
                    <div class="d-grid gap-2 d-md-flex justify-content-md-start">
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="fillHomeDirectory()" data-bs-dismiss="modal">
                            <i class="fas fa-home"></i> ä½¿ç”¨ä¸»ç›®å½•
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="fillCurrentDirectory()" data-bs-dismiss="modal">
                            <i class="fas fa-folder"></i> ä½¿ç”¨å½“å‰ç›®å½•
                        </button>
                        <button type="button" class="btn btn-outline-info btn-sm" onclick="fillDocumentsDirectory()" data-bs-dismiss="modal">
                            <i class="fas fa-file-alt"></i> ä½¿ç”¨æ–‡æ¡£ç›®å½•
                        </button>
                    </div>
                    
                    <div class="alert alert-warning mt-3">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>æ³¨æ„äº‹é¡¹ï¼š</strong>
                        <ul class="mb-0 mt-2">
                            <li>ç¡®ä¿ç›®å½•å­˜åœ¨ä¸”æœ‰è¯»å†™æƒé™</li>
                            <li>è·¯å¾„ä¸­ä¸è¦åŒ…å«ç‰¹æ®Šå­—ç¬¦</li>
                            <li>å¯ä»¥é‡æ–°ç‚¹å‡»"æµè§ˆ"æŒ‰é’®å†æ¬¡å°è¯•</li>
                        </ul>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> å…³é—­
                    </button>
                    <button type="button" class="btn btn-primary" onclick="retryBrowsePath()" data-bs-dismiss="modal">
                        <i class="fas fa-redo"></i> é‡æ–°å°è¯•æµè§ˆ
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(helpModal);
    const modal = new bootstrap.Modal(helpModal);
    modal.show();
    
    // æ¨¡æ€æ¡†å…³é—­åæ¸…ç†
    helpModal.addEventListener('hidden.bs.modal', () => {
        document.body.removeChild(helpModal);
    });
}

// å¡«å……ä¸»ç›®å½•
function fillHomeDirectory() {
    const pathInput = document.getElementById('instancePath');
    pathInput.value = '~';
    pathInput.focus();
    // è§¦å‘éªŒè¯
    setTimeout(() => validatePath(), 100);
}

// å¡«å……å½“å‰ç›®å½•
function fillCurrentDirectory() {
    const pathInput = document.getElementById('instancePath');
    pathInput.value = '.';
    pathInput.focus();
    // è§¦å‘éªŒè¯
    setTimeout(() => validatePath(), 100);
}

// å¡«å……æ–‡æ¡£ç›®å½•
function fillDocumentsDirectory() {
    const pathInput = document.getElementById('instancePath');
    pathInput.value = '~/Documents';
    pathInput.focus();
    // è§¦å‘éªŒè¯
    setTimeout(() => validatePath(), 100);
}

// é‡æ–°å°è¯•æµè§ˆè·¯å¾„
function retryBrowsePath() {
    // å»¶è¿Ÿä¸€ä¸‹å†è°ƒç”¨ï¼Œé¿å…æ¨¡æ€æ¡†å…³é—­åŠ¨ç”»å†²çª
    setTimeout(() => {
        browsePath();
    }, 300);
}

// å®ä¾‹åˆ›å»ºè¿›åº¦ç®¡ç†
let creationAbortController = null;
let currentConflictData = null;

function showCreationProgress() {
    const modal = new bootstrap.Modal(document.getElementById('instanceCreationProgressModal'));
    modal.show();
    
    // é‡ç½®è¿›åº¦
    updateCreationProgress(0, 'æ­£åœ¨å‡†å¤‡åˆ›å»ºå®ä¾‹...');
    resetCreationSteps();
}

function hideCreationProgress() {
    const modal = bootstrap.Modal.getInstance(document.getElementById('instanceCreationProgressModal'));
    if (modal) {
        modal.hide();
    }
}

function updateCreationProgress(percentage, text) {
    const progressBar = document.getElementById('creationProgressBar');
    const progressText = document.getElementById('creationProgressText');
    
    if (progressBar) {
        progressBar.style.width = percentage + '%';
    }
    
    if (progressText) {
        progressText.textContent = text;
    }
}

function updateCreationStep(stepId, status, text) {
    const stepElement = document.getElementById(stepId);
    if (!stepElement) return;
    
    stepElement.style.display = 'block';
    stepElement.className = 'step-item ' + status;
    
    const icon = stepElement.querySelector('i');
    const textSpan = stepElement.querySelector('span') || document.createElement('span');
    
    switch (status) {
        case 'active':
            icon.className = 'fas fa-spinner fa-spin text-primary';
            break;
        case 'completed':
            icon.className = 'fas fa-check text-success';
            break;
        case 'error':
            icon.className = 'fas fa-times text-danger';
            break;
        default:
            icon.className = 'fas fa-clock text-muted';
    }
    
    if (text) {
        if (!stepElement.querySelector('span')) {
            stepElement.appendChild(document.createTextNode(' '));
            stepElement.appendChild(textSpan);
        }
        textSpan.textContent = text;
    }
}

function resetCreationSteps() {
    const steps = ['step-validate', 'step-clone', 'step-create', 'step-complete'];
    steps.forEach(stepId => {
        const step = document.getElementById(stepId);
        if (step) {
            step.className = 'step-item';
            step.style.display = stepId === 'step-validate' ? 'block' : 'none';
            const icon = step.querySelector('i');
            if (icon) {
                icon.className = 'fas fa-clock text-muted';
            }
            const span = step.querySelector('span');
            if (span) {
                span.remove();
            }
        }
    });
}

function cancelInstanceCreation() {
    if (creationAbortController) {
        creationAbortController.abort();
    }
    hideCreationProgress();
    showNotification('å®ä¾‹åˆ›å»ºå·²å–æ¶ˆ', 'info');
}

// ç›®å½•å†²çªå¤„ç†
function showDirectoryConflictModal(conflictPath, conflictData) {
    currentConflictData = conflictData;
    
    const pathElement = document.getElementById('conflictDirectoryPath');
    if (pathElement) {
        pathElement.innerHTML = `<code>${conflictPath}</code>`;
    }
    
    const modal = new bootstrap.Modal(document.getElementById('directoryConflictModal'));
    modal.show();
}

function handleDirectoryConflict(action) {
    const modal = bootstrap.Modal.getInstance(document.getElementById('directoryConflictModal'));
    if (modal) {
        modal.hide();
    }
    
    if (!currentConflictData) {
        showNotification('å¤„ç†ç›®å½•å†²çªå¤±è´¥ï¼šç¼ºå°‘å†²çªæ•°æ®', 'error');
        return;
    }
    
    // æ ¹æ®ç”¨æˆ·é€‰æ‹©å¤„ç†å†²çª
    currentConflictData.conflict_resolution = action;
    
    // ç»§ç»­åˆ›å»ºå®ä¾‹
    continueInstanceCreation(currentConflictData);
}

async function continueInstanceCreation(requestData) {
    try {
        showCreationProgress();
        updateCreationStep('step-create', 'active', 'æ­£åœ¨åˆ›å»ºå®ä¾‹...');
        updateCreationProgress(60, 'æ­£åœ¨åˆ›å»ºå®ä¾‹...');
        
        const response = await fetch('/api/start-with-config', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData),
            signal: creationAbortController?.signal
        });
        
        const result = await response.json();
        
        if (result.success) {
            updateCreationStep('step-create', 'completed', 'å®ä¾‹åˆ›å»ºæˆåŠŸ');
            updateCreationStep('step-complete', 'active', 'å®Œæˆè®¾ç½®...');
            updateCreationProgress(100, 'å®ä¾‹åˆ›å»ºå®Œæˆï¼');
            
            setTimeout(() => {
                hideCreationProgress();
                
                // å…³é—­åˆ›å»ºæ¨¡æ€æ¡†
                const createModal = bootstrap.Modal.getInstance(document.getElementById('createInstanceModal'));
                if (createModal) {
                    createModal.hide();
                }
                
                showNotification(`å®ä¾‹åˆ›å»ºæˆåŠŸ: ${result.instance_id}`, 'success');
                loadInstancesWithNamespace();
            }, 1000);
            
        } else {
            updateCreationStep('step-create', 'error', 'åˆ›å»ºå¤±è´¥');
            updateCreationProgress(100, 'åˆ›å»ºå¤±è´¥: ' + result.error);
            
            setTimeout(() => {
                hideCreationProgress();
                alert('åˆ›å»ºå®ä¾‹å¤±è´¥: ' + result.error);
            }, 2000);
        }
        
    } catch (error) {
        if (error.name === 'AbortError') {
            return; // ç”¨æˆ·å–æ¶ˆï¼Œä¸æ˜¾ç¤ºé”™è¯¯
        }
        
        updateCreationStep('step-create', 'error', 'åˆ›å»ºå¼‚å¸¸');
        updateCreationProgress(100, 'åˆ›å»ºå¼‚å¸¸: ' + error.message);
        
        setTimeout(() => {
            hideCreationProgress();
            alert('åˆ›å»ºå®ä¾‹å¤±è´¥: ' + error.message);
        }, 2000);
    }
}

async function createInstanceFromModal() {
    const namespace = getCurrentNamespace() || 'default'; // ä½¿ç”¨å½“å‰namespace
    const name = document.getElementById('instanceName').value.trim();
    const role = document.getElementById('instanceRole').value;
    const path = document.getElementById('instancePath').value.trim();
    const isLocal = document.getElementById('localPath').checked;
    
    // éªŒè¯å¿…å¡«å­—æ®µ
    if (!path) {
        alert('è¯·è¾“å…¥è·¯å¾„');
        return;
    }
    
    // è·å–åˆ›å»ºæŒ‰é’®å’Œå–æ¶ˆæŒ‰é’®
    const createButton = document.querySelector('#createInstanceModal .btn-success');
    const cancelButton = document.querySelector('#createInstanceModal .btn-secondary');
    const originalButtonText = createButton.innerHTML;
    
    try {
        // æ˜¾ç¤ºæŒ‰é’®åŠ è½½çŠ¶æ€
        createButton.disabled = true;
        cancelButton.disabled = true;
        createButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> åˆ›å»ºä¸­...';
        createButton.classList.add('loading');
        
        // æ˜¾ç¤ºè¿›åº¦æ¨¡æ€æ¡†
        showCreationProgress();
        updateCreationProgress(20, 'æ­£åœ¨å‡†å¤‡åˆ›å»ºå®ä¾‹...');
        updateCreationStep('step-validate', 'active', 'éªŒè¯é…ç½®ä¿¡æ¯...');
        
        const requestData = {
            namespace: namespace,
            role: role,
            path: path,
            path_type: isLocal ? 'local' : 'git'
        };
        
        if (name) {
            requestData.name = name;
        }
        
        // æ›´æ–°è¿›åº¦
        updateCreationProgress(40, 'æ­£åœ¨å‘é€åˆ›å»ºè¯·æ±‚...');
        updateCreationStep('step-validate', 'completed', 'é…ç½®éªŒè¯å®Œæˆ');
        updateCreationStep('step-create', 'active', 'æ­£åœ¨åˆ›å»ºå®ä¾‹...');
        
        // åˆ›å»ºè¶…æ—¶æ§åˆ¶å™¨ï¼Œè®¾ç½®2åˆ†é’Ÿè¶…æ—¶
        const controller = new AbortController();
        const timeoutId = setTimeout(() => {
            controller.abort();
            hideCreationProgress();
            showNotification('åˆ›å»ºå®ä¾‹è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–é‡è¯•', 'error');
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            restoreButtonState();
        }, 120000); // 2åˆ†é’Ÿè¶…æ—¶
        
        const response = await fetch('/api/start-with-config', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData),
            signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        // æ›´æ–°è¿›åº¦
        updateCreationProgress(80, 'æ­£åœ¨å¤„ç†å“åº”...');
        
        const result = await response.json();
        
        if (result.success) {
            // å®Œæˆè¿›åº¦
            updateCreationProgress(100, 'å®ä¾‹åˆ›å»ºæˆåŠŸï¼');
            updateCreationStep('step-create', 'completed', 'å®ä¾‹åˆ›å»ºå®Œæˆ');
            updateCreationStep('step-complete', 'completed', 'åˆ›å»ºæˆåŠŸ');
            
            // å»¶è¿Ÿå…³é—­è¿›åº¦æ¨¡æ€æ¡†ï¼Œè®©ç”¨æˆ·çœ‹åˆ°æˆåŠŸçŠ¶æ€
            setTimeout(() => {
                hideCreationProgress();
                
                // å…³é—­åˆ›å»ºæ¨¡æ€æ¡†
                const modal = bootstrap.Modal.getInstance(document.getElementById('createInstanceModal'));
                modal.hide();
                
                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                showNotification(`å®ä¾‹åˆ›å»ºæˆåŠŸ: ${result.instance_id}`, 'success');
                
                // é‡æ–°åŠ è½½å®ä¾‹åˆ—è¡¨
                loadInstancesWithNamespace();
                
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                restoreButtonState();
            }, 1500);
            
        } else {
            // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
            updateCreationStep('step-create', 'error', 'åˆ›å»ºå¤±è´¥');
            updateCreationProgress(100, 'åˆ›å»ºå¤±è´¥: ' + result.error);
            
            setTimeout(() => {
                hideCreationProgress();
                alert('åˆ›å»ºå®ä¾‹å¤±è´¥: ' + result.error);
                
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                restoreButtonState();
            }, 2000);
        }
    } catch (error) {
        console.error('åˆ›å»ºå®ä¾‹å¤±è´¥:', error);
        
        // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
        updateCreationStep('step-create', 'error', 'åˆ›å»ºå¤±è´¥');
        updateCreationProgress(100, 'åˆ›å»ºå¤±è´¥: ' + error.message);
        
        setTimeout(() => {
            hideCreationProgress();
            alert('åˆ›å»ºå®ä¾‹å¤±è´¥: ' + error.message);
            
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            restoreButtonState();
        }, 2000);
    }
    
    // æ¢å¤æŒ‰é’®çŠ¶æ€çš„è¾…åŠ©å‡½æ•°
    function restoreButtonState() {
        createButton.disabled = false;
        cancelButton.disabled = false;
        createButton.innerHTML = originalButtonText;
        createButton.classList.remove('loading');
    }
}
function showCreateNamespaceModal() {
    // æ¸…ç©ºè¡¨å•
    document.getElementById('newNamespaceName').value = '';
    document.getElementById('newNamespaceDescription').value = '';
    
    // æ˜¾ç¤ºæ¨¡æ€æ¡†
    const modal = new bootstrap.Modal(document.getElementById('createNamespaceModal'));
    modal.show();
}

function showDeleteNamespaceModal() {
    const currentNs = getCurrentNamespace();
    if (!currentNs) {
        alert('æ— æ³•åˆ é™¤é»˜è®¤ namespace');
        return;
    }
    
    // è®¾ç½®è¦åˆ é™¤çš„ namespace åç§°
    document.getElementById('deleteNamespaceName').textContent = currentNs;
    document.getElementById('confirmDeleteText').textContent = currentNs;
    document.getElementById('confirmDeleteInput').value = '';
    document.getElementById('confirmDeleteBtn').disabled = true;
    
    // ç›‘å¬ç¡®è®¤è¾“å…¥
    const confirmInput = document.getElementById('confirmDeleteInput');
    confirmInput.oninput = function() {
        const confirmBtn = document.getElementById('confirmDeleteBtn');
        confirmBtn.disabled = this.value !== currentNs;
    };
    
    // æ˜¾ç¤ºæ¨¡æ€æ¡†
    const modal = new bootstrap.Modal(document.getElementById('deleteNamespaceModal'));
    modal.show();
}

async function createNamespace() {
    const nameInput = document.getElementById('newNamespaceName');
    const descInput = document.getElementById('newNamespaceDescription');
    
    const name = nameInput.value.trim();
    const description = descInput.value.trim();
    
    if (!name) {
        alert('è¯·è¾“å…¥ namespace åç§°');
        nameInput.focus();
        return;
    }
    
    // éªŒè¯åç§°æ ¼å¼
    if (!/^[a-zA-Z0-9_-]+$/.test(name)) {
        alert('Namespace åç§°åªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿å’Œè¿å­—ç¬¦');
        nameInput.focus();
        return;
    }
    
    try {
        const response = await fetch('/api/namespaces', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                name: name,
                description: description
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // å…³é—­æ¨¡æ€æ¡†
            const modal = bootstrap.Modal.getInstance(document.getElementById('createNamespaceModal'));
            modal.hide();
            
            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            showNotification(`Namespace "${name}" åˆ›å»ºæˆåŠŸ`, 'success');
            
            // é‡æ–°åŠ è½½ namespace åˆ—è¡¨
            loadNamespaces().then(() => {
                // åˆ‡æ¢åˆ°æ–°åˆ›å»ºçš„ namespace
                currentNamespace = name;
                window.currentNamespace = name;
                storeNamespace(name);
                
                // æ›´æ–°é€‰æ‹©å™¨
                const select = document.getElementById('currentNamespaceSelect');
                if (select) {
                    select.value = name;
                }
                
                // é‡æ–°åŠ è½½å®ä¾‹åˆ—è¡¨
                loadInstancesWithNamespace();
            });
        } else {
            alert(`åˆ›å»ºå¤±è´¥: ${result.error}`);
        }
    } catch (error) {
        console.error('åˆ›å»º namespace å¤±è´¥:', error);
        alert(`åˆ›å»ºå¤±è´¥: ${error.message}`);
    }
}

async function deleteNamespace() {
    const nameToDelete = document.getElementById('deleteNamespaceName').textContent;
    
    try {
        const response = await fetch(`/api/namespaces/${nameToDelete}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (result.success) {
            // å…³é—­æ¨¡æ€æ¡†
            const modal = bootstrap.Modal.getInstance(document.getElementById('deleteNamespaceModal'));
            modal.hide();
            
            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            showNotification(`Namespace "${nameToDelete}" åˆ é™¤æˆåŠŸ`, 'success');
            
            // åˆ‡æ¢åˆ°é»˜è®¤ namespace
            currentNamespace = '';
            window.currentNamespace = '';
            storeNamespace('');
            
            // é‡æ–°åŠ è½½ namespace åˆ—è¡¨å’Œå®ä¾‹åˆ—è¡¨
            loadNamespaces().then(() => {
                loadInstancesWithNamespace();
            });
        } else {
            alert(`åˆ é™¤å¤±è´¥: ${result.error}`);
        }
    } catch (error) {
        console.error('åˆ é™¤ namespace å¤±è´¥:', error);
        alert(`åˆ é™¤å¤±è´¥: ${error.message}`);
    }
}

// å¿«æ·é”®åŠŸèƒ½å‡½æ•°
let lastSentMessage = ''; // å­˜å‚¨ä¸Šä¸€æ¡å‘é€çš„æ¶ˆæ¯

// æ¸…ç©ºè¾“å…¥æ¡†
function clearMessageInput() {
    const textarea = document.getElementById('messageInput');
    if (textarea) {
        textarea.value = '';
        textarea.style.height = 'auto';
        textarea.style.height = '38px'; // é‡ç½®ä¸ºæœ€å°é«˜åº¦
        showNotification('è¾“å…¥æ¡†å·²æ¸…ç©º', 'info', 1000);
    }
}

// æ¸…ç©ºèŠå¤©è®°å½•
function clearChatMessages() {
    if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰èŠå¤©è®°å½•å—ï¼Ÿ')) {
        const chatMessages = document.getElementById('chatMessages');
        if (chatMessages) {
            chatMessages.innerHTML = '';
            showNotification('èŠå¤©è®°å½•å·²æ¸…ç©º', 'info', 1500);
        }
    }
}

// é‡æ–°ç¼–è¾‘ä¸Šä¸€æ¡æ¶ˆæ¯
function recallLastMessage() {
    if (lastSentMessage) {
        const textarea = document.getElementById('messageInput');
        if (textarea) {
            textarea.value = lastSentMessage;
            textarea.focus();
            // è§¦å‘è‡ªé€‚åº”é«˜åº¦è°ƒæ•´
            textarea.dispatchEvent(new Event('input'));
            showNotification('å·²æ¢å¤ä¸Šä¸€æ¡æ¶ˆæ¯', 'info', 1000);
        }
    }
}

// æ˜¾ç¤ºå¿«æ·é”®å¸®åŠ©
function showKeyboardShortcuts() {
    const shortcuts = [
        { key: 'Enter', desc: 'å‘é€æ¶ˆæ¯' },
        { key: 'Shift + Enter', desc: 'æ¢è¡Œ' },
        { key: 'ESC', desc: 'æ¸…ç©ºè¾“å…¥æ¡†' },
        { key: 'Ctrl + L', desc: 'æ¸…ç©ºèŠå¤©è®°å½•' },
        { key: 'Ctrl + K', desc: 'èšç„¦åˆ°è¾“å…¥æ¡†' },
        { key: 'â†‘ (ç©ºè¾“å…¥æ¡†æ—¶)', desc: 'æ¢å¤ä¸Šä¸€æ¡æ¶ˆæ¯' },
        { key: 'F1', desc: 'æ˜¾ç¤ºæ­¤å¸®åŠ©' }
    ];
    
    let helpText = 'ğŸ¯ èŠå¤©å¿«æ·é”®å¸®åŠ©\n\n';
    shortcuts.forEach(shortcut => {
        helpText += `${shortcut.key.padEnd(20)} - ${shortcut.desc}\n`;
    });
    
    alert(helpText);
}

// å¢å¼ºsendMessageå‡½æ•°ï¼Œè®°å½•æœ€åå‘é€çš„æ¶ˆæ¯
const originalSendMessage = window.sendMessage;
if (typeof originalSendMessage === 'function') {
    window.sendMessage = function() {
        const textarea = document.getElementById('messageInput');
        if (textarea && textarea.value.trim()) {
            lastSentMessage = textarea.value.trim();
        }
        return originalSendMessage.apply(this, arguments);
    };
}

// å…¨å±€é”®ç›˜äº‹ä»¶ç›‘å¬ï¼ˆç”¨äºå¤„ç†F1ç­‰å…¨å±€å¿«æ·é”®ï¼‰
document.addEventListener('keydown', function(e) {
    // F1 æ˜¾ç¤ºå¸®åŠ©
    if (e.key === 'F1') {
        e.preventDefault();
        showKeyboardShortcuts();
    }
    // Ctrl+K èšç„¦åˆ°è¾“å…¥æ¡†ï¼ˆå…¨å±€ï¼‰
    else if (e.ctrlKey && e.key === 'k') {
        e.preventDefault();
        const textarea = document.getElementById('messageInput');
        if (textarea) {
            textarea.focus();
            showNotification('å·²èšç„¦åˆ°è¾“å…¥æ¡†', 'info', 800);
        }
    }
});

// æ˜¾ç¤ºé€šçŸ¥å‡½æ•°ï¼ˆå¦‚æœä¸å­˜åœ¨çš„è¯ï¼‰
if (typeof showNotification !== 'function') {
    function showNotification(message, type = 'info', duration = 3000) {
        // åˆ›å»ºé€šçŸ¥å…ƒç´ 
        const notification = document.createElement('div');
        notification.className = `alert alert-${type} notification-toast`;
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 250px;
            opacity: 0;
            transition: opacity 0.3s ease;
        `;
        notification.textContent = message;
        
        document.body.appendChild(notification);
        
        // æ˜¾ç¤ºåŠ¨ç”»
        setTimeout(() => {
            notification.style.opacity = '1';
        }, 10);
        
        // è‡ªåŠ¨éšè—
        setTimeout(() => {
            notification.style.opacity = '0';
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 300);
        }, duration);
    }
}
</script>
{% endblock %}
