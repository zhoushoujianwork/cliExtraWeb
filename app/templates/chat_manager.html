{% extends "base.html" %}

{% block title %}Q Chat ç®¡ç†å™¨{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/unified.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/image_paste.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/rich_text.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/conversation.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/wechat_chat.css') }}">
<!-- Highlight.js æ ·å¼ -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
<!-- xterm.js æ ·å¼ -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css">
<style>
.three-column-layout {
    display: flex;
    height: calc(100vh - 120px);
    gap: 0;
    position: relative;
}

.left-panel {
    width: 280px;
    min-width: 200px;
    max-width: 500px;
    overflow: auto;
    flex-shrink: 0;
}

.center-panel {
    flex: 1;
    min-width: 300px;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.right-panel {
    width: 300px;
    min-width: 200px;
    max-width: 450px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    flex-shrink: 0;
    height: 100%;
}

.resize-handle {
    width: 4px;
    background: #e9ecef;
    cursor: col-resize;
    position: relative;
    flex-shrink: 0;
    transition: background-color 0.2s;
}

.resize-handle:hover {
    background: #007bff;
}

.resize-handle:active {
    background: #0056b3;
}

.resize-handle::before {
    content: '';
    position: absolute;
    top: 0;
    left: -2px;
    right: -2px;
    bottom: 0;
    background: transparent;
}

.chat-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    height: 100%;
}

.chat-container.card {
    height: 100%;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    margin: 0; /* ç§»é™¤é»˜è®¤margin */
    display: flex;
    flex-direction: column;
}

.chat-container .card-header {
    flex-shrink: 0; /* é˜²æ­¢headerè¢«å‹ç¼© */
    border-bottom: 1px solid #dee2e6;
}

.chat-input-area {
    flex-shrink: 0; /* é˜²æ­¢è¾“å…¥åŒºåŸŸè¢«å‹ç¼© */
}

.chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 0;
    /* ç§»é™¤å›ºå®šé«˜åº¦ï¼Œä½¿ç”¨flexå¸ƒå±€è‡ªåŠ¨è®¡ç®— */
    min-height: 0; /* å…è®¸flex itemç¼©å° */
}

.chat-input-area {
    border-top: 1px solid #dee2e6;
    padding: 10px 15px 15px 15px;
    background: white;
}

/* èŠå¤©å·¥å…·æ æ ·å¼ */
.chat-toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
    padding: 4px 0;
}

.toolbar-left,
.toolbar-right {
    display: flex;
    gap: 4px;
}

/* å·¥å…·æ å°å›¾æ ‡æŒ‰é’® */
.toolbar-btn {
    width: 28px;
    height: 28px;
    border: 1px solid #e0e0e0;
    background: #f8f9fa;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 12px;
    color: #666;
}

.toolbar-btn:hover {
    background: #e9ecef;
    border-color: #007bff;
    color: #007bff;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,123,255,0.2);
}

.toolbar-btn:active {
    transform: translateY(0);
    box-shadow: 0 1px 2px rgba(0,123,255,0.3);
}

.toolbar-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

/* è¾“å…¥æ¡†åŒ…è£…å™¨ */
.input-wrapper {
    position: relative;
    display: flex;
    align-items: flex-end;
    gap: 8px;
}

/* å‘é€æŒ‰é’®æ ·å¼ */
.send-btn {
    width: 36px;
    height: 36px;
    border: none;
    background: #007bff;
    color: white;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 14px;
    flex-shrink: 0;
}

.send-btn:hover {
    background: #0056b3;
    transform: translateY(-1px);
    box-shadow: 0 3px 8px rgba(0,123,255,0.3);
}

.send-btn:active {
    transform: translateY(0);
    box-shadow: 0 1px 3px rgba(0,123,255,0.4);
}

.send-btn:disabled {
    background: #6c757d;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

/* è‡ªé€‚åº” textarea æ ·å¼ */
.auto-resize-textarea {
    resize: none;
    overflow: hidden;
    min-height: 36px;
    max-height: 120px;
    line-height: 1.4;
    transition: height 0.1s ease;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 8px 12px;
    flex: 1;
}

.auto-resize-textarea:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.25);
    outline: none;
}



.terminal-container {
    flex: 1;
    background: #000;
    border-radius: 5px;
    overflow: hidden;
    height: calc(100vh - 200px); /* ä¸èŠå¤©è®°å½•é«˜åº¦ä¸€è‡´ */
    min-height: 400px;
}

.terminal-header {
    background: #333;
    color: white;
    padding: 8px 12px;
    font-size: 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.terminal-body {
    height: calc(100% - 35px);
    padding: 0;
}

#terminal {
    height: 100%;
    width: 100%;
}

/* èŠå¤©ç›¸å…³æ ·å¼ */
.message-bubble {
    max-width: 80%;
    word-wrap: break-word;
}

.user-message .message-bubble {
    margin-left: auto;
}

.instance-message .message-bubble {
    margin-right: auto;
}

.instance-suggestions {
    border: 1px solid #dee2e6;
    background: white;
    border-radius: 4px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.suggestion-item {
    cursor: pointer;
    transition: background-color 0.2s;
}

.suggestion-item:hover {
    background-color: #f8f9fa;
}

.suggestion-item:last-child {
    border-bottom: none !important;
}

.message-time {
    font-size: 0.75rem;
}
</style>
{% endblock %}

{% block content %}
<!-- é¡¶éƒ¨æ§åˆ¶æ  -->
<div class="mb-3">
    <div class="d-flex justify-content-between align-items-center p-2 bg-light rounded">
        <h4 class="mb-0"><i class="fas fa-comments"></i> Q Chat ç®¡ç†å™¨</h4>
        <div class="d-flex align-items-center gap-2">
            <!-- Namespaceé€‰æ‹©å™¨ -->
            <div class="d-flex align-items-center">
                <label class="form-label mb-0 me-2 small">Namespace:</label>
                <select id="currentNamespaceSelect" class="form-select form-select-sm" style="width: 150px;" onchange="switchNamespace()">
                    <!-- namespaceé€‰é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                </select>
                <div class="btn-group ms-2">
                    <button class="btn btn-sm btn-outline-success" onclick="showCreateNamespaceModal()" title="æ–°å»º Namespace">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="showDeleteNamespaceModal()" title="åˆ é™¤å½“å‰ Namespace">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            <div class="vr"></div>
            <button class="btn btn-sm btn-info" onclick="window.open('/workflow', '_blank')" title="Workflow ç®¡ç†">
                <i class="fas fa-project-diagram"></i> Workflow
            </button>
            <button class="btn btn-sm btn-primary" onclick="manualRefresh()">
                <i class="fas fa-refresh"></i> åˆ·æ–°
            </button>
        </div>
    </div>
</div>

<!-- ä¸‰æ å¸ƒå±€ -->
<div class="three-column-layout">
    <!-- å·¦ä¾§ï¼šå®ä¾‹ç®¡ç† -->
    <div class="left-panel">
        <div class="card h-100 d-flex flex-column">
            <div class="card-header d-flex justify-content-between align-items-center flex-shrink-0">
                <h5 class="mb-0"><i class="fas fa-server"></i> Q CLI å®ä¾‹</h5>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-success" onclick="createInstance()" title="åˆ›å»ºæ–°å®ä¾‹">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button class="btn btn-danger" onclick="cleanAllInstances()" title="æ¸…ç†æ‰€æœ‰å®ä¾‹">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            <div class="card-body flex-grow-1 overflow-auto p-2">
                <div id="instancesList">
                    <!-- å®ä¾‹åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                </div>
            </div>
        </div>
    </div>

    <!-- å·¦å³åˆ†å‰²çº¿ -->
    <div class="resize-handle" id="leftResizer"></div>

    <!-- ä¸­é—´ï¼šç»ˆç«¯è¾“å‡º -->
    <div class="center-panel">
        <div class="card h-100">
            <div class="terminal-header">
                <span><i class="fas fa-terminal"></i> ç»ˆç«¯è¾“å‡º (åªè¯»)</span>
                <div>
                    <button class="btn btn-sm btn-outline-light" onclick="clearTerminal()" title="æ¸…ç©ºç»ˆç«¯">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            <div class="terminal-body">
                <div id="terminal"></div>
            </div>
        </div>
    </div>

    <!-- ä¸­å³åˆ†å‰²çº¿ -->
    <div class="resize-handle" id="rightResizer"></div>

    <!-- å³ä¾§ï¼šèŠå¤©åŒºåŸŸ -->
    <div class="right-panel">
        <div class="card chat-container">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-comments"></i> èŠå¤©è®°å½•</h5>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary" onclick="refreshChatCache()" title="åˆ·æ–°å†å²è®°å½•ç¼“å­˜">
                        <i class="fas fa-sync-alt"></i> åˆ·æ–°ç¼“å­˜
                    </button>
                    <button class="btn btn-outline-secondary" onclick="clearChatHistory()" title="æ¸…ç©ºå½“å‰æ˜¾ç¤ºçš„èŠå¤©è®°å½•">
                        <i class="fas fa-trash"></i> æ¸…ç©º
                    </button>
                </div>
            </div>
            <div class="chat-messages wechat-chat-container" id="chatMessages">
                <!-- èŠå¤©æ¶ˆæ¯å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
            </div>
            <div class="chat-input-area">
                <!-- å¿«æ·æŒ‰é’®å·¥å…·æ  -->
                <div class="chat-toolbar">
                    <div class="toolbar-left">
                        <button class="toolbar-btn" onclick="sendMessage()" title="å‘é€æ¶ˆæ¯ (Enter)">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                        <button class="toolbar-btn" onclick="undoLastMessage()" title="æ’¤é”€ä¸Šä¸€æ¡æ¶ˆæ¯">
                            <i class="fas fa-undo"></i>
                        </button>
                        <button class="toolbar-btn" onclick="clearMessageInput()" title="æ¸…ç©ºè¾“å…¥æ¡† (ESC)">
                            <i class="fas fa-eraser"></i>
                        </button>
                        <button class="toolbar-btn" onclick="recallLastMessage()" title="é‡æ–°ç¼–è¾‘ä¸Šä¸€æ¡æ¶ˆæ¯ (â†‘)">
                            <i class="fas fa-history"></i>
                        </button>
                    </div>
                    <div class="toolbar-right">
                        <button class="toolbar-btn" onclick="showKeyboardShortcuts()" title="å¿«æ·é”®å¸®åŠ© (F1)">
                            <i class="fas fa-keyboard"></i>
                        </button>
                    </div>
                </div>
                
                <!-- è¾“å…¥æ¡†åŒºåŸŸ -->
                <div class="input-wrapper">
                    <textarea id="messageInput" class="form-control auto-resize-textarea" 
                             placeholder="è¾“å…¥æ¶ˆæ¯... (Enterå‘é€, Shift+Enteræ¢è¡Œ)" 
                             rows="1"></textarea>
                    <button class="send-btn" onclick="sendMessage()" title="å‘é€ (Enter)">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- æ–°å»º Namespace æ¨¡æ€æ¡† -->
<div class="modal fade" id="createNamespaceModal" tabindex="-1" aria-labelledby="createNamespaceModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createNamespaceModalLabel">
                    <i class="fas fa-plus-circle"></i> æ–°å»º Namespace
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="createNamespaceForm">
                    <div class="mb-3">
                        <label for="newNamespaceName" class="form-label">Namespace åç§°</label>
                        <input type="text" class="form-control" id="newNamespaceName" placeholder="è¯·è¾“å…¥ namespace åç§°" required>
                        <div class="form-text">
                            <i class="fas fa-info-circle"></i> 
                            åç§°åªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿å’Œè¿å­—ç¬¦ï¼Œä¸èƒ½ä¸ºç©º
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="newNamespaceDescription" class="form-label">æè¿° (å¯é€‰)</label>
                        <textarea class="form-control" id="newNamespaceDescription" rows="3" placeholder="è¯·è¾“å…¥ namespace çš„ç”¨é€”æè¿°"></textarea>
                    </div>
                    <div class="alert alert-info">
                        <i class="fas fa-lightbulb"></i>
                        <strong>æç¤ºï¼š</strong>æ–°å»ºçš„ namespace å°†ç”¨äºéš”ç¦»ä¸åŒé¡¹ç›®æˆ–ç¯å¢ƒçš„ Q CLI å®ä¾‹ã€‚
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-success" onclick="createNamespace()">
                    <i class="fas fa-plus"></i> åˆ›å»º
                </button>
            </div>
        </div>
    </div>
</div>

<!-- æ–°å»ºå®ä¾‹æ¨¡æ€æ¡† -->
<div class="modal fade" id="createInstanceModal" tabindex="-1" aria-labelledby="createInstanceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createInstanceModalLabel">
                    <i class="fas fa-plus-circle"></i> æ–°å»º Q CLI å®ä¾‹
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="createInstanceForm">
                    <!-- Namespace é€‰æ‹© -->
                    <div class="mb-3">
                        <label for="instanceNamespace" class="form-label">Namespace</label>
                        <select class="form-select" id="instanceNamespace" required>
                            <!-- é€‰é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                        </select>
                        <div class="form-text">
                            <i class="fas fa-info-circle"></i> 
                            é€‰æ‹©å®ä¾‹æ‰€å±çš„ namespace
                        </div>
                    </div>
                    
                    <!-- å®ä¾‹åç§° -->
                    <div class="mb-3">
                        <label for="instanceName" class="form-label">å®ä¾‹åç§°</label>
                        <input type="text" class="form-control" id="instanceName" placeholder="è¯·è¾“å…¥å®ä¾‹åç§° (å¯é€‰)" >
                        <div class="form-text">
                            <i class="fas fa-info-circle"></i> 
                            ç•™ç©ºå°†è‡ªåŠ¨ç”Ÿæˆåç§°
                        </div>
                    </div>
                    
                    <!-- è§’è‰²é€‰æ‹© -->
                    <div class="mb-3">
                        <label for="instanceRole" class="form-label">å®ä¾‹è§’è‰²</label>
                        <select class="form-select" id="instanceRole" required>
                            <option value="">è¯·é€‰æ‹©è§’è‰²</option>
                            <option value="fullstack">å…¨æ ˆå·¥ç¨‹å¸ˆ</option>
                            <option value="frontend">å‰ç«¯å·¥ç¨‹å¸ˆ</option>
                            <option value="backend">åç«¯å·¥ç¨‹å¸ˆ</option>
                            <option value="devops">è¿ç»´å·¥ç¨‹å¸ˆ</option>
                            <option value="test">æµ‹è¯•å·¥ç¨‹å¸ˆ</option>
                            <option value="reviewer">ä»£ç å®¡æŸ¥å·¥ç¨‹å¸ˆ</option>
                        </select>
                        <div class="form-text">
                            <i class="fas fa-user-tag"></i> 
                            é€‰æ‹©å®ä¾‹çš„ä¸“ä¸šè§’è‰²
                        </div>
                    </div>
                    
                    <!-- å·¥ä½œç›®å½•ç±»å‹ -->
                    <div class="mb-3">
                        <label class="form-label">å·¥ä½œç›®å½•</label>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="pathType" id="localPath" value="local" checked>
                                    <label class="form-check-label" for="localPath">
                                        <i class="fas fa-folder"></i> æœ¬åœ°è·¯å¾„
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="pathType" id="gitPath" value="git">
                                    <label class="form-check-label" for="gitPath">
                                        <i class="fab fa-git-alt"></i> Git åœ°å€
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- è·¯å¾„è¾“å…¥ -->
                    <div class="mb-3">
                        <label for="instancePath" class="form-label">è·¯å¾„</label>
                        <input type="text" class="form-control" id="instancePath" placeholder="è¯·è¾“å…¥æœ¬åœ°è·¯å¾„æˆ–Gitåœ°å€" required>
                        <div class="form-text" id="pathHelpText">
                            <i class="fas fa-info-circle"></i> 
                            è¯·è¾“å…¥æœ¬åœ°ç›®å½•çš„ç»å¯¹è·¯å¾„
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-lightbulb"></i>
                        <strong>æç¤ºï¼š</strong>æ–°å»ºçš„å®ä¾‹å°†åœ¨æŒ‡å®šçš„ namespace ä¸­è¿è¡Œï¼Œä½¿ç”¨é€‰å®šçš„è§’è‰²é…ç½®ã€‚
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-success" onclick="createInstanceFromModal()">
                    <i class="fas fa-plus"></i> åˆ›å»ºå®ä¾‹
                </button>
            </div>
        </div>
    </div>
</div>

<!-- åˆ é™¤ Namespace ç¡®è®¤æ¨¡æ€æ¡† -->
<div class="modal fade" id="deleteNamespaceModal" tabindex="-1" aria-labelledby="deleteNamespaceModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteNamespaceModalLabel">
                    <i class="fas fa-exclamation-triangle"></i> åˆ é™¤ Namespace
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <i class="fas fa-warning"></i>
                    <strong>è­¦å‘Šï¼š</strong>æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼
                </div>
                <p>æ‚¨ç¡®å®šè¦åˆ é™¤ namespace <strong id="deleteNamespaceName"></strong> å—ï¼Ÿ</p>
                <p>åˆ é™¤åå°†ä¼šï¼š</p>
                <ul>
                    <li>åœæ­¢è¯¥ namespace ä¸‹çš„æ‰€æœ‰å®ä¾‹</li>
                    <li>æ¸…ç†ç›¸å…³çš„é…ç½®å’Œæ•°æ®æ–‡ä»¶</li>
                    <li>æ— æ³•æ¢å¤å·²åˆ é™¤çš„æ•°æ®</li>
                </ul>
                <div class="mb-3">
                    <label for="confirmDeleteInput" class="form-label">
                        è¯·è¾“å…¥ <code id="confirmDeleteText"></code> æ¥ç¡®è®¤åˆ é™¤ï¼š
                    </label>
                    <input type="text" class="form-control" id="confirmDeleteInput" placeholder="è¾“å…¥ namespace åç§°ç¡®è®¤">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn" onclick="deleteNamespace()" disabled>
                    <i class="fas fa-trash"></i> ç¡®è®¤åˆ é™¤
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- XTerm.js ä¾èµ– -->
<script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>

<!-- Socket.IO -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>

<!-- ç®€åŒ–çš„å®ä¾‹æ“ä½œ -->
<script src="{{ url_for('static', filename='js/simple_instance_ops.js') }}"></script>

<!-- å®Œæ•´çš„å®ä¾‹æ“ä½œåŠŸèƒ½ -->
<script src="{{ url_for('static', filename='js/instance_operations.js') }}"></script>

<!-- ç®€åŒ–çš„namespaceç®¡ç† -->
<script src="{{ url_for('static', filename='js/simple_namespace.js') }}"></script>

<!-- ç»ˆç«¯è®°å¿†åŠŸèƒ½ -->
<script src="{{ url_for('static', filename='js/terminal_memory.js') }}"></script>

<!-- èŠå¤©åŠŸèƒ½ -->
<script src="{{ url_for('static', filename='js/chat_functionality.js') }}"></script>

<!-- å¯è°ƒæ•´å¤§å°çš„é¢æ¿ -->
<script src="{{ url_for('static', filename='js/resizable_panels.js') }}"></script>

<!-- å›¾ç‰‡ç²˜è´´åŠŸèƒ½ -->
<script src="{{ url_for('static', filename='js/image_paste.js') }}"></script>

<script>
// å…¨å±€å˜é‡
let term;
let fitAddon;
let socket;
let currentMonitoringInstance = null;

// åˆå§‹åŒ–Socket.IO
function initSocket() {
    socket = io();
    
    socket.on('terminal_output', function(data) {
        if (term && data.instance_id === currentMonitoringInstance) {
            // å¤„ç†è¾“å‡ºæ•°æ®ï¼Œç¡®ä¿æ­£ç¡®æ˜¾ç¤º
            let output = data.data;
            if (typeof output === 'string' && output.length > 0) {
                // ç›´æ¥å†™å…¥ç»ˆç«¯ï¼Œxterm.jsä¼šå¤„ç†ANSIåºåˆ—
                term.write(output);
            }
        }
    });
    
    socket.on('terminal_error', function(data) {
        if (term) {
            term.write('\r\n\x1b[31mError: ' + data.error + '\x1b[0m\r\n');
        }
        console.error('Terminal error:', data);
    });
    
    socket.on('terminal_status', function(data) {
        console.log('Terminal status:', data);
        if (data.status === 'started' && data.log_file) {
            term.write('\r\n\x1b[36mMonitoring log file: ' + data.log_file + '\x1b[0m\r\n');
        }
    });
}

// åˆå§‹åŒ–ç»ˆç«¯
function initTerminal() {
    window.term = new Terminal({
        theme: {
            background: '#000000',
            foreground: '#ffffff',
            cursor: '#ffffff',
            selection: '#ffffff',
            black: '#000000',
            red: '#cd0000',
            green: '#00cd00',
            yellow: '#cdcd00',
            blue: '#0000ee',
            magenta: '#cd00cd',
            cyan: '#00cdcd',
            white: '#e5e5e5',
            brightBlack: '#7f7f7f',
            brightRed: '#ff0000',
            brightGreen: '#00ff00',
            brightYellow: '#ffff00',
            brightBlue: '#5c5cff',
            brightMagenta: '#ff00ff',
            brightCyan: '#00ffff',
            brightWhite: '#ffffff'
        },
        fontSize: 13,
        fontFamily: 'Monaco, Menlo, "Ubuntu Mono", "Courier New", monospace',
        cursorBlink: false,  // åªè¯»æ¨¡å¼ï¼Œä¸éœ€è¦å…‰æ ‡é—ªçƒ
        cursorStyle: 'block',
        scrollback: 10000,
        tabStopWidth: 4,
        convertEol: true,
        allowTransparency: false,
        bellSound: null,
        bellStyle: 'none',
        disableStdin: true  // ç¦ç”¨è¾“å…¥ï¼Œåªè¯»æ¨¡å¼
    });
    
    window.fitAddon = new FitAddon.FitAddon();
    window.term.loadAddon(window.fitAddon);
    
    window.term.open(document.getElementById('terminal'));
    window.fitAddon.fit();
    
    // ç›‘å¬çª—å£å¤§å°å˜åŒ–
    window.addEventListener('resize', () => {
        setTimeout(() => window.fitAddon.fit(), 100);
    });
    
    // æ£€æŸ¥æ˜¯å¦æœ‰ä¸Šæ¬¡é€‰æ‹©çš„å®ä¾‹
    const lastSelected = window.terminalMemory ? window.terminalMemory.getLastSelectedInstance() : null;
    
    if (lastSelected) {
        // æ˜¾ç¤ºæ¢å¤ä¿¡æ¯
        window.term.writeln('\x1b[32mWelcome to Q Chat Terminal Monitor (Read-Only)\x1b[0m');
        window.term.writeln('\x1b[36mRestoring last selected instance...\x1b[0m\r\n');
    } else {
        // æ˜¾ç¤ºé»˜è®¤æ¬¢è¿ä¿¡æ¯
        window.term.writeln('\x1b[32mWelcome to Q Chat Terminal Monitor (Read-Only)\x1b[0m');
        window.term.writeln('Select an instance to start monitoring its output...\r\n');
    }
    
    // ä½¿ç”¨å…¨å±€å˜é‡ä»¥ä¾¿å…¶ä»–å‡½æ•°è®¿é—®
    term = window.term;
    fitAddon = window.fitAddon;
}

// å¼€å§‹ç›‘æ§å®ä¾‹
function startMonitoring(instanceId) {
    if (currentMonitoringInstance) {
        stopMonitoring();
    }
    
    currentMonitoringInstance = instanceId;
    term.clear();
    term.writeln('\x1b[33mStarting to monitor instance: ' + instanceId + '\x1b[0m');
    term.writeln('\x1b[36mLooking for log file...\x1b[0m\r\n');
    
    // é€šè¿‡WebSocketå¼€å§‹ç›‘æ§
    socket.emit('start_terminal_monitoring', {instance_id: instanceId});
}

// åœæ­¢ç›‘æ§
function stopMonitoring() {
    if (currentMonitoringInstance) {
        socket.emit('stop_terminal_monitoring', {instance_id: currentMonitoringInstance});
        currentMonitoringInstance = null;
        term.writeln('\r\n\x1b[31mMonitoring stopped\x1b[0m');
    }
}

// æ¸…ç©ºç»ˆç«¯
function clearTerminal() {
    if (term) {
        term.clear();
        if (currentMonitoringInstance) {
            term.writeln(`\x1b[33mç›‘æ§å®ä¾‹: ${currentMonitoringInstance}\x1b[0m\r\n`);
        }
    }
}

// åŠ è½½å®ä¾‹åˆ—è¡¨ - æ›´æ–°ä¸ºä½¿ç”¨namespaceåŠŸèƒ½
function loadInstances() {
    // ä½¿ç”¨namespaceç®¡ç†å™¨çš„å‡½æ•°
    if (typeof loadInstancesWithNamespace === 'function') {
        loadInstancesWithNamespace();
    } else {
        // å¤‡ç”¨æ–¹æ¡ˆ
        fetch('/api/instances')
            .then(response => response.json())
            .then(data => {
                updateInstancesList(data.instances || []);
            })
            .catch(error => {
                console.error('åŠ è½½å®ä¾‹å¤±è´¥:', error);
            });
    }
}

// åœæ­¢å®ä¾‹
function stopInstance(instanceId) {
    if (confirm(`ç¡®å®šè¦åœæ­¢å®ä¾‹ ${instanceId} å—ï¼Ÿ`)) {
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        const button = event.target.closest('button');
        if (button) {
            const originalContent = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            button.disabled = true;
        }
        
        fetch(`/api/stop/${instanceId}`, {method: 'POST'})
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(`å®ä¾‹ ${instanceId} å·²åœæ­¢`, 'success');
                    loadInstances();
                    if (currentMonitoringInstance === instanceId) {
                        stopMonitoring();
                    }
                } else {
                    showNotification(`åœæ­¢å®ä¾‹å¤±è´¥: ${data.error}`, 'error');
                }
                
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                if (button) {
                    button.innerHTML = '<i class="fas fa-stop"></i>';
                    button.disabled = false;
                }
            })
            .catch(error => {
                console.error('åœæ­¢å®ä¾‹å¤±è´¥:', error);
                showNotification(`åœæ­¢å®ä¾‹å¤±è´¥: ${error.message}`, 'error');
                
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                if (button) {
                    button.innerHTML = '<i class="fas fa-stop"></i>';
                    button.disabled = false;
                }
            });
    }
}

// æ‰‹åŠ¨åˆ·æ–°
function manualRefresh() {
    if (typeof loadInstancesWithNamespace === 'function') {
        loadInstancesWithNamespace();
    }
}

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    initSocket();
    initTerminal();
    initAutoResizeTextarea();
    initToolbar(); // åˆå§‹åŒ–å·¥å…·æ 
    
    // æ·»åŠ è·¯å¾„ç±»å‹åˆ‡æ¢ç›‘å¬å™¨
    const localPathRadio = document.getElementById('localPath');
    const gitPathRadio = document.getElementById('gitPath');
    if (localPathRadio && gitPathRadio) {
        localPathRadio.addEventListener('change', updatePathHelpText);
        gitPathRadio.addEventListener('change', updatePathHelpText);
    }
    
    // namespaceç®¡ç†å™¨ä¼šè‡ªåŠ¨åŠ è½½å®ä¾‹
    // å®šæœŸåˆ·æ–°å®ä¾‹åˆ—è¡¨
    setInterval(() => {
        if (typeof loadInstancesWithNamespace === 'function') {
            loadInstancesWithNamespace();
        }
    }, 5000);
});

// åˆå§‹åŒ–è‡ªé€‚åº” textarea
function initAutoResizeTextarea() {
    const textarea = document.getElementById('messageInput');
    if (!textarea) return;
    
    // è‡ªé€‚åº”é«˜åº¦å‡½æ•°
    function autoResize() {
        textarea.style.height = 'auto';
        textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
    }
    
    // ç›‘å¬è¾“å…¥äº‹ä»¶
    textarea.addEventListener('input', autoResize);
    
    // ç›‘å¬é”®ç›˜äº‹ä»¶
    textarea.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            if (e.shiftKey) {
                // Shift+Enter æ¢è¡Œï¼Œä¸åšä»»ä½•å¤„ç†
                return;
            } else {
                // Enter å‘é€æ¶ˆæ¯
                e.preventDefault();
                sendMessage();
            }
        } else if (e.key === 'Escape') {
            // ESC æ¸…ç©ºè¾“å…¥æ¡†
            e.preventDefault();
            clearMessageInput();
        } else if (e.ctrlKey && e.key === 'l') {
            // Ctrl+L æ¸…ç©ºèŠå¤©è®°å½•
            e.preventDefault();
            clearChatMessages();
        } else if (e.ctrlKey && e.key === 'k') {
            // Ctrl+K å¿«é€Ÿèšç„¦åˆ°è¾“å…¥æ¡†
            e.preventDefault();
            textarea.focus();
        } else if (e.key === 'ArrowUp' && textarea.value === '') {
            // ä¸Šç®­å¤´é”®ï¼šé‡æ–°ç¼–è¾‘ä¸Šä¸€æ¡æ¶ˆæ¯ï¼ˆå½“è¾“å…¥æ¡†ä¸ºç©ºæ—¶ï¼‰
            e.preventDefault();
            recallLastMessage();
        } else if (e.key === 'ArrowDown' && textarea.value !== '') {
            // ä¸‹ç®­å¤´é”®ï¼šä¸‹ä¸€æ¡å†å²æ¶ˆæ¯
            e.preventDefault();
            recallNextMessage();
        } else if (e.ctrlKey && e.key >= '1' && e.key <= '9') {
            // Ctrl+æ•°å­—é”®ï¼šæ’å…¥å¿«é€Ÿæ–‡æœ¬
            e.preventDefault();
            insertQuickText(parseInt(e.key));
        } else if (e.key === 'F1' || (e.ctrlKey && e.key === '/')) {
            // F1 æˆ– Ctrl+/ æ˜¾ç¤ºå¿«æ·é”®å¸®åŠ©
            e.preventDefault();
            showKeyboardShortcuts();
        }
    });
    
    // åˆå§‹è°ƒæ•´
    autoResize();
}

// å®ä¾‹ç®¡ç†åŠŸèƒ½
function createInstance() {
    showCreateInstanceModal();
}

function showCreateInstanceModal() {
    // åŠ è½½å½“å‰namespaceåˆ°é€‰æ‹©å™¨
    loadNamespacesForInstance();
    
    // è®¾ç½®é»˜è®¤å€¼
    const currentNs = getCurrentNamespace() || 'default';
    document.getElementById('instanceNamespace').value = currentNs;
    document.getElementById('instanceName').value = '';
    document.getElementById('instanceRole').value = '';
    document.getElementById('instancePath').value = '';
    document.getElementById('localPath').checked = true;
    updatePathHelpText();
    
    // æ˜¾ç¤ºæ¨¡æ€æ¡†
    const modal = new bootstrap.Modal(document.getElementById('createInstanceModal'));
    modal.show();
}

function loadNamespacesForInstance() {
    fetch('/api/namespaces')
        .then(response => response.json())
        .then(data => {
            const select = document.getElementById('instanceNamespace');
            select.innerHTML = '';
            
            if (data.success && data.namespaces) {
                data.namespaces.forEach(ns => {
                    const option = document.createElement('option');
                    option.value = ns.name;
                    option.textContent = ns.name;
                    select.appendChild(option);
                });
            }
        })
        .catch(error => {
            console.error('åŠ è½½namespaceåˆ—è¡¨å¤±è´¥:', error);
        });
}

function updatePathHelpText() {
    const isLocal = document.getElementById('localPath').checked;
    const helpText = document.getElementById('pathHelpText');
    const pathInput = document.getElementById('instancePath');
    
    if (isLocal) {
        helpText.innerHTML = '<i class="fas fa-info-circle"></i> è¯·è¾“å…¥æœ¬åœ°ç›®å½•çš„ç»å¯¹è·¯å¾„';
        pathInput.placeholder = 'ä¾‹å¦‚: /Users/username/project';
    } else {
        helpText.innerHTML = '<i class="fas fa-info-circle"></i> è¯·è¾“å…¥Gitä»“åº“åœ°å€';
        pathInput.placeholder = 'ä¾‹å¦‚: https://github.com/user/repo.git';
    }
}

async function createInstanceFromModal() {
    const namespace = document.getElementById('instanceNamespace').value;
    const name = document.getElementById('instanceName').value.trim();
    const role = document.getElementById('instanceRole').value;
    const path = document.getElementById('instancePath').value.trim();
    const isLocal = document.getElementById('localPath').checked;
    
    // éªŒè¯å¿…å¡«å­—æ®µ
    if (!namespace) {
        alert('è¯·é€‰æ‹© namespace');
        return;
    }
    
    if (!role) {
        alert('è¯·é€‰æ‹©å®ä¾‹è§’è‰²');
        return;
    }
    
    if (!path) {
        alert('è¯·è¾“å…¥è·¯å¾„');
        return;
    }
    
    try {
        const requestData = {
            namespace: namespace,
            role: role,
            path: path,
            path_type: isLocal ? 'local' : 'git'
        };
        
        if (name) {
            requestData.name = name;
        }
        
        const response = await fetch('/api/start-with-config', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            // å…³é—­æ¨¡æ€æ¡†
            const modal = bootstrap.Modal.getInstance(document.getElementById('createInstanceModal'));
            modal.hide();
            
            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            showNotification(`å®ä¾‹åˆ›å»ºæˆåŠŸ: ${result.instance_id}`, 'success');
            
            // é‡æ–°åŠ è½½å®ä¾‹åˆ—è¡¨
            loadInstancesWithNamespace();
        } else {
            alert('åˆ›å»ºå®ä¾‹å¤±è´¥: ' + result.error);
        }
    } catch (error) {
        console.error('åˆ›å»ºå®ä¾‹å¤±è´¥:', error);
        alert('åˆ›å»ºå®ä¾‹å¤±è´¥: ' + error.message);
    }
}
function showCreateNamespaceModal() {
    // æ¸…ç©ºè¡¨å•
    document.getElementById('newNamespaceName').value = '';
    document.getElementById('newNamespaceDescription').value = '';
    
    // æ˜¾ç¤ºæ¨¡æ€æ¡†
    const modal = new bootstrap.Modal(document.getElementById('createNamespaceModal'));
    modal.show();
}

function showDeleteNamespaceModal() {
    const currentNs = getCurrentNamespace();
    if (!currentNs) {
        alert('æ— æ³•åˆ é™¤é»˜è®¤ namespace');
        return;
    }
    
    // è®¾ç½®è¦åˆ é™¤çš„ namespace åç§°
    document.getElementById('deleteNamespaceName').textContent = currentNs;
    document.getElementById('confirmDeleteText').textContent = currentNs;
    document.getElementById('confirmDeleteInput').value = '';
    document.getElementById('confirmDeleteBtn').disabled = true;
    
    // ç›‘å¬ç¡®è®¤è¾“å…¥
    const confirmInput = document.getElementById('confirmDeleteInput');
    confirmInput.oninput = function() {
        const confirmBtn = document.getElementById('confirmDeleteBtn');
        confirmBtn.disabled = this.value !== currentNs;
    };
    
    // æ˜¾ç¤ºæ¨¡æ€æ¡†
    const modal = new bootstrap.Modal(document.getElementById('deleteNamespaceModal'));
    modal.show();
}

async function createNamespace() {
    const nameInput = document.getElementById('newNamespaceName');
    const descInput = document.getElementById('newNamespaceDescription');
    
    const name = nameInput.value.trim();
    const description = descInput.value.trim();
    
    if (!name) {
        alert('è¯·è¾“å…¥ namespace åç§°');
        nameInput.focus();
        return;
    }
    
    // éªŒè¯åç§°æ ¼å¼
    if (!/^[a-zA-Z0-9_-]+$/.test(name)) {
        alert('Namespace åç§°åªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿å’Œè¿å­—ç¬¦');
        nameInput.focus();
        return;
    }
    
    try {
        const response = await fetch('/api/namespaces', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                name: name,
                description: description
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // å…³é—­æ¨¡æ€æ¡†
            const modal = bootstrap.Modal.getInstance(document.getElementById('createNamespaceModal'));
            modal.hide();
            
            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            showNotification(`Namespace "${name}" åˆ›å»ºæˆåŠŸ`, 'success');
            
            // é‡æ–°åŠ è½½ namespace åˆ—è¡¨
            loadNamespaces().then(() => {
                // åˆ‡æ¢åˆ°æ–°åˆ›å»ºçš„ namespace
                currentNamespace = name;
                window.currentNamespace = name;
                storeNamespace(name);
                
                // æ›´æ–°é€‰æ‹©å™¨
                const select = document.getElementById('currentNamespaceSelect');
                if (select) {
                    select.value = name;
                }
                
                // é‡æ–°åŠ è½½å®ä¾‹åˆ—è¡¨
                loadInstancesWithNamespace();
            });
        } else {
            alert(`åˆ›å»ºå¤±è´¥: ${result.error}`);
        }
    } catch (error) {
        console.error('åˆ›å»º namespace å¤±è´¥:', error);
        alert(`åˆ›å»ºå¤±è´¥: ${error.message}`);
    }
}

async function deleteNamespace() {
    const nameToDelete = document.getElementById('deleteNamespaceName').textContent;
    
    try {
        const response = await fetch(`/api/namespaces/${nameToDelete}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (result.success) {
            // å…³é—­æ¨¡æ€æ¡†
            const modal = bootstrap.Modal.getInstance(document.getElementById('deleteNamespaceModal'));
            modal.hide();
            
            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            showNotification(`Namespace "${nameToDelete}" åˆ é™¤æˆåŠŸ`, 'success');
            
            // åˆ‡æ¢åˆ°é»˜è®¤ namespace
            currentNamespace = '';
            window.currentNamespace = '';
            storeNamespace('');
            
            // é‡æ–°åŠ è½½ namespace åˆ—è¡¨å’Œå®ä¾‹åˆ—è¡¨
            loadNamespaces().then(() => {
                loadInstancesWithNamespace();
            });
        } else {
            alert(`åˆ é™¤å¤±è´¥: ${result.error}`);
        }
    } catch (error) {
        console.error('åˆ é™¤ namespace å¤±è´¥:', error);
        alert(`åˆ é™¤å¤±è´¥: ${error.message}`);
    }
}

// å¿«æ·é”®åŠŸèƒ½å‡½æ•°
let lastSentMessage = ''; // å­˜å‚¨ä¸Šä¸€æ¡å‘é€çš„æ¶ˆæ¯

// æ¸…ç©ºè¾“å…¥æ¡†
function clearMessageInput() {
    const textarea = document.getElementById('messageInput');
    if (textarea) {
        textarea.value = '';
        textarea.style.height = 'auto';
        textarea.style.height = '38px'; // é‡ç½®ä¸ºæœ€å°é«˜åº¦
        showNotification('è¾“å…¥æ¡†å·²æ¸…ç©º', 'info', 1000);
    }
}

// æ¸…ç©ºèŠå¤©è®°å½•
function clearChatMessages() {
    if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰èŠå¤©è®°å½•å—ï¼Ÿ')) {
        const chatMessages = document.getElementById('chatMessages');
        if (chatMessages) {
            chatMessages.innerHTML = '';
            showNotification('èŠå¤©è®°å½•å·²æ¸…ç©º', 'info', 1500);
        }
    }
}

// é‡æ–°ç¼–è¾‘ä¸Šä¸€æ¡æ¶ˆæ¯
function recallLastMessage() {
    if (lastSentMessage) {
        const textarea = document.getElementById('messageInput');
        if (textarea) {
            textarea.value = lastSentMessage;
            textarea.focus();
            // è§¦å‘è‡ªé€‚åº”é«˜åº¦è°ƒæ•´
            textarea.dispatchEvent(new Event('input'));
            showNotification('å·²æ¢å¤ä¸Šä¸€æ¡æ¶ˆæ¯', 'info', 1000);
        }
    }
}

// æ˜¾ç¤ºå¿«æ·é”®å¸®åŠ©
function showKeyboardShortcuts() {
    const shortcuts = [
        { key: 'Enter', desc: 'å‘é€æ¶ˆæ¯' },
        { key: 'Shift + Enter', desc: 'æ¢è¡Œ' },
        { key: 'ESC', desc: 'æ¸…ç©ºè¾“å…¥æ¡†' },
        { key: 'Ctrl + L', desc: 'æ¸…ç©ºèŠå¤©è®°å½•' },
        { key: 'Ctrl + K', desc: 'èšç„¦åˆ°è¾“å…¥æ¡†' },
        { key: 'â†‘ (ç©ºè¾“å…¥æ¡†æ—¶)', desc: 'æ¢å¤ä¸Šä¸€æ¡æ¶ˆæ¯' },
        { key: 'F1', desc: 'æ˜¾ç¤ºæ­¤å¸®åŠ©' }
    ];
    
    let helpText = 'ğŸ¯ èŠå¤©å¿«æ·é”®å¸®åŠ©\n\n';
    shortcuts.forEach(shortcut => {
        helpText += `${shortcut.key.padEnd(20)} - ${shortcut.desc}\n`;
    });
    
    alert(helpText);
}

// å¢å¼ºsendMessageå‡½æ•°ï¼Œè®°å½•æœ€åå‘é€çš„æ¶ˆæ¯
const originalSendMessage = window.sendMessage;
if (typeof originalSendMessage === 'function') {
    window.sendMessage = function() {
        const textarea = document.getElementById('messageInput');
        if (textarea && textarea.value.trim()) {
            lastSentMessage = textarea.value.trim();
        }
        return originalSendMessage.apply(this, arguments);
    };
}

// å…¨å±€é”®ç›˜äº‹ä»¶ç›‘å¬ï¼ˆç”¨äºå¤„ç†F1ç­‰å…¨å±€å¿«æ·é”®ï¼‰
document.addEventListener('keydown', function(e) {
    // F1 æ˜¾ç¤ºå¸®åŠ©
    if (e.key === 'F1') {
        e.preventDefault();
        showKeyboardShortcuts();
    }
    // Ctrl+K èšç„¦åˆ°è¾“å…¥æ¡†ï¼ˆå…¨å±€ï¼‰
    else if (e.ctrlKey && e.key === 'k') {
        e.preventDefault();
        const textarea = document.getElementById('messageInput');
        if (textarea) {
            textarea.focus();
            showNotification('å·²èšç„¦åˆ°è¾“å…¥æ¡†', 'info', 800);
        }
    }
});

// æ˜¾ç¤ºé€šçŸ¥å‡½æ•°ï¼ˆå¦‚æœä¸å­˜åœ¨çš„è¯ï¼‰
if (typeof showNotification !== 'function') {
    function showNotification(message, type = 'info', duration = 3000) {
        // åˆ›å»ºé€šçŸ¥å…ƒç´ 
        const notification = document.createElement('div');
        notification.className = `alert alert-${type} notification-toast`;
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 250px;
            opacity: 0;
            transition: opacity 0.3s ease;
        `;
        notification.textContent = message;
        
        document.body.appendChild(notification);
        
        // æ˜¾ç¤ºåŠ¨ç”»
        setTimeout(() => {
            notification.style.opacity = '1';
        }, 10);
        
        // è‡ªåŠ¨éšè—
        setTimeout(() => {
            notification.style.opacity = '0';
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 300);
        }, duration);
    }
}
</script>
{% endblock %}
