{% extends "base.html" %}

{% block title %}Q Chat 管理器{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/unified.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/image_paste.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/rich_text.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/conversation.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/wechat_chat.css') }}">
<!-- Highlight.js 样式 -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
<!-- xterm.js 样式 -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css">
<style>
.three-column-layout {
    display: flex;
    height: calc(100vh - 120px);
    gap: 0;
    position: relative;
}

.left-panel {
    width: 280px;
    min-width: 200px;
    max-width: 500px;
    overflow: auto;
    flex-shrink: 0;
}

.center-panel {
    flex: 1;
    min-width: 300px;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.right-panel {
    width: 300px;
    min-width: 200px;
    max-width: 450px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    flex-shrink: 0;
}

.resize-handle {
    width: 4px;
    background: #e9ecef;
    cursor: col-resize;
    position: relative;
    flex-shrink: 0;
    transition: background-color 0.2s;
}

.resize-handle:hover {
    background: #007bff;
}

.resize-handle:active {
    background: #0056b3;
}

.resize-handle::before {
    content: '';
    position: absolute;
    top: 0;
    left: -2px;
    right: -2px;
    bottom: 0;
    background: transparent;
}

.chat-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    height: 100%;
}

.chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 15px;
    background: #f8f9fa;
    height: calc(100vh - 200px); /* 与终端高度一致 */
    min-height: 400px;
}

.chat-input-area {
    border-top: 1px solid #dee2e6;
    padding: 15px;
    background: white;
}

/* 自适应 textarea 样式 */
.auto-resize-textarea {
    resize: none;
    overflow: hidden;
    min-height: 38px;
    max-height: 120px;
    line-height: 1.4;
    transition: height 0.1s ease;
}

.chat-input-area .input-group {
    align-items: flex-end;
}

.chat-input-area .btn {
    height: fit-content;
    align-self: flex-end;
    min-height: 38px;
}

.terminal-container {
    flex: 1;
    background: #000;
    border-radius: 5px;
    overflow: hidden;
    height: calc(100vh - 200px); /* 与聊天记录高度一致 */
    min-height: 400px;
}

.terminal-header {
    background: #333;
    color: white;
    padding: 8px 12px;
    font-size: 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.terminal-body {
    height: calc(100% - 35px);
    padding: 0;
}

#terminal {
    height: 100%;
    width: 100%;
}

/* 聊天相关样式 */
.message-bubble {
    max-width: 80%;
    word-wrap: break-word;
}

.user-message .message-bubble {
    margin-left: auto;
}

.instance-message .message-bubble {
    margin-right: auto;
}

.instance-suggestions {
    border: 1px solid #dee2e6;
    background: white;
    border-radius: 4px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.suggestion-item {
    cursor: pointer;
    transition: background-color 0.2s;
}

.suggestion-item:hover {
    background-color: #f8f9fa;
}

.suggestion-item:last-child {
    border-bottom: none !important;
}

.chat-messages {
    max-height: calc(100vh - 300px);
    overflow-y: auto;
}

.message-time {
    font-size: 0.75rem;
}
</style>
{% endblock %}

{% block content %}
<!-- 顶部控制栏 -->
<div class="mb-3">
    <div class="d-flex justify-content-between align-items-center p-2 bg-light rounded">
        <h4 class="mb-0"><i class="fas fa-comments"></i> Q Chat 管理器</h4>
        <div class="d-flex align-items-center gap-2">
            <!-- Namespace选择器 -->
            <div class="d-flex align-items-center">
                <label class="form-label mb-0 me-2 small">Namespace:</label>
                <select id="currentNamespaceSelect" class="form-select form-select-sm" style="width: 150px;" onchange="switchNamespace()">
                    <!-- namespace选项将通过JavaScript动态加载 -->
                </select>
                <button class="btn btn-sm btn-outline-primary ms-1" onclick="showNamespaceManageModal()" title="管理Namespace">
                    <i class="fas fa-cog"></i>
                </button>
            </div>
            <div class="vr"></div>
            <button class="btn btn-sm btn-info" onclick="window.open('/workflow', '_blank')" title="Workflow 管理">
                <i class="fas fa-project-diagram"></i> Workflow
            </button>
            <button class="btn btn-sm btn-primary" onclick="manualRefresh()">
                <i class="fas fa-refresh"></i> 刷新
            </button>
        </div>
    </div>
</div>

<!-- 三栏布局 -->
<div class="three-column-layout">
    <!-- 左侧：实例管理 -->
    <div class="left-panel">
        <div class="card h-100 d-flex flex-column">
            <div class="card-header d-flex justify-content-between align-items-center flex-shrink-0">
                <h5 class="mb-0"><i class="fas fa-server"></i> Q CLI 实例</h5>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-success" onclick="createInstance()" title="创建新实例">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button class="btn btn-danger" onclick="cleanAllInstances()" title="清理所有实例">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            <div class="card-body flex-grow-1 overflow-auto p-2">
                <div id="instancesList">
                    <!-- 实例列表将通过JavaScript动态加载 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 左右分割线 -->
    <div class="resize-handle" id="leftResizer"></div>

    <!-- 中间：终端输出 -->
    <div class="center-panel">
        <div class="card h-100">
            <div class="terminal-header">
                <span><i class="fas fa-terminal"></i> 终端输出 (只读)</span>
                <div>
                    <button class="btn btn-sm btn-outline-light" onclick="clearTerminal()" title="清空终端">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            <div class="terminal-body">
                <div id="terminal"></div>
            </div>
        </div>
    </div>

    <!-- 中右分割线 -->
    <div class="resize-handle" id="rightResizer"></div>

    <!-- 右侧：聊天区域 -->
    <div class="right-panel">
        <div class="card chat-container">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-comments"></i> 聊天记录</h5>
            </div>
            <div class="chat-messages" id="chatMessages">
                <!-- 聊天消息将通过JavaScript动态加载 -->
            </div>
            <div class="chat-input-area">
                <div class="input-group">
                    <textarea id="messageInput" class="form-control auto-resize-textarea" placeholder="输入消息... (Shift+Enter 换行，Enter 发送)" rows="1"></textarea>
                    <button class="btn btn-primary" onclick="sendMessage()">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- XTerm.js 依赖 -->
<script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>

<!-- Socket.IO -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>

<!-- 简化的实例操作 -->
<script src="{{ url_for('static', filename='js/simple_instance_ops.js') }}"></script>

<!-- 简化的namespace管理 -->
<script src="{{ url_for('static', filename='js/simple_namespace.js') }}"></script>

<!-- 终端记忆功能 -->
<script src="{{ url_for('static', filename='js/terminal_memory.js') }}"></script>

<!-- 聊天功能 -->
<script src="{{ url_for('static', filename='js/chat_functionality.js') }}"></script>

<!-- 可调整大小的面板 -->
<script src="{{ url_for('static', filename='js/resizable_panels.js') }}"></script>

<!-- 图片粘贴功能 -->
<script src="{{ url_for('static', filename='js/image_paste.js') }}"></script>

<script>
// 全局变量
let term;
let fitAddon;
let socket;
let currentMonitoringInstance = null;

// 初始化Socket.IO
function initSocket() {
    socket = io();
    
    socket.on('terminal_output', function(data) {
        if (term && data.instance_id === currentMonitoringInstance) {
            // 处理输出数据，确保正确显示
            let output = data.data;
            if (typeof output === 'string' && output.length > 0) {
                // 直接写入终端，xterm.js会处理ANSI序列
                term.write(output);
            }
        }
    });
    
    socket.on('terminal_error', function(data) {
        if (term) {
            term.write('\r\n\x1b[31mError: ' + data.error + '\x1b[0m\r\n');
        }
        console.error('Terminal error:', data);
    });
    
    socket.on('terminal_status', function(data) {
        console.log('Terminal status:', data);
        if (data.status === 'started' && data.log_file) {
            term.write('\r\n\x1b[36mMonitoring log file: ' + data.log_file + '\x1b[0m\r\n');
        }
    });
}

// 初始化终端
function initTerminal() {
    window.term = new Terminal({
        theme: {
            background: '#000000',
            foreground: '#ffffff',
            cursor: '#ffffff',
            selection: '#ffffff',
            black: '#000000',
            red: '#cd0000',
            green: '#00cd00',
            yellow: '#cdcd00',
            blue: '#0000ee',
            magenta: '#cd00cd',
            cyan: '#00cdcd',
            white: '#e5e5e5',
            brightBlack: '#7f7f7f',
            brightRed: '#ff0000',
            brightGreen: '#00ff00',
            brightYellow: '#ffff00',
            brightBlue: '#5c5cff',
            brightMagenta: '#ff00ff',
            brightCyan: '#00ffff',
            brightWhite: '#ffffff'
        },
        fontSize: 13,
        fontFamily: 'Monaco, Menlo, "Ubuntu Mono", "Courier New", monospace',
        cursorBlink: false,  // 只读模式，不需要光标闪烁
        cursorStyle: 'block',
        scrollback: 10000,
        tabStopWidth: 4,
        convertEol: true,
        allowTransparency: false,
        bellSound: null,
        bellStyle: 'none',
        disableStdin: true  // 禁用输入，只读模式
    });
    
    window.fitAddon = new FitAddon.FitAddon();
    window.term.loadAddon(window.fitAddon);
    
    window.term.open(document.getElementById('terminal'));
    window.fitAddon.fit();
    
    // 监听窗口大小变化
    window.addEventListener('resize', () => {
        setTimeout(() => window.fitAddon.fit(), 100);
    });
    
    // 检查是否有上次选择的实例
    const lastSelected = window.terminalMemory ? window.terminalMemory.getLastSelectedInstance() : null;
    
    if (lastSelected) {
        // 显示恢复信息
        window.term.writeln('\x1b[32mWelcome to Q Chat Terminal Monitor (Read-Only)\x1b[0m');
        window.term.writeln('\x1b[36mRestoring last selected instance...\x1b[0m\r\n');
    } else {
        // 显示默认欢迎信息
        window.term.writeln('\x1b[32mWelcome to Q Chat Terminal Monitor (Read-Only)\x1b[0m');
        window.term.writeln('Select an instance to start monitoring its output...\r\n');
    }
    
    // 使用全局变量以便其他函数访问
    term = window.term;
    fitAddon = window.fitAddon;
}

// 开始监控实例
function startMonitoring(instanceId) {
    if (currentMonitoringInstance) {
        stopMonitoring();
    }
    
    currentMonitoringInstance = instanceId;
    term.clear();
    term.writeln('\x1b[33mStarting to monitor instance: ' + instanceId + '\x1b[0m');
    term.writeln('\x1b[36mLooking for log file...\x1b[0m\r\n');
    
    // 通过WebSocket开始监控
    socket.emit('start_terminal_monitoring', {instance_id: instanceId});
}

// 停止监控
function stopMonitoring() {
    if (currentMonitoringInstance) {
        socket.emit('stop_terminal_monitoring', {instance_id: currentMonitoringInstance});
        currentMonitoringInstance = null;
        term.writeln('\r\n\x1b[31mMonitoring stopped\x1b[0m');
    }
}

// 清空终端
function clearTerminal() {
    if (term) {
        term.clear();
        if (currentMonitoringInstance) {
            term.writeln(`\x1b[33m监控实例: ${currentMonitoringInstance}\x1b[0m\r\n`);
        }
    }
}

// 加载实例列表 - 更新为使用namespace功能
function loadInstances() {
    // 使用namespace管理器的函数
    if (typeof loadInstancesWithNamespace === 'function') {
        loadInstancesWithNamespace();
    } else {
        // 备用方案
        fetch('/api/instances')
            .then(response => response.json())
            .then(data => {
                updateInstancesList(data.instances || []);
            })
            .catch(error => {
                console.error('加载实例失败:', error);
            });
    }
}

// 停止实例
function stopInstance(instanceId) {
    if (confirm(`确定要停止实例 ${instanceId} 吗？`)) {
        fetch(`/api/instances/${instanceId}/stop`, {method: 'POST'})
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadInstances();
                    if (currentMonitoringInstance === instanceId) {
                        stopMonitoring();
                    }
                } else {
                    alert('停止实例失败: ' + data.error);
                }
            });
    }
}

// 手动刷新
function manualRefresh() {
    if (typeof loadInstancesWithNamespace === 'function') {
        loadInstancesWithNamespace();
    }
}

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
    initSocket();
    initTerminal();
    initAutoResizeTextarea();
    
    // namespace管理器会自动加载实例
    // 定期刷新实例列表
    setInterval(() => {
        if (typeof loadInstancesWithNamespace === 'function') {
            loadInstancesWithNamespace();
        }
    }, 5000);
});

// 初始化自适应 textarea
function initAutoResizeTextarea() {
    const textarea = document.getElementById('messageInput');
    if (!textarea) return;
    
    // 自适应高度函数
    function autoResize() {
        textarea.style.height = 'auto';
        textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
    }
    
    // 监听输入事件
    textarea.addEventListener('input', autoResize);
    
    // 监听键盘事件
    textarea.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            if (e.shiftKey) {
                // Shift+Enter 换行，不做任何处理
                return;
            } else {
                // Enter 发送消息
                e.preventDefault();
                sendMessage();
            }
        }
    });
    
    // 初始调整
    autoResize();
}
</script>
{% endblock %}
