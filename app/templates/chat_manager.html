{% extends "base.html" %}

{% block title %}Q Chat 管理器{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/unified.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/layout_fix.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/image_paste.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/rich_text.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/conversation.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/wechat_chat.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/instance-status.css') }}">
<!-- Highlight.js 样式 -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
<!-- xterm.js 样式 -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css">
<style>
.three-column-layout {
    display: flex;
    height: calc(100vh - 180px); /* 调整为适配导航栏高度 */
    gap: 0;
    position: relative;
}

.left-panel {
    width: 280px;
    min-width: 200px;
    max-width: 500px;
    overflow: auto;
    flex-shrink: 0;
}

.center-panel {
    flex: 1;
    min-width: 300px;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.right-panel {
    width: 300px;
    min-width: 200px;
    max-width: 450px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    flex-shrink: 0;
    height: 100%;
}

.resize-handle {
    width: 4px;
    background: #e9ecef;
    cursor: col-resize;
    position: relative;
    flex-shrink: 0;
    transition: background-color 0.2s;
}

.resize-handle:hover {
    background: #007bff;
}

.resize-handle:active {
    background: #0056b3;
}

.resize-handle::before {
    content: '';
    position: absolute;
    top: 0;
    left: -2px;
    right: -2px;
    bottom: 0;
    background: transparent;
}

.chat-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    height: 100%;
}

.chat-container.card {
    height: 100%;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    margin: 0; /* 移除默认margin */
    display: flex;
    flex-direction: column;
}

.chat-container .card-header {
    flex-shrink: 0; /* 防止header被压缩 */
    border-bottom: 1px solid #dee2e6;
}

.chat-input-area {
    flex-shrink: 0; /* 防止输入区域被压缩 */
}

.chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 0;
    /* 支持拖拉调整高度 */
    min-height: 200px; /* 最小高度 */
    max-height: 80vh;  /* 最大高度 */
    resize: vertical;  /* 允许垂直调整大小 */
    position: relative;
}

/* 自定义拖拉手柄 */
.chat-messages::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 8px;
    background: linear-gradient(to bottom, transparent, #e9ecef);
    cursor: ns-resize;
    border-bottom: 2px solid #dee2e6;
    transition: all 0.2s ease;
}

.chat-messages:hover::after {
    background: linear-gradient(to bottom, transparent, #007bff);
    border-bottom-color: #007bff;
}

/* 拖拉时的视觉反馈 */
.chat-messages.resizing {
    user-select: none;
    transition: none;
}

.chat-messages.resizing::after {
    background: linear-gradient(to bottom, transparent, #007bff);
    border-bottom-color: #007bff;
    box-shadow: 0 2px 4px rgba(0,123,255,0.3);
}

/* 拖拉手柄样式 */
.chat-resize-handle {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 12px;
    background: linear-gradient(to bottom, transparent, #f8f9fa);
    cursor: ns-resize;
    display: flex;
    align-items: center;
    justify-content: center;
    border-top: 1px solid #dee2e6;
    transition: all 0.2s ease;
    z-index: 10;
}

.chat-resize-handle:hover {
    background: linear-gradient(to bottom, transparent, #e3f2fd);
    border-top-color: #007bff;
}

.chat-resize-handle i {
    font-size: 10px;
    color: #6c757d;
    opacity: 0.6;
    transition: all 0.2s ease;
}

.chat-resize-handle:hover i {
    color: #007bff;
    opacity: 1;
}

/* 拖拉时的手柄样式 */
.chat-messages.resizing .chat-resize-handle {
    background: linear-gradient(to bottom, transparent, #e3f2fd);
    border-top-color: #007bff;
    box-shadow: 0 2px 4px rgba(0,123,255,0.2);
}

.chat-messages.resizing .chat-resize-handle i {
    color: #007bff;
    opacity: 1;
}

.chat-input-area {
    border-top: 1px solid #dee2e6;
    padding: 10px 15px 15px 15px;
    background: white;
}

/* 聊天工具栏样式 */
.chat-toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    padding: 6px 4px;
    background: #f8f9fa;
    border-radius: 8px;
    border: 1px solid #e9ecef;
}

.toolbar-left,
.toolbar-right {
    display: flex;
    gap: 6px;
}

/* 工具栏小图标按钮 */
.toolbar-btn {
    width: 32px;
    height: 32px;
    border: 1px solid #dee2e6;
    background: white;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 13px;
    color: #495057;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
}

.toolbar-btn:hover {
    background: #007bff;
    border-color: #007bff;
    color: white;
    transform: translateY(-1px);
    box-shadow: 0 3px 6px rgba(0,123,255,0.25);
}

.toolbar-btn:active {
    transform: translateY(0);
    box-shadow: 0 1px 3px rgba(0,123,255,0.3);
}

.toolbar-btn:disabled {
    opacity: 0.4;
    cursor: not-allowed;
    transform: none;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    background: #f8f9fa;
    color: #6c757d;
}

.toolbar-btn:disabled:hover {
    background: #f8f9fa;
    border-color: #dee2e6;
    color: #6c757d;
    transform: none;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
}

/* 输入框包装器 */
.input-wrapper {
    position: relative;
    display: flex;
    align-items: flex-end;
    gap: 10px;
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 12px;
    padding: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

/* 发送按钮样式 */
.send-btn {
    width: 40px;
    height: 40px;
    border: none;
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    color: white;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 16px;
    flex-shrink: 0;
    box-shadow: 0 2px 6px rgba(0,123,255,0.3);
}

.send-btn:hover {
    background: linear-gradient(135deg, #0056b3 0%, #004085 100%);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,123,255,0.4);
}

.send-btn:active {
    transform: translateY(0);
    box-shadow: 0 2px 6px rgba(0,123,255,0.5);
}

.send-btn:disabled {
    background: #6c757d;
    cursor: not-allowed;
    transform: none;
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    opacity: 0.6;
}

/* 实例创建进度样式 */
.step-item {
    padding: 8px 0;
    border-left: 3px solid #e9ecef;
    padding-left: 15px;
    margin-bottom: 5px;
    transition: all 0.3s ease;
}

.step-item.active {
    border-left-color: #007bff;
    background-color: #f8f9fa;
}

.step-item.completed {
    border-left-color: #28a745;
}

.step-item.error {
    border-left-color: #dc3545;
}

.step-item i.fa-check {
    color: #28a745;
}

.step-item i.fa-times {
    color: #dc3545;
}

.step-item i.fa-spinner {
    color: #007bff;
}

#instanceCreationProgressModal .modal-content {
    border: none;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}

/* 按钮加载状态样式 */
.btn:disabled {
    opacity: 0.7;
    cursor: not-allowed;
}

.btn.loading {
    position: relative;
    color: transparent !important;
}

.btn.loading::after {
    content: '';
    position: absolute;
    width: 16px;
    height: 16px;
    top: 50%;
    left: 50%;
    margin-left: -8px;
    margin-top: -8px;
    border: 2px solid transparent;
    border-top-color: #ffffff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

#directoryConflictModal .btn {
    text-align: left;
}

#directoryConflictModal .btn i {
    width: 20px;
}
.auto-resize-textarea {
    resize: none;
    overflow: hidden;
    min-height: 40px;
    max-height: 120px;
    line-height: 1.5;
    transition: height 0.1s ease;
    border: none;
    border-radius: 8px;
    padding: 10px 12px;
    flex: 1;
    font-size: 14px;
    background: transparent;
}

.auto-resize-textarea:focus {
    outline: none;
    box-shadow: none;
}

.auto-resize-textarea::placeholder {
    color: #6c757d;
    font-size: 14px;
}



.terminal-container {
    flex: 1;
    background: #000;
    border-radius: 5px;
    overflow: hidden;
    height: calc(100vh - 260px); /* 调整终端高度适配导航栏 */
    min-height: 400px;
}

.terminal-header {
    background: #333;
    color: white;
    padding: 8px 12px;
    font-size: 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.terminal-header .btn {
    margin-left: 5px;
    font-size: 11px;
    padding: 2px 8px;
    transition: all 0.3s ease;
}

.terminal-header .btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

#toggle-terminal-mode {
    position: relative;
}

#toggle-terminal-mode.btn-outline-warning:hover {
    background-color: #ffc107;
    border-color: #ffc107;
    color: #212529;
}

#toggle-terminal-mode.btn-outline-success:hover {
    background-color: #28a745;
    border-color: #28a745;
    color: white;
}

.terminal-body {
    height: calc(100% - 35px);
    padding: 0;
}

#terminal {
    height: 100%;
    width: 100%;
}

/* 聊天相关样式 */
.message-bubble {
    max-width: 80%;
    word-wrap: break-word;
}

.user-message .message-bubble {
    margin-left: auto;
}

.instance-message .message-bubble {
    margin-right: auto;
}

.instance-suggestions {
    border: 1px solid #dee2e6;
    background: white;
    border-radius: 4px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.suggestion-item {
    cursor: pointer;
    transition: background-color 0.2s;
}

.suggestion-item:hover {
    background-color: #f8f9fa;
}

.suggestion-item:last-child {
    border-bottom: none !important;
}

.message-time {
    font-size: 0.75rem;
}

/* 实例列表项样式 */
.instance-item {
    transition: all 0.2s ease;
    cursor: pointer;
}

.instance-item:hover {
    background-color: #f8f9fa;
    border-color: #dee2e6;
}

/* 选中状态的实例项 */
.instance-item.instance-selected {
    background-color: #e3f2fd;
    border-color: #2196f3;
    box-shadow: 0 2px 8px rgba(33, 150, 243, 0.15);
}

.instance-item.instance-selected:hover {
    background-color: #e1f5fe;
    border-color: #1976d2;
}
</style>
{% endblock %}

{% block content %}
<!-- 顶部控制栏 -->
<div class="mb-3">
    <div class="d-flex justify-content-between align-items-center p-2 bg-light rounded">
        <h4 class="mb-0"><i class="fas fa-comments"></i> Q Chat 管理器</h4>
        <div class="d-flex align-items-center gap-2">
            <!-- Namespace选择器 -->
            <div class="d-flex align-items-center">
                <label class="form-label mb-0 me-2 small">Namespace:</label>
                <select id="currentNamespaceSelect" class="form-select form-select-sm" style="width: 150px;" onchange="switchNamespace()">
                    <!-- namespace选项将通过JavaScript动态加载 -->
                </select>
                <div class="btn-group ms-2">
                    <button class="btn btn-sm btn-outline-success" onclick="showCreateNamespaceModal()" title="新建 Namespace">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="showDeleteNamespaceModal()" title="删除当前 Namespace">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
                <!-- Namespace状态显示 -->
                <div id="namespaceStats" class="ms-3">
                    <small class="text-muted">加载中...</small>
                </div>
            </div>
            <div class="vr"></div>
            <button class="btn btn-sm btn-info" onclick="window.open('/workflow', '_blank')" title="Workflow 管理">
                <i class="fas fa-project-diagram"></i> Workflow
            </button>
            <button class="btn btn-sm btn-primary" onclick="manualRefresh()" title="刷新所有数据：实例列表、状态信息、聊天记录等">
                <i class="fas fa-refresh"></i> 刷新
            </button>
        </div>
    </div>
</div>

<!-- 三栏布局 -->
<div class="three-column-layout">
    <!-- 左侧：实例管理 -->
    <div class="left-panel">
        <div class="card h-100 d-flex flex-column">
            <div class="card-header d-flex justify-content-between align-items-center flex-shrink-0">
                <h5 class="mb-0"><i class="fas fa-server"></i> Q CLI 实例</h5>
                <div class="btn-group btn-group-sm">
                    <!-- 移除刷新按钮，统一使用右上角刷新 -->
                    <button class="btn btn-success" onclick="createInstance()" title="创建新实例">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button class="btn btn-danger" onclick="cleanAllInstances()" title="清理所有实例">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            <div class="card-body flex-grow-1 overflow-auto p-2">
                <div id="instancesList">
                    <!-- 实例列表将通过JavaScript动态加载 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 左右分割线 -->
    <div class="resize-handle" id="leftResizer"></div>

    <!-- 中间：终端输出 -->
    <div class="center-panel">
        <div class="card h-100">
            <div class="terminal-header">
                <span><i class="fas fa-terminal"></i> <span id="terminal-mode-text">终端输出 (只读)</span></span>
                <div>
                    <button id="toggle-terminal-mode" class="btn btn-sm btn-outline-warning" onclick="toggleTerminalMode()" title="切换终端模式">
                        <i class="fas fa-keyboard"></i> 交互模式
                    </button>
                    <button class="btn btn-sm btn-outline-light" onclick="clearTerminal()" title="清空终端">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            <div class="terminal-body">
                <div id="terminal"></div>
            </div>
        </div>
    </div>

    <!-- 中右分割线 -->
    <div class="resize-handle" id="rightResizer"></div>

    <!-- 右侧：聊天区域 -->
    <div class="right-panel">
        <div class="card chat-container">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-comments"></i> 聊天记录</h5>
                <div class="btn-group btn-group-sm">
                    <!-- 移除刷新缓存按钮，统一使用右上角刷新 -->
                    <button class="btn btn-outline-secondary" onclick="clearChatHistory()" title="清空当前显示的聊天记录">
                        <i class="fas fa-trash"></i> 清空
                    </button>
                </div>
            </div>
            <div class="chat-messages wechat-chat-container" id="chatMessages">
                <!-- 聊天消息将通过JavaScript动态加载 -->
            </div>
            <div class="chat-input-area">
                <!-- 快捷按钮工具栏 -->
                <div class="chat-toolbar">
                    <div class="toolbar-left">
                        <button class="toolbar-btn" onclick="sendMessage()" title="发送消息 (Enter)">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                        <button class="toolbar-btn" onclick="undoLastMessage()" title="撤销上一条消息">
                            <i class="fas fa-undo"></i>
                        </button>
                        <button class="toolbar-btn" onclick="clearMessageInput()" title="清空输入框 (ESC)">
                            <i class="fas fa-eraser"></i>
                        </button>
                        <button class="toolbar-btn" onclick="recallLastMessage()" title="重新编辑上一条消息 (↑)">
                            <i class="fas fa-history"></i>
                        </button>
                    </div>
                    <div class="toolbar-right">
                        <button class="toolbar-btn" onclick="showKeyboardShortcuts()" title="快捷键帮助 (F1)">
                            <i class="fas fa-keyboard"></i>
                        </button>
                    </div>
                </div>
                
                <!-- 输入框区域 -->
                <div class="input-wrapper">
                    <textarea id="messageInput" class="form-control auto-resize-textarea" 
                             placeholder="输入消息... (Enter发送, Shift+Enter换行)" 
                             rows="1"></textarea>
                    <button class="send-btn" onclick="sendMessage()" title="发送 (Enter)">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 新建 Namespace 模态框 -->
<div class="modal fade" id="createNamespaceModal" tabindex="-1" aria-labelledby="createNamespaceModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createNamespaceModalLabel">
                    <i class="fas fa-plus-circle"></i> 新建 Namespace
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="createNamespaceForm">
                    <div class="mb-3">
                        <label for="newNamespaceName" class="form-label">Namespace 名称</label>
                        <input type="text" class="form-control" id="newNamespaceName" placeholder="请输入 namespace 名称" required>
                        <div class="form-text">
                            <i class="fas fa-info-circle"></i> 
                            名称只能包含字母、数字、下划线和连字符，不能为空
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="newNamespaceDescription" class="form-label">描述 (可选)</label>
                        <textarea class="form-control" id="newNamespaceDescription" rows="3" placeholder="请输入 namespace 的用途描述"></textarea>
                    </div>
                    <div class="alert alert-info">
                        <i class="fas fa-lightbulb"></i>
                        <strong>提示：</strong>新建的 namespace 将用于隔离不同项目或环境的 Q CLI 实例。
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-success" onclick="createNamespace()">
                    <i class="fas fa-plus"></i> 创建
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 新建实例模态框 -->
<div class="modal fade" id="createInstanceModal" tabindex="-1" aria-labelledby="createInstanceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createInstanceModalLabel">
                    <i class="fas fa-plus-circle"></i> 新建 Q CLI 实例
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="createInstanceForm">
                    <!-- 当前 Namespace 显示 -->
                    <div class="mb-3">
                        <label class="form-label">当前 Namespace</label>
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="fas fa-layer-group"></i>
                            </span>
                            <input type="text" class="form-control" id="currentNamespaceDisplay" readonly>
                        </div>
                        <div class="form-text">
                            <i class="fas fa-info-circle"></i> 
                            实例将在当前 namespace 中创建
                        </div>
                    </div>
                    
                    <!-- 实例名称 -->
                    <div class="mb-3">
                        <label for="instanceName" class="form-label">实例名称</label>
                        <input type="text" class="form-control" id="instanceName" placeholder="请输入实例名称 (可选)" >
                        <div class="form-text">
                            <i class="fas fa-info-circle"></i> 
                            留空将自动生成名称
                        </div>
                    </div>
                    
                    <!-- 角色选择 -->
                    <div class="mb-3">
                        <label for="instanceRole" class="form-label">实例角色</label>
                        <select class="form-select" id="instanceRole">
                            <option value="">请选择角色</option>
                            <!-- 角色选项将通过JavaScript动态加载 -->
                        </select>
                        <div class="form-text">
                            <i class="fas fa-user-tag"></i> 
                            选择实例的专业角色（可选）
                        </div>
                    </div>
                    
                    <!-- 工作目录类型 -->
                    <div class="mb-3">
                        <label class="form-label">工作目录</label>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="pathType" id="localPath" value="local" checked>
                                    <label class="form-check-label" for="localPath">
                                        <i class="fas fa-folder"></i> 本地路径
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="pathType" id="gitPath" value="git">
                                    <label class="form-check-label" for="gitPath">
                                        <i class="fab fa-git-alt"></i> Git 地址
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 路径输入 -->
                    <div class="mb-3">
                        <label for="instancePath" class="form-label">路径</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="instancePath" placeholder="请输入本地路径或Git地址" required>
                            <button class="btn btn-outline-secondary" type="button" id="browsePathBtn" onclick="browsePath()" title="浏览本地目录">
                                <i class="fas fa-folder-open"></i> 浏览
                            </button>
                            <button class="btn btn-outline-warning" type="button" id="skipBrowseBtn" onclick="skipBrowseAndManualInput()" title="跳过浏览，手动输入" style="display: none;">
                                <i class="fas fa-keyboard"></i> 手动输入
                            </button>
                        </div>
                        <div class="form-text" id="pathHelpText">
                            <i class="fas fa-info-circle"></i> 
                            请输入本地目录的绝对路径
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-lightbulb"></i>
                        <strong>提示：</strong>新建的实例将在指定的 namespace 中运行，使用选定的角色配置。
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-success" onclick="createInstanceFromModal()">
                    <i class="fas fa-plus"></i> 创建实例
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 实例创建进度模态框 -->
<div class="modal fade" id="instanceCreationProgressModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-cog fa-spin"></i> 创建实例中...
                </h5>
            </div>
            <div class="modal-body text-center">
                <div class="mb-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                <div id="creationProgressText" class="mb-3">
                    正在准备创建实例...
                </div>
                <div class="progress mb-3">
                    <div id="creationProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" style="width: 0%"></div>
                </div>
                <div id="creationSteps" class="text-start">
                    <div class="step-item" id="step-validate">
                        <i class="fas fa-clock text-muted"></i> 验证参数...
                    </div>
                    <div class="step-item" id="step-clone" style="display: none;">
                        <i class="fas fa-clock text-muted"></i> 克隆Git仓库...
                    </div>
                    <div class="step-item" id="step-create">
                        <i class="fas fa-clock text-muted"></i> 创建实例...
                    </div>
                    <div class="step-item" id="step-complete">
                        <i class="fas fa-clock text-muted"></i> 完成设置...
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="cancelCreationBtn" onclick="cancelInstanceCreation()">
                    取消创建
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 目录冲突处理模态框 -->
<div class="modal fade" id="directoryConflictModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle"></i> 目录冲突
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="fas fa-folder"></i>
                    <strong>目录已存在</strong>
                </div>
                <p id="conflictDirectoryPath"></p>
                <p>该目录已经存在，请选择处理方式：</p>
                <div class="d-grid gap-2">
                    <button class="btn btn-danger" onclick="handleDirectoryConflict('delete')">
                        <i class="fas fa-trash"></i> 删除现有目录并重新创建
                    </button>
                    <button class="btn btn-primary" onclick="handleDirectoryConflict('rename')">
                        <i class="fas fa-edit"></i> 使用新名称（自动添加后缀）
                    </button>
                    <button class="btn btn-success" onclick="handleDirectoryConflict('use')">
                        <i class="fas fa-folder-open"></i> 使用现有目录
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
            </div>
        </div>
    </div>
</div>

<!-- 实例详情模态框 -->
<div class="modal fade" id="instanceDetailsModal" tabindex="-1" aria-labelledby="instanceDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="instanceDetailsModalLabel">
                    <i class="fas fa-info-circle"></i> 实例详情
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="instanceDetailsContent">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">加载中...</span>
                        </div>
                        <p class="mt-2">正在加载实例详情...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" id="saveInstanceDetailsBtn" onclick="saveInstanceDetails()" style="display: none;">
                    <i class="fas fa-save"></i> 保存修改
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="deleteNamespaceModal" tabindex="-1" aria-labelledby="deleteNamespaceModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteNamespaceModalLabel">
                    <i class="fas fa-exclamation-triangle"></i> 删除 Namespace
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <i class="fas fa-warning"></i>
                    <strong>警告：</strong>此操作不可撤销！
                </div>
                <p>您确定要删除 namespace <strong id="deleteNamespaceName"></strong> 吗？</p>
                <p>删除后将会：</p>
                <ul>
                    <li>停止该 namespace 下的所有实例</li>
                    <li>清理相关的配置和数据文件</li>
                    <li>无法恢复已删除的数据</li>
                </ul>
                <div class="mb-3">
                    <label for="confirmDeleteInput" class="form-label">
                        请输入 <code id="confirmDeleteText"></code> 来确认删除：
                    </label>
                    <input type="text" class="form-control" id="confirmDeleteInput" placeholder="输入 namespace 名称确认">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn" onclick="deleteNamespace()" disabled>
                    <i class="fas fa-trash"></i> 确认删除
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- XTerm.js 依赖 -->
<script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>

<!-- Socket.IO -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>

<!-- 简化的实例操作 -->
<script src="{{ url_for('static', filename='js/simple_instance_ops.js') }}"></script>

<!-- 完整的实例操作功能 -->
<script src="{{ url_for('static', filename='js/instance_operations.js') }}"></script>

<!-- 简化的namespace管理 -->
<script src="{{ url_for('static', filename='js/simple_namespace.js') }}"></script>

<!-- 终端记忆功能 -->
<script src="{{ url_for('static', filename='js/terminal_memory.js') }}"></script>

<!-- 实例状态管理 -->
<script src="{{ url_for('static', filename='js/instance-status.js') }}"></script>

<!-- JavaScript调试工具 -->
<script src="{{ url_for('static', filename='js/debug-helper.js') }}"></script>

<!-- 聊天功能 -->
<script src="{{ url_for('static', filename='js/chat_functionality.js') }}"></script>

<!-- 可调整大小的面板 -->
<script src="{{ url_for('static', filename='js/resizable_panels.js') }}"></script>

<!-- 图片粘贴功能 -->
<script src="{{ url_for('static', filename='js/image_paste.js') }}"></script>

<script>
// 全局变量
let term;
let fitAddon;
let socket;
let currentMonitoringInstance = null;
let isInteractiveMode = false;  // 终端模式标志

// 初始化Socket.IO
function initSocket() {
    socket = io();
    
    socket.on('terminal_output', function(data) {
        if (term && data.instance_id === currentMonitoringInstance) {
            if (isInteractiveMode && data.output) {
                // 交互模式下的输出
                term.write(data.output);
            } else if (!isInteractiveMode && data.data) {
                // 只读模式下的日志输出
                let output = data.data;
                if (typeof output === 'string' && output.length > 0) {
                    // 直接写入终端，xterm.js会处理ANSI序列
                    term.write(output);
                }
            }
        }
    });
    
    socket.on('terminal_error', function(data) {
        if (term) {
            term.write('\r\n\x1b[31mError: ' + data.error + '\x1b[0m\r\n');
        }
        console.error('Terminal error:', data);
    });
    
    socket.on('terminal_status', function(data) {
        console.log('Terminal status:', data);
        if (data.status === 'started' && data.log_file) {
            term.write('\r\n\x1b[36mMonitoring log file: ' + data.log_file + '\x1b[0m\r\n');
        }
    });
    
    // 交互终端连接成功
    socket.on('terminal_connected', function(data) {
        console.log('Interactive terminal connected:', data);
        if (term && data.instance_id === currentMonitoringInstance) {
            term.clear();
            term.write('\r\n\x1b[32m已连接到交互终端: ' + data.session_name + '\x1b[0m\r\n');
            term.write('\x1b[36m现在可以直接输入命令进行交互\x1b[0m\r\n\r\n');
            
            // 连接成功后再次调整终端大小
            setTimeout(() => {
                if (isInteractiveMode) {
                    resizeTerminal();
                }
            }, 200);
        }
    });
    
    // 交互终端断开连接
    socket.on('terminal_disconnected', function(data) {
        console.log('Interactive terminal disconnected:', data);
        if (term && data.instance_id === currentMonitoringInstance) {
            term.write('\r\n\x1b[31m交互终端已断开连接\x1b[0m\r\n');
            if (data.message) {
                term.write('\x1b[33m' + data.message + '\x1b[0m\r\n');
            }
        }
    });
}

// 初始化终端
function initTerminal() {
    window.term = new Terminal({
        theme: {
            background: '#000000',
            foreground: '#ffffff',
            cursor: '#ffffff',
            selection: '#ffffff',
            black: '#000000',
            red: '#cd0000',
            green: '#00cd00',
            yellow: '#cdcd00',
            blue: '#0000ee',
            magenta: '#cd00cd',
            cyan: '#00cdcd',
            white: '#e5e5e5',
            brightBlack: '#7f7f7f',
            brightRed: '#ff0000',
            brightGreen: '#00ff00',
            brightYellow: '#ffff00',
            brightBlue: '#5c5cff',
            brightMagenta: '#ff00ff',
            brightCyan: '#00ffff',
            brightWhite: '#ffffff'
        },
        fontSize: 13,
        fontFamily: 'Monaco, Menlo, "Ubuntu Mono", "Courier New", monospace',
        cursorBlink: false,  // 默认只读模式，不需要光标闪烁
        cursorStyle: 'block',
        scrollback: 10000,
        tabStopWidth: 4,
        convertEol: true,
        allowTransparency: false,
        bellSound: null,
        bellStyle: 'none',
        disableStdin: true  // 默认禁用输入，只读模式
    });
    
    window.fitAddon = new FitAddon.FitAddon();
    window.term.loadAddon(window.fitAddon);
    
    window.term.open(document.getElementById('terminal'));
    window.fitAddon.fit();
    
    // 监听窗口大小变化
    window.addEventListener('resize', () => {
        setTimeout(() => {
            resizeTerminal();
        }, 100);
    });
    
    // 检查是否有上次选择的实例
    const lastSelected = window.terminalMemory ? window.terminalMemory.getLastSelectedInstance() : null;
    
    if (lastSelected) {
        // 显示恢复信息
        window.term.writeln('\x1b[32mWelcome to Q Chat Terminal Monitor (Read-Only)\x1b[0m');
        window.term.writeln('\x1b[36mRestoring last selected instance...\x1b[0m\r\n');
    } else {
        // 显示默认欢迎信息
        window.term.writeln('\x1b[32mWelcome to Q Chat Terminal Monitor (Read-Only)\x1b[0m');
        window.term.writeln('Select an instance to start monitoring its output...\r\n');
    }
    
    // 使用全局变量以便其他函数访问
    term = window.term;
    fitAddon = window.fitAddon;
}

// 开始监控实例
function startMonitoring(instanceId) {
    if (currentMonitoringInstance) {
        stopMonitoring();
    }
    
    currentMonitoringInstance = instanceId;
    
    // 更新实例列表的选中状态
    if (typeof updateInstanceSelection === 'function') {
        updateInstanceSelection(instanceId);
    }
    
    // 重置为只读模式
    if (isInteractiveMode) {
        isInteractiveMode = false;
        const toggleBtn = document.getElementById('toggle-terminal-mode');
        const modeText = document.getElementById('terminal-mode-text');
        toggleBtn.innerHTML = '<i class="fas fa-keyboard"></i> 交互模式';
        toggleBtn.className = 'btn btn-sm btn-outline-warning';
        modeText.textContent = '终端输出 (只读)';
        
        // 重新配置终端为只读模式
        if (term) {
            term.options.disableStdin = true;
            term.options.cursorBlink = false;
        }
    }
    
    term.clear();
    term.writeln('\x1b[33mStarting to monitor instance: ' + instanceId + '\x1b[0m');
    term.writeln('\x1b[36mLooking for log file...\x1b[0m\r\n');
    
    // 通过WebSocket开始监控
    socket.emit('start_terminal_monitoring', {instance_id: instanceId});
}

// 停止监控
function stopMonitoring() {
    if (currentMonitoringInstance) {
        if (isInteractiveMode) {
            // 如果是交互模式，断开交互终端连接
            socket.emit('leave_terminal', {instance_id: currentMonitoringInstance});
        } else {
            // 如果是只读模式，停止日志监控
            socket.emit('stop_terminal_monitoring', {instance_id: currentMonitoringInstance});
        }
        
        // 更新实例列表的选中状态
        if (typeof updateInstanceSelection === 'function') {
            updateInstanceSelection(null);
        }
        
        currentMonitoringInstance = null;
        term.writeln('\r\n\x1b[31mMonitoring stopped\x1b[0m');
        
        // 重置模式
        if (isInteractiveMode) {
            isInteractiveMode = false;
            const toggleBtn = document.getElementById('toggle-terminal-mode');
            const modeText = document.getElementById('terminal-mode-text');
            toggleBtn.innerHTML = '<i class="fas fa-keyboard"></i> 交互模式';
            toggleBtn.className = 'btn btn-sm btn-outline-warning';
            modeText.textContent = '终端输出 (只读)';
        }
    }
}

// 切换终端模式
function toggleTerminalMode() {
    if (!currentMonitoringInstance) {
        alert('请先选择一个实例进行监控');
        return;
    }
    
    const toggleBtn = document.getElementById('toggle-terminal-mode');
    const modeText = document.getElementById('terminal-mode-text');
    
    if (isInteractiveMode) {
        // 切换到只读模式
        switchToReadOnlyMode();
        toggleBtn.innerHTML = '<i class="fas fa-keyboard"></i> 交互模式';
        toggleBtn.className = 'btn btn-sm btn-outline-warning';
        modeText.textContent = '终端输出 (只读)';
        isInteractiveMode = false;
    } else {
        // 切换到交互模式
        switchToInteractiveMode();
        toggleBtn.innerHTML = '<i class="fas fa-eye"></i> 只读模式';
        toggleBtn.className = 'btn btn-sm btn-outline-success';
        modeText.textContent = '终端交互 (可输入)';
        isInteractiveMode = true;
    }
}

// 切换到只读模式
function switchToReadOnlyMode() {
    if (currentMonitoringInstance) {
        // 断开交互终端连接
        socket.emit('leave_terminal', {instance_id: currentMonitoringInstance});
        
        // 重新配置终端为只读模式
        if (term) {
            term.options.disableStdin = true;
            term.options.cursorBlink = false;
            
            // 调整终端大小
            setTimeout(() => {
                resizeTerminal();
            }, 100);
        }
        
        // 重新开始日志监控
        setTimeout(() => {
            socket.emit('start_terminal_monitoring', {instance_id: currentMonitoringInstance});
        }, 500);
    }
}

// 切换到交互模式
function switchToInteractiveMode() {
    if (currentMonitoringInstance) {
        // 停止日志监控
        socket.emit('stop_terminal_monitoring', {instance_id: currentMonitoringInstance});
        
        // 配置终端为交互模式
        if (term) {
            term.options.disableStdin = false;
            term.options.cursorBlink = true;
            
            // 调整终端大小
            setTimeout(() => {
                resizeTerminal();
            }, 100);
            
            // 绑定输入事件
            term.onData(data => {
                if (isInteractiveMode && currentMonitoringInstance) {
                    socket.emit('terminal_input', {
                        instance_id: currentMonitoringInstance,
                        input: data
                    });
                }
            });
        }
        
        // 连接到交互终端
        setTimeout(() => {
            socket.emit('join_terminal', {
                instance_id: currentMonitoringInstance,
                session_name: getSessionName(currentMonitoringInstance)
            });
        }, 500);
    }
}

// 调整终端大小
function resizeTerminal() {
    if (window.fitAddon && term) {
        window.fitAddon.fit();
        
        const cols = term.cols;
        const rows = term.rows;
        
        console.log(`终端大小调整为: ${cols}x${rows}`);
        
        // 如果是交互模式，同步到服务器
        if (isInteractiveMode && currentMonitoringInstance) {
            socket.emit('terminal_resize', {
                instance_id: currentMonitoringInstance,
                cols: cols,
                rows: rows
            });
        }
        
        return {cols, rows};
    }
    return null;
}

// 获取实例的会话名称
function getSessionName(instanceId) {
    // 这里可以从实例列表中获取会话名称
    // 暂时使用实例ID作为会话名称
    return instanceId;
}

// 清空终端
function clearTerminal() {
    if (term) {
        term.clear();
        if (currentMonitoringInstance) {
            term.writeln(`\x1b[33m监控实例: ${currentMonitoringInstance}\x1b[0m\r\n`);
        }
    }
}

// 加载实例列表 - 更新为使用namespace功能
function loadInstances() {
    // 使用namespace管理器的函数
    if (typeof loadInstancesWithNamespace === 'function') {
        loadInstancesWithNamespace();
    } else {
        // 备用方案
        fetch('/api/instances')
            .then(response => response.json())
            .then(data => {
                updateInstancesList(data.instances || []);
            })
            .catch(error => {
                console.error('加载实例失败:', error);
            });
    }
}

// 停止实例
function stopInstance(instanceId) {
    // 检查按钮是否被禁用（实例已停止）
    const button = event.target.closest('button');
    if (button && button.disabled) {
        showNotification('实例已经停止', 'info');
        return;
    }
    
    if (confirm(`确定要停止实例 ${instanceId} 吗？`)) {
        // 显示加载状态
        if (button) {
            const originalContent = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            button.disabled = true;
        }
        
        fetch(`/api/stop/${instanceId}`, {method: 'POST'})
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(`实例 ${instanceId} 已停止`, 'success');
                    loadInstances();
                    if (currentMonitoringInstance === instanceId) {
                        stopMonitoring();
                    }
                } else {
                    showNotification(`停止实例失败: ${data.error}`, 'error');
                }
                
                // 恢复按钮状态
                if (button) {
                    button.innerHTML = '<i class="fas fa-stop"></i>';
                    button.disabled = false;
                }
            })
            .catch(error => {
                console.error('停止实例失败:', error);
                showNotification(`停止实例失败: ${error.message}`, 'error');
                
                // 恢复按钮状态
                if (button) {
                    button.innerHTML = '<i class="fas fa-stop"></i>';
                    button.disabled = false;
                }
            });
    }
}

// 统一刷新功能 - 整合所有刷新操作
function manualRefresh() {
    console.log('🔄 执行统一刷新...');
    
    // 显示刷新按钮的加载状态
    const refreshBtns = document.querySelectorAll('button[onclick="manualRefresh()"]');
    refreshBtns.forEach(btn => {
        if (btn) {
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 刷新中...';
            btn.disabled = true;
            
            // 恢复按钮状态
            setTimeout(() => {
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }, 3000);
        }
    });
    
    // 1. 刷新实例列表和状态
    console.log('📋 刷新实例列表...');
    if (typeof refreshAllPageComponents === 'function') {
        refreshAllPageComponents();
    } else if (typeof loadInstancesWithNamespace === 'function') {
        loadInstancesWithNamespace();
    } else {
        loadInstances();
    }
    
    // 2. 刷新聊天记录缓存
    console.log('💬 刷新聊天记录...');
    if (typeof refreshChatCache === 'function') {
        refreshChatCache();
    }
    
    // 3. 刷新实例状态
    console.log('📊 刷新实例状态...');
    if (typeof instanceStatusManager !== 'undefined' && instanceStatusManager) {
        instanceStatusManager.updateAllInstancesStatus();
    }
    
    // 4. 刷新namespace信息
    console.log('🏷️ 刷新namespace信息...');
    if (typeof refreshNamespaceStats === 'function') {
        refreshNamespaceStats();
    }
    
    // 5. 重新获取可用实例列表（用于@功能）
    console.log('🔗 刷新可用实例列表...');
    if (typeof updateAvailableInstances === 'function') {
        fetch('/api/instances')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateAvailableInstances(data.instances);
                }
            })
            .catch(error => console.error('刷新可用实例失败:', error));
    }
    
    // 显示统一刷新完成提示
    if (typeof showNotification === 'function') {
        showNotification('🔄 页面数据已全部刷新', 'success', 3000);
    } else {
        console.log('✅ 统一刷新完成');
    }
    
    console.log('✅ 统一刷新操作完成');
}

// 聊天记录框拖拉调整高度功能
function initChatMessagesResize() {
    const chatMessages = document.getElementById('chatMessages');
    if (!chatMessages) return;
    
    let isResizing = false;
    let startY = 0;
    let startHeight = 0;
    
    // 创建拖拉手柄
    const resizeHandle = document.createElement('div');
    resizeHandle.className = 'chat-resize-handle';
    resizeHandle.innerHTML = '<i class="fas fa-grip-lines"></i>';
    chatMessages.appendChild(resizeHandle);
    
    // 鼠标按下开始拖拉
    resizeHandle.addEventListener('mousedown', startResize);
    
    // 触摸设备支持
    resizeHandle.addEventListener('touchstart', function(e) {
        e.preventDefault();
        const touch = e.touches[0];
        startResize({
            clientY: touch.clientY,
            preventDefault: () => {}
        });
    });
    
    function startResize(e) {
        isResizing = true;
        startY = e.clientY;
        startHeight = parseInt(document.defaultView.getComputedStyle(chatMessages).height, 10);
        
        chatMessages.classList.add('resizing');
        document.body.style.cursor = 'ns-resize';
        document.body.style.userSelect = 'none';
        
        e.preventDefault();
    }
    
    // 鼠标移动调整高度
    document.addEventListener('mousemove', handleResize);
    document.addEventListener('touchmove', function(e) {
        if (!isResizing) return;
        e.preventDefault();
        const touch = e.touches[0];
        handleResize({
            clientY: touch.clientY,
            preventDefault: () => {}
        });
    });
    
    function handleResize(e) {
        if (!isResizing) return;
        
        const deltaY = e.clientY - startY;
        const newHeight = startHeight + deltaY;
        
        // 限制高度范围
        const minHeight = 200;
        const maxHeight = window.innerHeight * 0.8;
        const clampedHeight = Math.max(minHeight, Math.min(newHeight, maxHeight));
        
        chatMessages.style.height = clampedHeight + 'px';
        chatMessages.style.flex = 'none'; // 禁用flex自动调整
        
        // 保存用户设置
        localStorage.setItem('chatMessagesHeight', clampedHeight);
        
        e.preventDefault();
    }
    
    // 鼠标释放结束拖拉
    document.addEventListener('mouseup', endResize);
    document.addEventListener('touchend', endResize);
    
    function endResize() {
        if (isResizing) {
            isResizing = false;
            chatMessages.classList.remove('resizing');
            document.body.style.cursor = '';
            document.body.style.userSelect = '';
            
            // 显示调整完成提示
            if (typeof showNotification === 'function') {
                const currentHeight = parseInt(chatMessages.style.height);
                showNotification(`📏 聊天记录框高度已调整为 ${currentHeight}px`, 'info', 2000);
            }
        }
    }
    
    // 双击重置高度
    resizeHandle.addEventListener('dblclick', function() {
        chatMessages.style.height = '';
        chatMessages.style.flex = '1';
        localStorage.removeItem('chatMessagesHeight');
        
        if (typeof showNotification === 'function') {
            showNotification('📏 聊天记录框高度已重置为自动', 'info', 2000);
        }
    });
    
    // 恢复用户设置的高度
    const savedHeight = localStorage.getItem('chatMessagesHeight');
    if (savedHeight) {
        chatMessages.style.height = savedHeight + 'px';
        chatMessages.style.flex = 'none';
    }
    
    console.log('✅ 聊天记录框拖拉调整功能已初始化');
}

// Namespace切换辅助函数
function clearSelectedInstance() {
    // 清除当前选中的实例
    window.currentInstanceId = null;
    
    // 清空监控输出
    const outputDiv = document.getElementById('instanceOutput');
    if (outputDiv) {
        outputDiv.innerHTML = '';
    }
    
    // 重置监控按钮状态
    const monitorButtons = document.querySelectorAll('.monitor-btn');
    monitorButtons.forEach(btn => {
        btn.classList.remove('btn-warning');
        btn.classList.add('btn-outline-primary');
        btn.innerHTML = '<i class="fas fa-eye"></i>';
    });
}

function refreshNamespaceStats() {
    // 刷新namespace统计信息（如果页面有显示的话）
    const statsElement = document.getElementById('namespaceStats');
    if (statsElement) {
        fetch('/api/namespaces/stats')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const stats = data.stats;
                    statsElement.innerHTML = `
                        <small class="text-muted">
                            总计: ${stats.total_instances} 实例 / ${stats.total_namespaces} namespace
                        </small>
                    `;
                }
            })
            .catch(error => console.error('获取namespace统计失败:', error));
    }
}

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 页面初始化开始');
    
    // 基础初始化（这些函数应该总是存在的）
    safeCall('initSocket');
    safeCall('initTerminal');
    safeCall('initAutoResizeTextarea');
    
    // 延迟初始化（可能需要等待脚本加载）
    delayedSafeCall('initToolbar', 500, 3);
    delayedSafeCall('initInputPlaceholder', 500, 3);
    delayedSafeCall('initChatMessagesResize', 500, 3);
    
    // 添加路径类型切换监听器
    const localPathRadio = document.getElementById('localPath');
    const gitPathRadio = document.getElementById('gitPath');
    if (localPathRadio && gitPathRadio) {
        localPathRadio.addEventListener('change', updatePathHelpText);
        gitPathRadio.addEventListener('change', updatePathHelpText);
    }
    
    // 添加路径输入框的实时验证
    const pathInput = document.getElementById('instancePath');
    if (pathInput) {
        // 防抖处理，避免频繁验证
        let validateTimeout;
        
        pathInput.addEventListener('input', function() {
            // 清除之前的定时器
            if (validateTimeout) {
                clearTimeout(validateTimeout);
            }
            
            // 移除之前的验证样式
            pathInput.classList.remove('is-valid', 'is-invalid');
            
            // 如果输入为空，不进行验证
            if (!pathInput.value.trim()) {
                return;
            }
            
            // 延迟验证，避免频繁请求
            validateTimeout = setTimeout(() => {
                const isLocal = document.getElementById('localPath').checked;
                if (isLocal) {
                    validatePath();
                }
            }, 1000); // 1秒后验证
        });
        
        // 失去焦点时立即验证
        pathInput.addEventListener('blur', function() {
            if (validateTimeout) {
                clearTimeout(validateTimeout);
            }
            
            const isLocal = document.getElementById('localPath').checked;
            if (isLocal && pathInput.value.trim()) {
                validatePath();
            }
        });
    }
    
    // namespace管理器会自动加载实例
    // 移除自动刷新，改为手动刷新
    
    // 初始化namespace统计显示
    setTimeout(() => {
        if (typeof refreshNamespaceStats === 'function') {
            refreshNamespaceStats();
        }
    }, 1000);
});

// 初始化自适应 textarea
function initAutoResizeTextarea() {
    const textarea = document.getElementById('messageInput');
    if (!textarea) return;
    
    // 自适应高度函数
    function autoResize() {
        textarea.style.height = 'auto';
        textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
    }
    
    // 监听输入事件
    textarea.addEventListener('input', autoResize);
    
    // 监听键盘事件
    textarea.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            if (e.shiftKey) {
                // Shift+Enter 换行，不做任何处理
                return;
            } else {
                // Enter 发送消息
                e.preventDefault();
                sendMessage();
            }
        } else if (e.key === 'Escape') {
            // ESC 清空输入框
            e.preventDefault();
            clearMessageInput();
        } else if (e.ctrlKey && e.key === 'l') {
            // Ctrl+L 清空聊天记录
            e.preventDefault();
            clearChatMessages();
        } else if (e.ctrlKey && e.key === 'k') {
            // Ctrl+K 快速聚焦到输入框
            e.preventDefault();
            textarea.focus();
        } else if (e.key === 'ArrowUp' && textarea.value === '') {
            // 上箭头键：重新编辑上一条消息（当输入框为空时）
            e.preventDefault();
            recallLastMessage();
        } else if (e.key === 'ArrowDown' && textarea.value !== '') {
            // 下箭头键：下一条历史消息
            e.preventDefault();
            recallNextMessage();
        } else if (e.ctrlKey && e.key >= '1' && e.key <= '9') {
            // Ctrl+数字键：插入快速文本
            e.preventDefault();
            insertQuickText(parseInt(e.key));
        } else if (e.key === 'F1' || (e.ctrlKey && e.key === '/')) {
            // F1 或 Ctrl+/ 显示快捷键帮助
            e.preventDefault();
            showKeyboardShortcuts();
        }
    });
    
    // 初始调整
    autoResize();
}

// 实例管理功能
function createInstance() {
    showCreateInstanceModal();
}

function showCreateInstanceModal() {
    // 设置当前namespace显示
    const currentNs = getCurrentNamespace() || 'default';
    document.getElementById('currentNamespaceDisplay').value = currentNs;
    
    // 设置默认值
    document.getElementById('instanceName').value = '';
    document.getElementById('instanceRole').value = '';
    document.getElementById('instancePath').value = '';
    document.getElementById('localPath').checked = true;
    updatePathHelpText();
    
    // 加载角色列表
    loadAvailableRoles();
    
    // 显示模态框
    const modal = new bootstrap.Modal(document.getElementById('createInstanceModal'));
    modal.show();
}

function updatePathHelpText() {
    const isLocal = document.getElementById('localPath').checked;
    const helpText = document.getElementById('pathHelpText');
    const pathInput = document.getElementById('instancePath');
    const browseBtn = document.getElementById('browsePathBtn');
    
    if (isLocal) {
        helpText.innerHTML = '<i class="fas fa-info-circle"></i> 请输入本地目录的绝对路径，或点击"浏览"选择目录';
        pathInput.placeholder = '例如: /Users/username/project';
        browseBtn.style.display = 'block';
        browseBtn.disabled = false;
    } else {
        // 获取默认项目目录并显示完整路径
        fetch('/api/config/projects-dir')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.projects_dir) {
                    // 确保显示完整的绝对路径
                    const projectsDir = data.projects_dir;
                    helpText.innerHTML = `<i class="fas fa-info-circle"></i> 请输入Git仓库地址，将自动克隆到: <br><code style="word-break: break-all;">${projectsDir}</code>`;
                } else {
                    helpText.innerHTML = '<i class="fas fa-info-circle"></i> 请输入Git仓库地址，将自动克隆到默认项目目录';
                }
            })
            .catch(error => {
                console.error('获取项目目录失败:', error);
                helpText.innerHTML = '<i class="fas fa-info-circle"></i> 请输入Git仓库地址，将自动克隆到默认项目目录';
            });
        
        pathInput.placeholder = '例如: https://github.com/user/repo.git';
        browseBtn.style.display = 'none';
        browseBtn.disabled = true;
    }
}

// 动态加载可用角色列表
async function loadAvailableRoles() {
    const roleSelect = document.getElementById('instanceRole');
    
    try {
        // 显示加载状态
        roleSelect.innerHTML = '<option value="">加载角色列表中...</option>';
        roleSelect.disabled = true;
        
        const response = await fetch('/api/roles');
        const result = await response.json();
        
        if (result.success && result.roles) {
            // 清空现有选项
            roleSelect.innerHTML = '<option value="">请选择角色（可选）</option>';
            
            // 添加角色选项
            result.roles.forEach(role => {
                const option = document.createElement('option');
                option.value = role.name || role;
                option.textContent = role.display_name || role.name || role;
                
                // 如果有描述，添加到title属性
                if (role.description) {
                    option.title = role.description;
                }
                
                roleSelect.appendChild(option);
            });
            
            roleSelect.disabled = false;
        } else {
            // 加载失败，显示默认选项
            roleSelect.innerHTML = '<option value="">请选择角色（可选）</option>';
            roleSelect.disabled = false;
            console.warn('加载角色列表失败:', result.error);
        }
    } catch (error) {
        console.error('加载角色列表失败:', error);
        // 出错时显示默认选项
        roleSelect.innerHTML = '<option value="">请选择角色（可选）</option>';
        roleSelect.disabled = false;
    }
}

// Git URL验证
async function validateGitUrl(url) {
    try {
        const response = await fetch('/api/config/validate-git-url', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({url: url})
        });
        
        const result = await response.json();
        return result;
    } catch (error) {
        return {
            success: false,
            error: '验证Git URL失败: ' + error.message
        };
    }
}

// 增强的路径验证
async function validatePath(path, isLocal) {
    if (!path.trim()) {
        return {success: false, error: '路径不能为空'};
    }
    
    if (isLocal) {
        // 本地路径验证
        try {
            const response = await fetch('/api/validate-path', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({path: path})
            });
            return await response.json();
        } catch (error) {
            return {success: false, error: '验证本地路径失败: ' + error.message};
        }
    } else {
        // Git URL验证
        return await validateGitUrl(path);
    }
}

// 跳过浏览，直接手动输入
function skipBrowseAndManualInput() {
    // 隐藏跳过按钮
    const skipBtn = document.getElementById('skipBrowseBtn');
    if (skipBtn) {
        skipBtn.style.display = 'none';
    }
    
    // 恢复浏览按钮状态
    const browseBtn = document.getElementById('browsePathBtn');
    if (browseBtn) {
        browseBtn.innerHTML = '<i class="fas fa-folder-open"></i> 浏览';
        browseBtn.disabled = false;
    }
    
    // 聚焦到输入框
    const pathInput = document.getElementById('instancePath');
    if (pathInput) {
        pathInput.focus();
        pathInput.placeholder = '请手动输入完整的本地路径，例如：/Users/username/project';
    }
    
    // 显示手动输入提示
    showNotification('已跳过目录选择，请手动输入完整路径', 'info');
    showDirectoryInputHelper();
}

// 浏览本地路径
async function browsePath() {
    try {
        const pathInput = document.getElementById('instancePath');
        
        // 显示加载状态
        const browseBtn = document.getElementById('browsePathBtn');
        const originalBtnContent = browseBtn.innerHTML;
        browseBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 选择中...';
        browseBtn.disabled = true;
        
        // 显示跳过按钮
        const skipBtn = document.getElementById('skipBrowseBtn');
        if (skipBtn) {
            skipBtn.style.display = 'inline-block';
        }
        
        // 显示提示信息
        showNotification('正在打开目录选择对话框，请在系统对话框中选择目录...', 'info');
        
        // 调用后端API打开目录选择对话框，增加超时时间到6分钟
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 360000); // 6分钟超时
        
        const response = await fetch('/api/directory/select', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        const result = await response.json();
        
        if (result.success) {
            // 设置完整的绝对路径
            pathInput.value = result.path;
            
            // 显示成功提示
            showNotification(`已选择目录: ${result.directory_name}`, 'success');
            
            // 自动验证路径
            await validatePath();
            
        } else {
            if (result.cancelled) {
                // 用户取消选择，显示温和提示
                showNotification('已取消目录选择', 'info');
            } else if (result.timeout) {
                // 超时处理
                showNotification('目录选择超时，请重试或手动输入路径', 'warning');
                showDirectoryInputHelper();
            } else if (result.unsupported) {
                // 系统不支持
                showNotification('系统不支持目录选择对话框，请手动输入路径', 'warning');
                showDirectoryInputHelper();
            } else {
                // 其他错误
                showNotification(`选择目录失败: ${result.error}`, 'error');
            }
        }
        
    } catch (error) {
        if (error.name === 'AbortError') {
            // 前端超时
            showNotification('目录选择超时，请重试或手动输入路径', 'warning');
        } else {
            console.error('浏览目录失败:', error);
            showNotification('浏览目录失败: ' + error.message, 'error');
        }
        
        // 降级方案：显示手动输入提示
        showDirectoryInputHelper();
        
    } finally {
        // 恢复按钮状态
        const browseBtn = document.getElementById('browsePathBtn');
        if (browseBtn) {
            browseBtn.innerHTML = originalBtnContent;
            browseBtn.disabled = false;
        }
        
        // 隐藏跳过按钮
        const skipBtn = document.getElementById('skipBrowseBtn');
        if (skipBtn) {
            skipBtn.style.display = 'none';
        }
    }
}

// 验证路径并自动转换为绝对路径
async function validatePath() {
    const pathInput = document.getElementById('instancePath');
    const path = pathInput.value.trim();
    
    if (!path) return;
    
    try {
        const response = await fetch('/api/directory/validate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ path: path })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // 如果输入的不是绝对路径，自动更新为绝对路径
            if (pathInput.value !== result.path) {
                pathInput.value = result.path;
                showNotification('路径已转换为绝对路径', 'info');
            }
            
            // 移除错误样式
            pathInput.classList.remove('is-invalid');
            pathInput.classList.add('is-valid');
            
        } else {
            // 显示错误样式
            pathInput.classList.remove('is-valid');
            pathInput.classList.add('is-invalid');
            
            // 如果有建议路径，可以选择使用
            if (result.suggested_path && result.suggested_path !== path) {
                const useAbsPath = confirm(`路径验证失败: ${result.error}\n\n是否使用绝对路径: ${result.suggested_path}?`);
                if (useAbsPath) {
                    pathInput.value = result.suggested_path;
                    // 重新验证
                    setTimeout(() => validatePath(), 100);
                }
            }
        }
        
    } catch (error) {
        console.error('验证路径失败:', error);
        pathInput.classList.remove('is-valid');
        pathInput.classList.add('is-invalid');
    }
}

// 显示目录输入帮助
function showDirectoryInputHelper() {
    const helpModal = document.createElement('div');
    helpModal.className = 'modal fade';
    helpModal.innerHTML = `
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-folder-open"></i> 目录路径输入帮助
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>目录选择对话框无法使用，请手动输入目录路径</strong>
                    </div>
                    
                    <h6><i class="fas fa-keyboard"></i> 输入格式示例：</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-primary">绝对路径：</h6>
                            <ul class="list-unstyled">
                                <li><code>/Users/username/Documents/project</code></li>
                                <li><code>/home/user/workspace/myapp</code></li>
                                <li><code>/opt/projects/webapp</code></li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-success">快捷符号：</h6>
                            <ul class="list-unstyled">
                                <li><code>~</code> - 用户主目录</li>
                                <li><code>~/Documents</code> - 文档目录</li>
                                <li><code>.</code> - 当前目录</li>
                                <li><code>../</code> - 上级目录</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="alert alert-success">
                        <i class="fas fa-magic"></i>
                        <strong>智能功能：</strong>输入路径后会自动验证并转换为绝对路径
                    </div>
                    
                    <h6><i class="fas fa-tools"></i> 快速操作：</h6>
                    <div class="d-grid gap-2 d-md-flex justify-content-md-start">
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="fillHomeDirectory()" data-bs-dismiss="modal">
                            <i class="fas fa-home"></i> 使用主目录
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="fillCurrentDirectory()" data-bs-dismiss="modal">
                            <i class="fas fa-folder"></i> 使用当前目录
                        </button>
                        <button type="button" class="btn btn-outline-info btn-sm" onclick="fillDocumentsDirectory()" data-bs-dismiss="modal">
                            <i class="fas fa-file-alt"></i> 使用文档目录
                        </button>
                    </div>
                    
                    <div class="alert alert-warning mt-3">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>注意事项：</strong>
                        <ul class="mb-0 mt-2">
                            <li>确保目录存在且有读写权限</li>
                            <li>路径中不要包含特殊字符</li>
                            <li>可以重新点击"浏览"按钮再次尝试</li>
                        </ul>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> 关闭
                    </button>
                    <button type="button" class="btn btn-primary" onclick="retryBrowsePath()" data-bs-dismiss="modal">
                        <i class="fas fa-redo"></i> 重新尝试浏览
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(helpModal);
    const modal = new bootstrap.Modal(helpModal);
    modal.show();
    
    // 模态框关闭后清理
    helpModal.addEventListener('hidden.bs.modal', () => {
        document.body.removeChild(helpModal);
    });
}

// 填充主目录
function fillHomeDirectory() {
    const pathInput = document.getElementById('instancePath');
    pathInput.value = '~';
    pathInput.focus();
    // 触发验证
    setTimeout(() => validatePath(), 100);
}

// 填充当前目录
function fillCurrentDirectory() {
    const pathInput = document.getElementById('instancePath');
    pathInput.value = '.';
    pathInput.focus();
    // 触发验证
    setTimeout(() => validatePath(), 100);
}

// 填充文档目录
function fillDocumentsDirectory() {
    const pathInput = document.getElementById('instancePath');
    pathInput.value = '~/Documents';
    pathInput.focus();
    // 触发验证
    setTimeout(() => validatePath(), 100);
}

// 重新尝试浏览路径
function retryBrowsePath() {
    // 延迟一下再调用，避免模态框关闭动画冲突
    setTimeout(() => {
        browsePath();
    }, 300);
}

// 实例创建进度管理
let creationAbortController = null;
let currentConflictData = null;

function showCreationProgress() {
    const modal = new bootstrap.Modal(document.getElementById('instanceCreationProgressModal'));
    modal.show();
    
    // 重置进度
    updateCreationProgress(0, '正在准备创建实例...');
    resetCreationSteps();
}

function hideCreationProgress() {
    const modal = bootstrap.Modal.getInstance(document.getElementById('instanceCreationProgressModal'));
    if (modal) {
        modal.hide();
    }
}

function updateCreationProgress(percentage, text) {
    const progressBar = document.getElementById('creationProgressBar');
    const progressText = document.getElementById('creationProgressText');
    
    if (progressBar) {
        progressBar.style.width = percentage + '%';
    }
    
    if (progressText) {
        progressText.textContent = text;
    }
}

function updateCreationStep(stepId, status, text) {
    const stepElement = document.getElementById(stepId);
    if (!stepElement) return;
    
    stepElement.style.display = 'block';
    stepElement.className = 'step-item ' + status;
    
    const icon = stepElement.querySelector('i');
    const textSpan = stepElement.querySelector('span') || document.createElement('span');
    
    switch (status) {
        case 'active':
            icon.className = 'fas fa-spinner fa-spin text-primary';
            break;
        case 'completed':
            icon.className = 'fas fa-check text-success';
            break;
        case 'error':
            icon.className = 'fas fa-times text-danger';
            break;
        default:
            icon.className = 'fas fa-clock text-muted';
    }
    
    if (text) {
        if (!stepElement.querySelector('span')) {
            stepElement.appendChild(document.createTextNode(' '));
            stepElement.appendChild(textSpan);
        }
        textSpan.textContent = text;
    }
}

function resetCreationSteps() {
    const steps = ['step-validate', 'step-clone', 'step-create', 'step-complete'];
    steps.forEach(stepId => {
        const step = document.getElementById(stepId);
        if (step) {
            step.className = 'step-item';
            step.style.display = stepId === 'step-validate' ? 'block' : 'none';
            const icon = step.querySelector('i');
            if (icon) {
                icon.className = 'fas fa-clock text-muted';
            }
            const span = step.querySelector('span');
            if (span) {
                span.remove();
            }
        }
    });
}

function cancelInstanceCreation() {
    if (creationAbortController) {
        creationAbortController.abort();
    }
    hideCreationProgress();
    showNotification('实例创建已取消', 'info');
}

// 目录冲突处理
function showDirectoryConflictModal(conflictPath, conflictData) {
    currentConflictData = conflictData;
    
    const pathElement = document.getElementById('conflictDirectoryPath');
    if (pathElement) {
        pathElement.innerHTML = `<code>${conflictPath}</code>`;
    }
    
    const modal = new bootstrap.Modal(document.getElementById('directoryConflictModal'));
    modal.show();
}

function handleDirectoryConflict(action) {
    const modal = bootstrap.Modal.getInstance(document.getElementById('directoryConflictModal'));
    if (modal) {
        modal.hide();
    }
    
    if (!currentConflictData) {
        showNotification('处理目录冲突失败：缺少冲突数据', 'error');
        return;
    }
    
    // 根据用户选择处理冲突
    currentConflictData.conflict_resolution = action;
    
    // 继续创建实例
    continueInstanceCreation(currentConflictData);
}

async function continueInstanceCreation(requestData) {
    try {
        showCreationProgress();
        updateCreationStep('step-create', 'active', '正在创建实例...');
        updateCreationProgress(60, '正在创建实例...');
        
        const response = await fetch('/api/start-with-config', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData),
            signal: creationAbortController?.signal
        });
        
        const result = await response.json();
        
        if (result.success) {
            updateCreationStep('step-create', 'completed', '实例创建成功');
            updateCreationStep('step-complete', 'active', '完成设置...');
            updateCreationProgress(100, '实例创建完成！');
            
            setTimeout(() => {
                hideCreationProgress();
                
                // 关闭创建模态框
                const createModal = bootstrap.Modal.getInstance(document.getElementById('createInstanceModal'));
                if (createModal) {
                    createModal.hide();
                }
                
                showNotification(`实例创建成功: ${result.instance_id}`, 'success');
                loadInstancesWithNamespace();
            }, 1000);
            
        } else {
            updateCreationStep('step-create', 'error', '创建失败');
            updateCreationProgress(100, '创建失败: ' + result.error);
            
            setTimeout(() => {
                hideCreationProgress();
                alert('创建实例失败: ' + result.error);
            }, 2000);
        }
        
    } catch (error) {
        if (error.name === 'AbortError') {
            return; // 用户取消，不显示错误
        }
        
        updateCreationStep('step-create', 'error', '创建异常');
        updateCreationProgress(100, '创建异常: ' + error.message);
        
        setTimeout(() => {
            hideCreationProgress();
            alert('创建实例失败: ' + error.message);
        }, 2000);
    }
}

async function createInstanceFromModal() {
    const namespace = getCurrentNamespace() || 'default'; // 使用当前namespace
    const name = document.getElementById('instanceName').value.trim();
    const role = document.getElementById('instanceRole').value;
    const path = document.getElementById('instancePath').value.trim();
    const isLocal = document.getElementById('localPath').checked;
    
    // 验证必填字段
    if (!path) {
        alert('请输入路径');
        return;
    }
    
    // 获取创建按钮和取消按钮
    const createButton = document.querySelector('#createInstanceModal .btn-success');
    const cancelButton = document.querySelector('#createInstanceModal .btn-secondary');
    const originalButtonText = createButton.innerHTML;
    
    try {
        // 显示按钮加载状态
        createButton.disabled = true;
        cancelButton.disabled = true;
        createButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 创建中...';
        createButton.classList.add('loading');
        
        // 显示进度模态框
        showCreationProgress();
        updateCreationProgress(20, '正在准备创建实例...');
        updateCreationStep('step-validate', 'active', '验证配置信息...');
        
        const requestData = {
            namespace: namespace,
            role: role,
            path: path,
            path_type: isLocal ? 'local' : 'git'
        };
        
        if (name) {
            requestData.name = name;
        }
        
        // 更新进度
        updateCreationProgress(40, '正在发送创建请求...');
        updateCreationStep('step-validate', 'completed', '配置验证完成');
        updateCreationStep('step-create', 'active', '正在创建实例...');
        
        // 创建超时控制器，设置2分钟超时
        const controller = new AbortController();
        const timeoutId = setTimeout(() => {
            controller.abort();
            hideCreationProgress();
            showNotification('创建实例超时，请检查网络连接或重试', 'error');
            // 恢复按钮状态
            restoreButtonState();
        }, 120000); // 2分钟超时
        
        const response = await fetch('/api/start-with-config', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData),
            signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        // 更新进度
        updateCreationProgress(80, '正在处理响应...');
        
        const result = await response.json();
        
        if (result.success) {
            // 完成进度
            updateCreationProgress(100, '实例创建成功！');
            updateCreationStep('step-create', 'completed', '实例创建完成');
            updateCreationStep('step-complete', 'completed', '创建成功');
            
            // 延迟关闭进度模态框，让用户看到成功状态
            setTimeout(() => {
                hideCreationProgress();
                
                // 关闭创建模态框
                const modal = bootstrap.Modal.getInstance(document.getElementById('createInstanceModal'));
                modal.hide();
                
                // 显示成功消息
                showNotification(`实例创建成功: ${result.instance_id}`, 'success');
                
                // 重新加载实例列表
                loadInstancesWithNamespace();
                
                // 恢复按钮状态
                restoreButtonState();
            }, 1500);
            
        } else {
            // 显示错误状态
            updateCreationStep('step-create', 'error', '创建失败');
            updateCreationProgress(100, '创建失败: ' + result.error);
            
            setTimeout(() => {
                hideCreationProgress();
                alert('创建实例失败: ' + result.error);
                
                // 恢复按钮状态
                restoreButtonState();
            }, 2000);
        }
    } catch (error) {
        console.error('创建实例失败:', error);
        
        // 显示错误状态
        updateCreationStep('step-create', 'error', '创建失败');
        updateCreationProgress(100, '创建失败: ' + error.message);
        
        setTimeout(() => {
            hideCreationProgress();
            alert('创建实例失败: ' + error.message);
            
            // 恢复按钮状态
            restoreButtonState();
        }, 2000);
    }
    
    // 恢复按钮状态的辅助函数
    function restoreButtonState() {
        createButton.disabled = false;
        cancelButton.disabled = false;
        createButton.innerHTML = originalButtonText;
        createButton.classList.remove('loading');
    }
}
function showCreateNamespaceModal() {
    // 清空表单
    document.getElementById('newNamespaceName').value = '';
    document.getElementById('newNamespaceDescription').value = '';
    
    // 显示模态框
    const modal = new bootstrap.Modal(document.getElementById('createNamespaceModal'));
    modal.show();
}

function showDeleteNamespaceModal() {
    const currentNs = getCurrentNamespace();
    if (!currentNs) {
        alert('无法删除默认 namespace');
        return;
    }
    
    // 设置要删除的 namespace 名称
    document.getElementById('deleteNamespaceName').textContent = currentNs;
    document.getElementById('confirmDeleteText').textContent = currentNs;
    document.getElementById('confirmDeleteInput').value = '';
    document.getElementById('confirmDeleteBtn').disabled = true;
    
    // 监听确认输入
    const confirmInput = document.getElementById('confirmDeleteInput');
    confirmInput.oninput = function() {
        const confirmBtn = document.getElementById('confirmDeleteBtn');
        confirmBtn.disabled = this.value !== currentNs;
    };
    
    // 显示模态框
    const modal = new bootstrap.Modal(document.getElementById('deleteNamespaceModal'));
    modal.show();
}

async function createNamespace() {
    const nameInput = document.getElementById('newNamespaceName');
    const descInput = document.getElementById('newNamespaceDescription');
    
    const name = nameInput.value.trim();
    const description = descInput.value.trim();
    
    if (!name) {
        alert('请输入 namespace 名称');
        nameInput.focus();
        return;
    }
    
    // 验证名称格式
    if (!/^[a-zA-Z0-9_-]+$/.test(name)) {
        alert('Namespace 名称只能包含字母、数字、下划线和连字符');
        nameInput.focus();
        return;
    }
    
    try {
        const response = await fetch('/api/namespaces', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                name: name,
                description: description
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // 关闭模态框
            const modal = bootstrap.Modal.getInstance(document.getElementById('createNamespaceModal'));
            modal.hide();
            
            // 显示成功消息
            showNotification(`Namespace "${name}" 创建成功`, 'success');
            
            // 重新加载 namespace 列表
            loadNamespaces().then(() => {
                // 切换到新创建的 namespace
                currentNamespace = name;
                window.currentNamespace = name;
                storeNamespace(name);
                
                // 更新选择器
                const select = document.getElementById('currentNamespaceSelect');
                if (select) {
                    select.value = name;
                }
                
                // 重新加载实例列表
                loadInstancesWithNamespace();
            });
        } else {
            alert(`创建失败: ${result.error}`);
        }
    } catch (error) {
        console.error('创建 namespace 失败:', error);
        alert(`创建失败: ${error.message}`);
    }
}

async function deleteNamespace() {
    const nameToDelete = document.getElementById('deleteNamespaceName').textContent;
    
    try {
        const response = await fetch(`/api/namespaces/${nameToDelete}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (result.success) {
            // 关闭模态框
            const modal = bootstrap.Modal.getInstance(document.getElementById('deleteNamespaceModal'));
            modal.hide();
            
            // 显示成功消息
            showNotification(`Namespace "${nameToDelete}" 删除成功`, 'success');
            
            // 切换到默认 namespace
            currentNamespace = '';
            window.currentNamespace = '';
            storeNamespace('');
            
            // 重新加载 namespace 列表和实例列表
            loadNamespaces().then(() => {
                loadInstancesWithNamespace();
            });
        } else {
            alert(`删除失败: ${result.error}`);
        }
    } catch (error) {
        console.error('删除 namespace 失败:', error);
        alert(`删除失败: ${error.message}`);
    }
}

// 快捷键功能函数
let lastSentMessage = ''; // 存储上一条发送的消息

// 清空输入框
function clearMessageInput() {
    const textarea = document.getElementById('messageInput');
    if (textarea) {
        textarea.value = '';
        textarea.style.height = 'auto';
        textarea.style.height = '38px'; // 重置为最小高度
        showNotification('输入框已清空', 'info', 1000);
    }
}

// 清空聊天记录
function clearChatMessages() {
    if (confirm('确定要清空所有聊天记录吗？')) {
        const chatMessages = document.getElementById('chatMessages');
        if (chatMessages) {
            chatMessages.innerHTML = '';
            showNotification('聊天记录已清空', 'info', 1500);
        }
    }
}

// 重新编辑上一条消息
function recallLastMessage() {
    if (lastSentMessage) {
        const textarea = document.getElementById('messageInput');
        if (textarea) {
            textarea.value = lastSentMessage;
            textarea.focus();
            // 触发自适应高度调整
            textarea.dispatchEvent(new Event('input'));
            showNotification('已恢复上一条消息', 'info', 1000);
        }
    }
}

// 显示快捷键帮助
function showKeyboardShortcuts() {
    const shortcuts = [
        { key: 'Enter', desc: '发送消息' },
        { key: 'Shift + Enter', desc: '换行' },
        { key: 'ESC', desc: '清空输入框' },
        { key: 'Ctrl + L', desc: '清空聊天记录' },
        { key: 'Ctrl + K', desc: '聚焦到输入框' },
        { key: '↑ (空输入框时)', desc: '恢复上一条消息' },
        { key: 'F1', desc: '显示此帮助' }
    ];
    
    let helpText = '🎯 聊天快捷键帮助\n\n';
    shortcuts.forEach(shortcut => {
        helpText += `${shortcut.key.padEnd(20)} - ${shortcut.desc}\n`;
    });
    
    alert(helpText);
}

// 增强sendMessage函数，记录最后发送的消息
const originalSendMessage = window.sendMessage;
if (typeof originalSendMessage === 'function') {
    window.sendMessage = function() {
        const textarea = document.getElementById('messageInput');
        if (textarea && textarea.value.trim()) {
            lastSentMessage = textarea.value.trim();
        }
        return originalSendMessage.apply(this, arguments);
    };
}

// 全局键盘事件监听（用于处理F1等全局快捷键）
document.addEventListener('keydown', function(e) {
    // F1 显示帮助
    if (e.key === 'F1') {
        e.preventDefault();
        showKeyboardShortcuts();
    }
    // Ctrl+K 聚焦到输入框（全局）
    else if (e.ctrlKey && e.key === 'k') {
        e.preventDefault();
        const textarea = document.getElementById('messageInput');
        if (textarea) {
            textarea.focus();
            showNotification('已聚焦到输入框', 'info', 800);
        }
    }
});

// 显示通知函数（如果不存在的话）
if (typeof showNotification !== 'function') {
    function showNotification(message, type = 'info', duration = 3000) {
        // 创建通知元素
        const notification = document.createElement('div');
        notification.className = `alert alert-${type} notification-toast`;
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 250px;
            opacity: 0;
            transition: opacity 0.3s ease;
        `;
        notification.textContent = message;
        
        document.body.appendChild(notification);
        
        // 显示动画
        setTimeout(() => {
            notification.style.opacity = '1';
        }, 10);
        
        // 自动隐藏
        setTimeout(() => {
            notification.style.opacity = '0';
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 300);
        }, duration);
    }
}
</script>
{% endblock %}
