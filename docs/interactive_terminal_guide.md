# 交互终端使用指南

## 功能概述

Q Chat Manager 现在支持两种终端模式：

1. **只读模式** - 实时查看 cliExtra 实例的日志输出
2. **交互模式** - 直接与 cliExtra 实例进行交互，就像在本地终端一样

## 🆕 终端大小自适应

### 自动适配功能
- **模式切换时自动调整** - 切换到交互模式时自动适配终端大小
- **窗口大小变化响应** - 浏览器窗口大小变化时自动重新适配
- **服务器同步** - 终端尺寸变化会同步到服务器端的 tmux 会话
- **实时调整** - 无需手动刷新，终端大小实时响应变化

### 技术实现
```javascript
// 自动调整终端大小
function resizeTerminal() {
    if (window.fitAddon && term) {
        window.fitAddon.fit();
        
        const cols = term.cols;
        const rows = term.rows;
        
        // 如果是交互模式，同步到服务器
        if (isInteractiveMode && currentMonitoringInstance) {
            socket.emit('terminal_resize', {
                instance_id: currentMonitoringInstance,
                cols: cols,
                rows: rows
            });
        }
    }
}
```

## 使用方法

### 1. 启动监控

1. 在"Q CLI 实例"面板中选择一个运行中的实例
2. 点击"监控"按钮开始监控该实例
3. 终端会显示实例的日志输出（默认为只读模式）
4. 终端会自动适配当前窗口大小

### 2. 切换到交互模式

1. 确保已经开始监控某个实例
2. 点击终端右上角的 **"交互模式"** 按钮
3. 终端标题会变为"终端交互 (可输入)"
4. 按钮会变为绿色的 **"只读模式"**
5. **终端会自动调整大小以适配当前窗口**

### 3. 交互操作

在交互模式下，你可以：

- **直接输入命令** - 就像在本地终端一样
- **使用快捷键** - Ctrl+C、Ctrl+D 等都支持
- **查看实时输出** - 命令执行结果会实时显示
- **多行输入** - 支持复杂的命令和脚本
- **动态调整窗口** - 拖拽浏览器窗口时终端会自动适配

### 4. 切换回只读模式

1. 点击终端右上角的 **"只读模式"** 按钮
2. 终端会断开交互连接，回到日志监控模式
3. 按钮会变回黄色的 **"交互模式"**
4. **终端大小会重新适配只读模式**

## 技术实现

### 架构设计

```
浏览器终端 (xterm.js + FitAddon)
    ↕ WebSocket (包含尺寸信息)
Flask 应用 (WebSocket 处理)
    ↕ pexpect (支持动态调整)
tmux 会话 (cliExtra 实例)
```

### 大小适配流程

#### 自动适配触发时机
1. **模式切换时** - 切换到交互/只读模式
2. **连接建立后** - 交互终端连接成功
3. **窗口大小变化** - 浏览器窗口拖拽调整
4. **页面加载时** - 初始化终端时

#### 适配处理流程
1. 调用 `fitAddon.fit()` 计算最佳尺寸
2. 获取终端的 `cols` 和 `rows` 值
3. 如果是交互模式，通过 WebSocket 发送尺寸信息
4. 服务器端调用 `pexpect.setwinsize()` 调整 tmux 会话
5. 在控制台输出调整结果用于调试

### WebSocket 事件

| 事件名称 | 方向 | 说明 |
|---------|------|------|
| `join_terminal` | 客户端→服务器 | 请求连接到交互终端 |
| `leave_terminal` | 客户端→服务器 | 请求断开交互终端 |
| `terminal_input` | 客户端→服务器 | 发送用户输入 |
| `terminal_resize` | 客户端→服务器 | **发送终端尺寸变化** |
| `terminal_connected` | 服务器→客户端 | 交互终端连接成功 |
| `terminal_disconnected` | 服务器→客户端 | 交互终端已断开 |
| `terminal_output` | 服务器→客户端 | 终端输出数据 |

## 使用场景

### 1. 调试和故障排除
- 实时查看实例运行状态
- 直接执行调试命令
- 检查环境变量和配置
- **在不同窗口大小下都能获得最佳体验**

### 2. 实例管理
- 重启服务
- 更新配置
- 查看系统资源
- **支持在移动设备上进行基本管理**

### 3. 开发和测试
- 运行测试命令
- 查看日志详情
- 执行一次性任务
- **多窗口开发时自动适配不同尺寸**

## 注意事项

### 性能优化
- 终端大小调整有100ms的防抖延迟
- 只在交互模式下同步尺寸到服务器
- 大小变化会在控制台输出调试信息

### 兼容性
- 支持所有现代浏览器
- 需要 WebSocket 支持
- **移动端会自动适配屏幕尺寸**
- 最小终端尺寸：80x24

### 最佳实践
- 建议使用较大的浏览器窗口以获得更好体验
- 在交互模式下避免频繁调整窗口大小
- 如果终端显示异常，可以切换模式重新适配

## 故障排除

### 终端大小显示异常
1. 检查浏览器控制台的尺寸调整日志
2. 尝试切换终端模式重新适配
3. 刷新页面重新初始化终端

### 交互模式下输入位置不对
1. 确认终端已正确适配当前窗口
2. 检查是否有JavaScript错误
3. 尝试手动调整浏览器窗口大小

### 窗口调整后显示错乱
1. 等待100ms让防抖机制生效
2. 检查网络连接是否正常
3. 查看服务器日志中的resize事件

## 快捷键支持

| 快捷键 | 功能 |
|--------|------|
| `Ctrl+C` | 中断当前命令 |
| `Ctrl+D` | 发送 EOF |
| `Ctrl+L` | 清屏 |
| `Tab` | 自动补全 |
| `↑/↓` | 命令历史 |

## 更新日志

### v1.1.0 (最新)
- ✅ 基础交互终端功能
- ✅ 模式切换支持
- ✅ WebSocket 双向通信
- ✅ 完整的快捷键支持
- 🆕 **自动终端大小适配**
- 🆕 **窗口大小变化响应**
- 🆕 **服务器端尺寸同步**
- 🆕 **防抖优化机制**

---

**提示**: 如果遇到终端大小问题，请查看浏览器开发者工具的控制台，会有详细的尺寸调整日志信息。
