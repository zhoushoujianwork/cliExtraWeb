# 交互终端使用指南

## 功能概述

Q Chat Manager 现在支持两种终端模式：

1. **只读模式** - 实时查看 cliExtra 实例的日志输出
2. **交互模式** - 直接与 cliExtra 实例进行交互，就像在本地终端一样

## 使用方法

### 1. 启动监控

1. 在"Q CLI 实例"面板中选择一个运行中的实例
2. 点击"监控"按钮开始监控该实例
3. 终端会显示实例的日志输出（默认为只读模式）

### 2. 切换到交互模式

1. 确保已经开始监控某个实例
2. 点击终端右上角的 **"交互模式"** 按钮
3. 终端标题会变为"终端交互 (可输入)"
4. 按钮会变为绿色的 **"只读模式"**

### 3. 交互操作

在交互模式下，你可以：

- **直接输入命令** - 就像在本地终端一样
- **使用快捷键** - Ctrl+C、Ctrl+D 等都支持
- **查看实时输出** - 命令执行结果会实时显示
- **多行输入** - 支持复杂的命令和脚本

### 4. 切换回只读模式

1. 点击终端右上角的 **"只读模式"** 按钮
2. 终端会断开交互连接，回到日志监控模式
3. 按钮会变回黄色的 **"交互模式"**

## 技术实现

### 架构设计

```
浏览器终端 (xterm.js)
    ↕ WebSocket
Flask 应用 (WebSocket 处理)
    ↕ pexpect
tmux 会话 (cliExtra 实例)
```

### 模式切换流程

#### 只读模式 → 交互模式
1. 停止日志文件监控
2. 配置终端为可输入模式
3. 通过 pexpect 连接到 tmux 会话
4. 建立双向通信通道

#### 交互模式 → 只读模式
1. 断开 pexpect 连接（分离 tmux 会话）
2. 配置终端为只读模式
3. 重新开始日志文件监控

### WebSocket 事件

| 事件名称 | 方向 | 说明 |
|---------|------|------|
| `join_terminal` | 客户端→服务器 | 请求连接到交互终端 |
| `leave_terminal` | 客户端→服务器 | 请求断开交互终端 |
| `terminal_input` | 客户端→服务器 | 发送用户输入 |
| `terminal_connected` | 服务器→客户端 | 交互终端连接成功 |
| `terminal_disconnected` | 服务器→客户端 | 交互终端已断开 |
| `terminal_output` | 服务器→客户端 | 终端输出数据 |

## 使用场景

### 1. 调试和故障排除
- 实时查看实例运行状态
- 直接执行调试命令
- 检查环境变量和配置

### 2. 实例管理
- 重启服务
- 更新配置
- 查看系统资源

### 3. 开发和测试
- 运行测试命令
- 查看日志详情
- 执行一次性任务

## 注意事项

### 安全考虑
- 交互模式具有完整的终端访问权限
- 请谨慎执行可能影响系统的命令
- 建议在测试环境中使用

### 性能优化
- 同时只能有一个实例处于交互模式
- 长时间不使用会自动断开连接
- 大量输出可能影响浏览器性能

### 兼容性
- 支持所有现代浏览器
- 需要 WebSocket 支持
- 移动端体验可能有限

## 故障排除

### 无法切换到交互模式
1. 检查实例是否正在运行
2. 确认 tmux 会话存在
3. 查看浏览器控制台错误信息

### 输入无响应
1. 检查 WebSocket 连接状态
2. 尝试刷新页面重新连接
3. 检查服务器日志

### 输出显示异常
1. 检查字符编码设置
2. 清空终端重新开始
3. 尝试切换模式

## 快捷键支持

| 快捷键 | 功能 |
|--------|------|
| `Ctrl+C` | 中断当前命令 |
| `Ctrl+D` | 发送 EOF |
| `Ctrl+L` | 清屏 |
| `Tab` | 自动补全 |
| `↑/↓` | 命令历史 |

## 更新日志

### v1.0.0
- ✅ 基础交互终端功能
- ✅ 模式切换支持
- ✅ WebSocket 双向通信
- ✅ 完整的快捷键支持

---

**提示**: 如果遇到问题，请查看浏览器开发者工具的控制台和网络面板，或检查服务器日志文件。
