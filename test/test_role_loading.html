<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>角色加载功能测试</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h2>角色加载功能测试</h2>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>角色选择测试</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="instanceRole" class="form-label">实例角色</label>
                            <select class="form-select" id="instanceRole">
                                <option value="">请选择角色</option>
                                <!-- 角色选项将通过JavaScript动态加载 -->
                            </select>
                            <div class="form-text">
                                <i class="fas fa-user-tag"></i> 
                                选择实例的专业角色（可选）
                            </div>
                        </div>
                        
                        <button class="btn btn-primary" onclick="loadAvailableRoles()">
                            <i class="fas fa-refresh"></i> 重新加载角色
                        </button>
                        
                        <button class="btn btn-success" onclick="testRoleSelection()">
                            <i class="fas fa-check"></i> 测试选择
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>加载状态</h5>
                    </div>
                    <div class="card-body">
                        <div id="loadingStatus" class="alert alert-info">
                            点击"重新加载角色"开始测试
                        </div>
                        
                        <div id="roleInfo" class="mt-3">
                            <!-- 角色信息将在这里显示 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 动态加载可用角色列表
        async function loadAvailableRoles() {
            const roleSelect = document.getElementById('instanceRole');
            const statusDiv = document.getElementById('loadingStatus');
            const roleInfoDiv = document.getElementById('roleInfo');
            
            try {
                // 显示加载状态
                statusDiv.className = 'alert alert-warning';
                statusDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 正在加载角色列表...';
                roleSelect.innerHTML = '<option value="">加载角色列表中...</option>';
                roleSelect.disabled = true;
                roleInfoDiv.innerHTML = '';
                
                const response = await fetch('/api/roles');
                const result = await response.json();
                
                if (result.success && result.roles) {
                    // 清空现有选项
                    roleSelect.innerHTML = '<option value="">请选择角色（可选）</option>';
                    
                    // 添加角色选项
                    result.roles.forEach(role => {
                        const option = document.createElement('option');
                        option.value = role.name || role;
                        option.textContent = role.display_name || role.name || role;
                        
                        // 如果有描述，添加到title属性
                        if (role.description) {
                            option.title = role.description;
                        }
                        
                        roleSelect.appendChild(option);
                    });
                    
                    roleSelect.disabled = false;
                    
                    // 显示成功状态
                    statusDiv.className = 'alert alert-success';
                    statusDiv.innerHTML = `<i class="fas fa-check"></i> 成功加载 ${result.roles.length} 个角色`;
                    
                    // 显示角色信息
                    let roleInfoHtml = '<h6>可用角色列表：</h6><ul class="list-group">';
                    result.roles.forEach(role => {
                        roleInfoHtml += `
                            <li class="list-group-item d-flex justify-content-between align-items-start">
                                <div class="ms-2 me-auto">
                                    <div class="fw-bold">${role.name}</div>
                                    ${role.description}
                                </div>
                                <span class="badge bg-primary rounded-pill">${role.name}</span>
                            </li>
                        `;
                    });
                    roleInfoHtml += '</ul>';
                    roleInfoDiv.innerHTML = roleInfoHtml;
                    
                } else {
                    // 加载失败，显示默认选项
                    roleSelect.innerHTML = '<option value="">请选择角色（可选）</option>';
                    roleSelect.disabled = false;
                    
                    statusDiv.className = 'alert alert-danger';
                    statusDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i> 加载角色列表失败: ${result.error || '未知错误'}`;
                }
            } catch (error) {
                console.error('加载角色列表失败:', error);
                
                // 出错时显示默认选项
                roleSelect.innerHTML = '<option value="">请选择角色（可选）</option>';
                roleSelect.disabled = false;
                
                statusDiv.className = 'alert alert-danger';
                statusDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i> 加载角色列表失败: ${error.message}`;
            }
        }
        
        function testRoleSelection() {
            const roleSelect = document.getElementById('instanceRole');
            const selectedRole = roleSelect.value;
            const selectedText = roleSelect.options[roleSelect.selectedIndex].text;
            
            if (selectedRole) {
                alert(`选择的角色: ${selectedRole}\n显示名称: ${selectedText}`);
            } else {
                alert('未选择角色（这是允许的，因为角色现在是可选的）');
            }
        }
        
        // 页面加载时自动加载角色
        document.addEventListener('DOMContentLoaded', function() {
            loadAvailableRoles();
        });
    </script>
</body>
</html>
