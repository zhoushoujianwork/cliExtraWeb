<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®ä¾‹è¯¦æƒ…åŠŸèƒ½æµ‹è¯•</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h2>å®ä¾‹è¯¦æƒ…åŠŸèƒ½æµ‹è¯•</h2>
        <p class="text-muted">æµ‹è¯•å®ä¾‹è¯¦æƒ…Modalå’Œå·¥å…·ç¼–è¾‘åŠŸèƒ½</p>
        
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5>æ¨¡æ‹Ÿå®ä¾‹åˆ—è¡¨</h5>
                    </div>
                    <div class="card-body">
                        <!-- æ¨¡æ‹Ÿå®ä¾‹1 -->
                        <div class="instance-item mb-2 p-2 border rounded">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>cliextra_test_12345</strong>
                                    <span class="badge bg-success ms-2">Attached</span>
                                    <br><small class="text-muted">ns: default</small>
                                </div>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary" title="ç›‘æ§è¾“å‡º">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-outline-info" onclick="testShowInstanceDetails('cliextra_test_12345')" title="æŸ¥çœ‹å®ä¾‹è¯¦æƒ…">
                                        <i class="fas fa-info-circle"></i>
                                    </button>
                                    <button class="btn btn-outline-danger" title="æ¸…ç†å®ä¾‹æ•°æ®">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- æ¨¡æ‹Ÿå®ä¾‹2 -->
                        <div class="instance-item mb-2 p-2 border rounded">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>cliextra_test_67890</strong>
                                    <span class="badge bg-warning ms-2">Detached</span>
                                    <br><small class="text-muted">ns: frontend</small>
                                </div>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary" title="ç›‘æ§è¾“å‡º">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-outline-info" onclick="testShowInstanceDetails('cliextra_test_67890')" title="æŸ¥çœ‹å®ä¾‹è¯¦æƒ…">
                                        <i class="fas fa-info-circle"></i>
                                    </button>
                                    <button class="btn btn-outline-danger" title="æ¸…ç†å®ä¾‹æ•°æ®">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5>åŠŸèƒ½è¯´æ˜</h5>
                    </div>
                    <div class="card-body">
                        <h6>æ–°åŠŸèƒ½</h6>
                        <ul class="list-unstyled">
                            <li>âœ… ç§»é™¤äº†ç»ˆæ­¢æŒ‰é’®</li>
                            <li>âœ… æ–°å¢å®ä¾‹è¯¦æƒ…æŒ‰é’®</li>
                            <li>âœ… Modalæ–¹å¼æ˜¾ç¤ºè¯¦æƒ…</li>
                            <li>âœ… æ”¯æŒä¿®æ”¹toolsé…ç½®</li>
                        </ul>
                        
                        <h6>æŒ‰é’®è¯´æ˜</h6>
                        <ul class="list-unstyled">
                            <li><i class="fas fa-eye text-primary"></i> ç›‘æ§è¾“å‡º</li>
                            <li><i class="fas fa-info-circle text-info"></i> å®ä¾‹è¯¦æƒ…</li>
                            <li><i class="fas fa-trash text-danger"></i> æ¸…ç†æ•°æ®</li>
                        </ul>
                        
                        <h6>æµ‹è¯•æ­¥éª¤</h6>
                        <ol class="small">
                            <li>ç‚¹å‡»å®ä¾‹è¯¦æƒ…æŒ‰é’®</li>
                            <li>æŸ¥çœ‹å®ä¾‹åŸºæœ¬ä¿¡æ¯</li>
                            <li>ç‚¹å‡»å·¥å…·é…ç½®çš„ç¼–è¾‘æŒ‰é’®</li>
                            <li>ä¿®æ”¹å·¥å…·é€‰æ‹©</li>
                            <li>ä¿å­˜ä¿®æ”¹</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å®ä¾‹è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div class="modal fade" id="instanceDetailsModal" tabindex="-1" aria-labelledby="instanceDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="instanceDetailsModalLabel">
                        <i class="fas fa-info-circle"></i> å®ä¾‹è¯¦æƒ…
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="instanceDetailsContent">
                        <div class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">åŠ è½½ä¸­...</span>
                            </div>
                            <p class="mt-2">æ­£åœ¨åŠ è½½å®ä¾‹è¯¦æƒ…...</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                    <button type="button" class="btn btn-primary" id="saveInstanceDetailsBtn" onclick="saveInstanceDetails()" style="display: none;">
                        <i class="fas fa-save"></i> ä¿å­˜ä¿®æ”¹
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // æ¨¡æ‹Ÿå®ä¾‹æ•°æ®
        const mockInstances = {
            'cliextra_test_12345': {
                id: 'cliextra_test_12345',
                status: 'Attached',
                namespace: 'default',
                role: 'fullstack',
                project_path: '/Users/test/project1',
                created_at: '2024-01-20 10:30:00',
                tools: ['git', 'docker', 'kubectl'],
                stats: {
                    uptime: '2å°æ—¶30åˆ†é’Ÿ',
                    messages: 45,
                    memory: '256MB',
                    cpu: '15%'
                }
            },
            'cliextra_test_67890': {
                id: 'cliextra_test_67890',
                status: 'Detached',
                namespace: 'frontend',
                role: 'frontend',
                project_path: '/Users/test/project2',
                created_at: '2024-01-20 09:15:00',
                tools: ['git', 'nodejs', 'webpack'],
                stats: {
                    uptime: '0åˆ†é’Ÿ',
                    messages: 23,
                    memory: '0MB',
                    cpu: '0%'
                }
            }
        };
        
        let allInstances = Object.values(mockInstances);
        
        function testShowInstanceDetails(instanceId) {
            console.log('ğŸ” æ˜¾ç¤ºå®ä¾‹è¯¦æƒ…:', instanceId);
            
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            const modal = new bootstrap.Modal(document.getElementById('instanceDetailsModal'));
            modal.show();
            
            // é‡ç½®å†…å®¹ä¸ºåŠ è½½çŠ¶æ€
            const contentDiv = document.getElementById('instanceDetailsContent');
            contentDiv.innerHTML = `
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">åŠ è½½ä¸­...</span>
                    </div>
                    <p class="mt-2">æ­£åœ¨åŠ è½½å®ä¾‹è¯¦æƒ…...</p>
                </div>
            `;
            
            // éšè—ä¿å­˜æŒ‰é’®
            document.getElementById('saveInstanceDetailsBtn').style.display = 'none';
            
            // æ¨¡æ‹ŸAPIè°ƒç”¨å»¶è¿Ÿ
            setTimeout(() => {
                const instance = mockInstances[instanceId];
                if (instance) {
                    renderInstanceDetails(instance);
                } else {
                    showInstanceDetailsError('å®ä¾‹ä¸å­˜åœ¨');
                }
            }, 1000);
        }
        
        function renderInstanceDetails(instance) {
            const contentDiv = document.getElementById('instanceDetailsContent');
            
            // æ›´æ–°æ¨¡æ€æ¡†æ ‡é¢˜
            document.getElementById('instanceDetailsModalLabel').innerHTML = `
                <i class="fas fa-info-circle"></i> å®ä¾‹è¯¦æƒ… - ${instance.id}
            `;
            
            // æ¸²æŸ“è¯¦æƒ…å†…å®¹
            contentDiv.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fas fa-server"></i> åŸºæœ¬ä¿¡æ¯</h6>
                            </div>
                            <div class="card-body">
                                <table class="table table-sm table-borderless">
                                    <tr>
                                        <td><strong>å®ä¾‹ID:</strong></td>
                                        <td>${instance.id}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>çŠ¶æ€:</strong></td>
                                        <td>
                                            <span class="badge bg-${instance.status === 'Attached' ? 'success' : 'warning'}">
                                                ${instance.status}
                                            </span>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><strong>å‘½åç©ºé—´:</strong></td>
                                        <td>${instance.namespace || 'default'}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>è§’è‰²:</strong></td>
                                        <td>${instance.role || 'æœªè®¾ç½®'}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>é¡¹ç›®è·¯å¾„:</strong></td>
                                        <td><small class="text-muted">${instance.project_path || 'æœªè®¾ç½®'}</small></td>
                                    </tr>
                                    <tr>
                                        <td><strong>åˆ›å»ºæ—¶é—´:</strong></td>
                                        <td><small class="text-muted">${instance.created_at || 'æœªçŸ¥'}</small></td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card mb-3">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0"><i class="fas fa-tools"></i> å·¥å…·é…ç½®</h6>
                                <button class="btn btn-sm btn-outline-primary" onclick="editInstanceTools('${instance.id}')">
                                    <i class="fas fa-edit"></i> ç¼–è¾‘
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="instanceToolsList">
                                    ${renderToolsList(instance.tools || [])}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fas fa-chart-line"></i> è¿è¡Œç»Ÿè®¡</h6>
                            </div>
                            <div class="card-body">
                                <div class="row text-center">
                                    <div class="col-md-3">
                                        <div class="border rounded p-2">
                                            <div class="h5 mb-0 text-primary">${instance.stats?.uptime || '0'}</div>
                                            <small class="text-muted">è¿è¡Œæ—¶é•¿</small>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="border rounded p-2">
                                            <div class="h5 mb-0 text-success">${instance.stats?.messages || '0'}</div>
                                            <small class="text-muted">æ¶ˆæ¯æ•°é‡</small>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="border rounded p-2">
                                            <div class="h5 mb-0 text-warning">${instance.stats?.memory || '0MB'}</div>
                                            <small class="text-muted">å†…å­˜ä½¿ç”¨</small>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="border rounded p-2">
                                            <div class="h5 mb-0 text-info">${instance.stats?.cpu || '0%'}</div>
                                            <small class="text-muted">CPUä½¿ç”¨</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function renderToolsList(tools) {
            if (!tools || tools.length === 0) {
                return '<p class="text-muted mb-0">æœªå®‰è£…ä»»ä½•å·¥å…·</p>';
            }
            
            return tools.map(tool => `
                <span class="badge bg-secondary me-1 mb-1">${tool}</span>
            `).join('');
        }
        
        function showInstanceDetailsError(error) {
            const contentDiv = document.getElementById('instanceDetailsContent');
            contentDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>åŠ è½½å¤±è´¥:</strong> ${error}
                </div>
                <div class="text-center">
                    <button class="btn btn-outline-primary" onclick="location.reload()">
                        <i class="fas fa-refresh"></i> åˆ·æ–°é¡µé¢
                    </button>
                </div>
            `;
        }
        
        function editInstanceTools(instanceId) {
            console.log('ğŸ”§ ç¼–è¾‘å®ä¾‹å·¥å…·:', instanceId);
            
            // è·å–å½“å‰å·¥å…·åˆ—è¡¨
            const currentInstance = allInstances.find(inst => inst.id === instanceId);
            const currentTools = currentInstance?.tools || [];
            
            // æ˜¾ç¤ºå·¥å…·ç¼–è¾‘ç•Œé¢
            const toolsListDiv = document.getElementById('instanceToolsList');
            toolsListDiv.innerHTML = `
                <div class="mb-3">
                    <label class="form-label">é€‰æ‹©å·¥å…·:</label>
                    <div id="toolsCheckboxes">
                        ${renderToolsCheckboxes(currentTools)}
                    </div>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-success btn-sm" onclick="saveInstanceTools('${instanceId}')">
                        <i class="fas fa-save"></i> ä¿å­˜
                    </button>
                    <button class="btn btn-secondary btn-sm" onclick="cancelEditTools('${instanceId}')">
                        <i class="fas fa-times"></i> å–æ¶ˆ
                    </button>
                </div>
            `;
            
            // æ˜¾ç¤ºä¿å­˜æŒ‰é’®
            document.getElementById('saveInstanceDetailsBtn').style.display = 'inline-block';
        }
        
        function renderToolsCheckboxes(currentTools) {
            const availableTools = [
                'git', 'docker', 'kubectl', 'terraform', 'ansible', 
                'jenkins', 'prometheus', 'grafana', 'elasticsearch', 'redis'
            ];
            
            return availableTools.map(tool => `
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="tool_${tool}" value="${tool}" 
                           ${currentTools.includes(tool) ? 'checked' : ''}>
                    <label class="form-check-label" for="tool_${tool}">${tool}</label>
                </div>
            `).join('');
        }
        
        function saveInstanceTools(instanceId) {
            console.log('ğŸ’¾ ä¿å­˜å®ä¾‹å·¥å…·é…ç½®:', instanceId);
            
            // è·å–é€‰ä¸­çš„å·¥å…·
            const selectedTools = [];
            document.querySelectorAll('#toolsCheckboxes input[type="checkbox"]:checked').forEach(checkbox => {
                selectedTools.push(checkbox.value);
            });
            
            // æ¨¡æ‹Ÿä¿å­˜æˆåŠŸ
            setTimeout(() => {
                // æ›´æ–°æ˜¾ç¤º
                const toolsListDiv = document.getElementById('instanceToolsList');
                toolsListDiv.innerHTML = renderToolsList(selectedTools);
                
                // æ›´æ–°æœ¬åœ°ç¼“å­˜
                const instance = allInstances.find(inst => inst.id === instanceId);
                if (instance) {
                    instance.tools = selectedTools;
                }
                
                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                alert('å·¥å…·é…ç½®å·²ä¿å­˜');
                
                // éšè—ä¿å­˜æŒ‰é’®
                document.getElementById('saveInstanceDetailsBtn').style.display = 'none';
            }, 500);
        }
        
        function cancelEditTools(instanceId) {
            const currentInstance = allInstances.find(inst => inst.id === instanceId);
            const currentTools = currentInstance?.tools || [];
            
            // æ¢å¤æ˜¾ç¤º
            const toolsListDiv = document.getElementById('instanceToolsList');
            toolsListDiv.innerHTML = renderToolsList(currentTools);
            
            // éšè—ä¿å­˜æŒ‰é’®
            document.getElementById('saveInstanceDetailsBtn').style.display = 'none';
        }
        
        function saveInstanceDetails() {
            console.log('ğŸ’¾ ä¿å­˜å®ä¾‹è¯¦æƒ…');
            
            // éšè—ä¿å­˜æŒ‰é’®
            document.getElementById('saveInstanceDetailsBtn').style.display = 'none';
            
            alert('ä¿®æ”¹å·²ä¿å­˜');
        }
    </script>
</body>
</html>
