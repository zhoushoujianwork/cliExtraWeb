<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>实例详情功能测试</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h2>实例详情功能测试</h2>
        <p class="text-muted">测试实例详情Modal和工具编辑功能</p>
        
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5>模拟实例列表</h5>
                    </div>
                    <div class="card-body">
                        <!-- 模拟实例1 -->
                        <div class="instance-item mb-2 p-2 border rounded">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>cliextra_test_12345</strong>
                                    <span class="badge bg-success ms-2">Attached</span>
                                    <br><small class="text-muted">ns: default</small>
                                </div>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary" title="监控输出">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-outline-info" onclick="testShowInstanceDetails('cliextra_test_12345')" title="查看实例详情">
                                        <i class="fas fa-info-circle"></i>
                                    </button>
                                    <button class="btn btn-outline-danger" title="清理实例数据">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 模拟实例2 -->
                        <div class="instance-item mb-2 p-2 border rounded">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>cliextra_test_67890</strong>
                                    <span class="badge bg-warning ms-2">Detached</span>
                                    <br><small class="text-muted">ns: frontend</small>
                                </div>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary" title="监控输出">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-outline-info" onclick="testShowInstanceDetails('cliextra_test_67890')" title="查看实例详情">
                                        <i class="fas fa-info-circle"></i>
                                    </button>
                                    <button class="btn btn-outline-danger" title="清理实例数据">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5>功能说明</h5>
                    </div>
                    <div class="card-body">
                        <h6>新功能</h6>
                        <ul class="list-unstyled">
                            <li>✅ 移除了终止按钮</li>
                            <li>✅ 新增实例详情按钮</li>
                            <li>✅ Modal方式显示详情</li>
                            <li>✅ 支持修改tools配置</li>
                        </ul>
                        
                        <h6>按钮说明</h6>
                        <ul class="list-unstyled">
                            <li><i class="fas fa-eye text-primary"></i> 监控输出</li>
                            <li><i class="fas fa-info-circle text-info"></i> 实例详情</li>
                            <li><i class="fas fa-trash text-danger"></i> 清理数据</li>
                        </ul>
                        
                        <h6>测试步骤</h6>
                        <ol class="small">
                            <li>点击实例详情按钮</li>
                            <li>查看实例基本信息</li>
                            <li>点击工具配置的编辑按钮</li>
                            <li>修改工具选择</li>
                            <li>保存修改</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 实例详情模态框 -->
    <div class="modal fade" id="instanceDetailsModal" tabindex="-1" aria-labelledby="instanceDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="instanceDetailsModalLabel">
                        <i class="fas fa-info-circle"></i> 实例详情
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="instanceDetailsContent">
                        <div class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">加载中...</span>
                            </div>
                            <p class="mt-2">正在加载实例详情...</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-primary" id="saveInstanceDetailsBtn" onclick="saveInstanceDetails()" style="display: none;">
                        <i class="fas fa-save"></i> 保存修改
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 模拟实例数据
        const mockInstances = {
            'cliextra_test_12345': {
                id: 'cliextra_test_12345',
                status: 'Attached',
                namespace: 'default',
                role: 'fullstack',
                project_path: '/Users/test/project1',
                created_at: '2024-01-20 10:30:00',
                tools: ['git', 'docker', 'kubectl'],
                stats: {
                    uptime: '2小时30分钟',
                    messages: 45,
                    memory: '256MB',
                    cpu: '15%'
                }
            },
            'cliextra_test_67890': {
                id: 'cliextra_test_67890',
                status: 'Detached',
                namespace: 'frontend',
                role: 'frontend',
                project_path: '/Users/test/project2',
                created_at: '2024-01-20 09:15:00',
                tools: ['git', 'nodejs', 'webpack'],
                stats: {
                    uptime: '0分钟',
                    messages: 23,
                    memory: '0MB',
                    cpu: '0%'
                }
            }
        };
        
        let allInstances = Object.values(mockInstances);
        
        function testShowInstanceDetails(instanceId) {
            console.log('🔍 显示实例详情:', instanceId);
            
            // 显示模态框
            const modal = new bootstrap.Modal(document.getElementById('instanceDetailsModal'));
            modal.show();
            
            // 重置内容为加载状态
            const contentDiv = document.getElementById('instanceDetailsContent');
            contentDiv.innerHTML = `
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">加载中...</span>
                    </div>
                    <p class="mt-2">正在加载实例详情...</p>
                </div>
            `;
            
            // 隐藏保存按钮
            document.getElementById('saveInstanceDetailsBtn').style.display = 'none';
            
            // 模拟API调用延迟
            setTimeout(() => {
                const instance = mockInstances[instanceId];
                if (instance) {
                    renderInstanceDetails(instance);
                } else {
                    showInstanceDetailsError('实例不存在');
                }
            }, 1000);
        }
        
        function renderInstanceDetails(instance) {
            const contentDiv = document.getElementById('instanceDetailsContent');
            
            // 更新模态框标题
            document.getElementById('instanceDetailsModalLabel').innerHTML = `
                <i class="fas fa-info-circle"></i> 实例详情 - ${instance.id}
            `;
            
            // 渲染详情内容
            contentDiv.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fas fa-server"></i> 基本信息</h6>
                            </div>
                            <div class="card-body">
                                <table class="table table-sm table-borderless">
                                    <tr>
                                        <td><strong>实例ID:</strong></td>
                                        <td>${instance.id}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>状态:</strong></td>
                                        <td>
                                            <span class="badge bg-${instance.status === 'Attached' ? 'success' : 'warning'}">
                                                ${instance.status}
                                            </span>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><strong>命名空间:</strong></td>
                                        <td>${instance.namespace || 'default'}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>角色:</strong></td>
                                        <td>${instance.role || '未设置'}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>项目路径:</strong></td>
                                        <td><small class="text-muted">${instance.project_path || '未设置'}</small></td>
                                    </tr>
                                    <tr>
                                        <td><strong>创建时间:</strong></td>
                                        <td><small class="text-muted">${instance.created_at || '未知'}</small></td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card mb-3">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0"><i class="fas fa-tools"></i> 工具配置</h6>
                                <button class="btn btn-sm btn-outline-primary" onclick="editInstanceTools('${instance.id}')">
                                    <i class="fas fa-edit"></i> 编辑
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="instanceToolsList">
                                    ${renderToolsList(instance.tools || [])}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fas fa-chart-line"></i> 运行统计</h6>
                            </div>
                            <div class="card-body">
                                <div class="row text-center">
                                    <div class="col-md-3">
                                        <div class="border rounded p-2">
                                            <div class="h5 mb-0 text-primary">${instance.stats?.uptime || '0'}</div>
                                            <small class="text-muted">运行时长</small>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="border rounded p-2">
                                            <div class="h5 mb-0 text-success">${instance.stats?.messages || '0'}</div>
                                            <small class="text-muted">消息数量</small>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="border rounded p-2">
                                            <div class="h5 mb-0 text-warning">${instance.stats?.memory || '0MB'}</div>
                                            <small class="text-muted">内存使用</small>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="border rounded p-2">
                                            <div class="h5 mb-0 text-info">${instance.stats?.cpu || '0%'}</div>
                                            <small class="text-muted">CPU使用</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function renderToolsList(tools) {
            if (!tools || tools.length === 0) {
                return '<p class="text-muted mb-0">未安装任何工具</p>';
            }
            
            return tools.map(tool => `
                <span class="badge bg-secondary me-1 mb-1">${tool}</span>
            `).join('');
        }
        
        function showInstanceDetailsError(error) {
            const contentDiv = document.getElementById('instanceDetailsContent');
            contentDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>加载失败:</strong> ${error}
                </div>
                <div class="text-center">
                    <button class="btn btn-outline-primary" onclick="location.reload()">
                        <i class="fas fa-refresh"></i> 刷新页面
                    </button>
                </div>
            `;
        }
        
        function editInstanceTools(instanceId) {
            console.log('🔧 编辑实例工具:', instanceId);
            
            // 获取当前工具列表
            const currentInstance = allInstances.find(inst => inst.id === instanceId);
            const currentTools = currentInstance?.tools || [];
            
            // 显示工具编辑界面
            const toolsListDiv = document.getElementById('instanceToolsList');
            toolsListDiv.innerHTML = `
                <div class="mb-3">
                    <label class="form-label">选择工具:</label>
                    <div id="toolsCheckboxes">
                        ${renderToolsCheckboxes(currentTools)}
                    </div>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-success btn-sm" onclick="saveInstanceTools('${instanceId}')">
                        <i class="fas fa-save"></i> 保存
                    </button>
                    <button class="btn btn-secondary btn-sm" onclick="cancelEditTools('${instanceId}')">
                        <i class="fas fa-times"></i> 取消
                    </button>
                </div>
            `;
            
            // 显示保存按钮
            document.getElementById('saveInstanceDetailsBtn').style.display = 'inline-block';
        }
        
        function renderToolsCheckboxes(currentTools) {
            const availableTools = [
                'git', 'docker', 'kubectl', 'terraform', 'ansible', 
                'jenkins', 'prometheus', 'grafana', 'elasticsearch', 'redis'
            ];
            
            return availableTools.map(tool => `
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="tool_${tool}" value="${tool}" 
                           ${currentTools.includes(tool) ? 'checked' : ''}>
                    <label class="form-check-label" for="tool_${tool}">${tool}</label>
                </div>
            `).join('');
        }
        
        function saveInstanceTools(instanceId) {
            console.log('💾 保存实例工具配置:', instanceId);
            
            // 获取选中的工具
            const selectedTools = [];
            document.querySelectorAll('#toolsCheckboxes input[type="checkbox"]:checked').forEach(checkbox => {
                selectedTools.push(checkbox.value);
            });
            
            // 模拟保存成功
            setTimeout(() => {
                // 更新显示
                const toolsListDiv = document.getElementById('instanceToolsList');
                toolsListDiv.innerHTML = renderToolsList(selectedTools);
                
                // 更新本地缓存
                const instance = allInstances.find(inst => inst.id === instanceId);
                if (instance) {
                    instance.tools = selectedTools;
                }
                
                // 显示成功消息
                alert('工具配置已保存');
                
                // 隐藏保存按钮
                document.getElementById('saveInstanceDetailsBtn').style.display = 'none';
            }, 500);
        }
        
        function cancelEditTools(instanceId) {
            const currentInstance = allInstances.find(inst => inst.id === instanceId);
            const currentTools = currentInstance?.tools || [];
            
            // 恢复显示
            const toolsListDiv = document.getElementById('instanceToolsList');
            toolsListDiv.innerHTML = renderToolsList(currentTools);
            
            // 隐藏保存按钮
            document.getElementById('saveInstanceDetailsBtn').style.display = 'none';
        }
        
        function saveInstanceDetails() {
            console.log('💾 保存实例详情');
            
            // 隐藏保存按钮
            document.getElementById('saveInstanceDetailsBtn').style.display = 'none';
            
            alert('修改已保存');
        }
    </script>
</body>
</html>
